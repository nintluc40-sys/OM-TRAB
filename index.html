<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Larvicultura - OMARSA</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           DESIGN TOKENS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        :root {
            --teal:       #006064;
            --teal-mid:   #00838f;
            --teal-light: #00acc1;
            --teal-pale:  #e0f7fa;
            --bg:         #f0f4f8;
            --surface:    #ffffff;
            --border:     #e2e8f0;
            --text:       #1a202c;
            --text-muted: #718096;
            --radius-sm:  8px;
            --radius-md:  12px;
            --radius-lg:  16px;
            --shadow-sm:  0 1px 4px rgba(0,0,0,.07);
            --shadow-md:  0 4px 14px rgba(0,0,0,.10);
            --shadow-lg:  0 8px 28px rgba(0,0,0,.13);
            --chart-h:    280px;   /* unified chart canvas height */
        }

        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #e0f2f7 0%, #b3e5fc 100%);
            min-height: 100vh;
            padding: 16px 18px;
            color: var(--text);
            overflow-x: hidden;
        }

        /* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .header {
            background: linear-gradient(135deg, #006064 0%, #00838f 100%);
            color: white;
            padding: 12px 22px;
            border-radius: 12px;
            box-shadow: 0 4px 14px rgba(0, 96, 100, 0.25);
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 18px;
        }
        .header-left { display:flex; align-items:center; gap:18px; }
        .logo {
            background: white;
            padding: 6px 12px;
            border-radius: 8px;
            display: flex;
            align-items: center;
        }
        .header h1 {
            font-size: 17px;
            font-weight: 700;
            letter-spacing: .4px;
            opacity: .97;
        }

        /* â”€â”€ UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .upload-section {
            margin-bottom: 16px;
        }

        /* â”€â”€ SOURCE SELECTOR TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .source-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 14px;
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1.5px solid var(--border);
            width: fit-content;
            margin: 0 auto 14px;
        }
        .source-tab {
            padding: 10px 22px;
            background: white;
            border: none;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            transition: all .2s;
            display: flex;
            align-items: center;
            gap: 7px;
        }
        .source-tab:not(:last-child) { border-right: 1.5px solid var(--border); }
        .source-tab.active {
            background: linear-gradient(135deg, var(--teal) 0%, var(--teal-mid) 100%);
            color: white;
        }
        .source-tab:hover:not(.active) { background: var(--teal-pale); color: var(--teal); }

        /* â”€â”€ UPLOAD PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .upload-panel, .sheets-panel {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .upload-panel.visible, .sheets-panel.visible { display: flex; }

        .upload-btn {
            background: linear-gradient(135deg, var(--teal) 0%, var(--teal-mid) 100%);
            color: white;
            padding: 11px 30px;
            border: none;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            letter-spacing: .5px;
            box-shadow: 0 4px 14px rgba(0,96,100,.35);
            transition: transform .2s, box-shadow .2s;
        }
        .upload-btn:hover { transform: translateY(-2px); box-shadow: 0 7px 20px rgba(0,96,100,.45); }

        /* â”€â”€ GOOGLE SHEETS PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .sheets-config {
            background: white;
            border-radius: var(--radius-md);
            border: 1.5px solid var(--border);
            padding: 18px 22px;
            box-shadow: var(--shadow-sm);
            width: 100%;
            max-width: 680px;
        }
        .sheets-config-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--teal);
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .sheets-url-row {
            display: flex;
            gap: 8px;
            align-items: stretch;
        }
        .sheets-url-input {
            flex: 1;
            padding: 9px 13px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 13px;
            color: var(--text);
            transition: border-color .2s;
            min-width: 0;
        }
        .sheets-url-input:focus { outline: none; border-color: var(--teal-light); }
        .sheets-connect-btn {
            padding: 9px 20px;
            background: linear-gradient(135deg, #0F9D58, #0b7a44);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
            transition: all .2s;
            box-shadow: 0 3px 10px rgba(15,157,88,.3);
        }
        .sheets-connect-btn:hover { transform: translateY(-1px); box-shadow: 0 5px 14px rgba(15,157,88,.4); }
        .sheets-connect-btn:disabled { background: #cbd5e0; cursor: not-allowed; box-shadow: none; transform: none; }

        .sheets-status {
            margin-top: 12px;
            padding: 9px 13px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 8px;
        }
        .sheets-status.ok    { display:flex; background:#e8f5e9; color:#2e7d32; border:1px solid #a5d6a7; }
        .sheets-status.error { display:flex; background:#ffebee; color:#c62828; border:1px solid #ef9a9a; }
        .sheets-status.loading { display:flex; background:#e3f2fd; color:#1565c0; border:1px solid #90caf9; }

        .sheets-options {
            display: none;
            margin-top: 14px;
            padding-top: 14px;
            border-top: 1px solid var(--border);
            gap: 14px;
            align-items: center;
            flex-wrap: wrap;
        }
        .sheets-options.visible { display: flex; }

        .sheets-refresh-label {
            font-size: 12px;
            color: var(--text-muted);
            white-space: nowrap;
        }
        .sheets-refresh-select {
            padding: 5px 9px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
        }
        .sheets-last-update {
            font-size: 11px;
            color: var(--text-muted);
            margin-left: auto;
        }
        .sheets-manual-refresh {
            padding: 5px 14px;
            border-radius: 14px;
            border: 1.5px solid var(--teal-light);
            background: white;
            color: var(--teal-mid);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all .15s;
        }
        .sheets-manual-refresh:hover { background: var(--teal-pale); }

        .sheets-instructions {
            margin-top: 14px;
            padding: 12px 14px;
            background: #fff8e1;
            border-radius: var(--radius-sm);
            border-left: 3px solid #ffc107;
            font-size: 12px;
            color: #555;
            line-height: 1.7;
        }
        .sheets-instructions strong { color: #333; }
        .live-dot {
            display: inline-block;
            width: 8px; height: 8px;
            border-radius: 50%;
            background: #2e7d32;
            margin-right: 4px;
            animation: livePulse 1.8s ease-in-out infinite;
        }
        @keyframes livePulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50%       { opacity: 0.4; transform: scale(0.8); }
        }

        /* â”€â”€ FILTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .filters-section {
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: 16px 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }
        .filters-container {
            display: flex;
            flex-wrap: wrap;
            gap: 14px;
            align-items: flex-start;
        }
        .filter-group { display:flex; flex-direction:column; gap:5px; }
        .filter-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .7px;
            color: var(--teal-mid);
        }
        .dropdown-container { position:relative; min-width:170px; }
        .dropdown-toggle {
            background: white;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 8px 12px;
            cursor: pointer;
            font-size: 13px;
            transition: border-color .2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .dropdown-toggle:hover { border-color: var(--teal-light); }
        .dropdown-menu {
            display: none;
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            background: white;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-md);
            padding: 8px;
            z-index: 1000;
            min-width: 200px;
            max-height: 280px;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }
        .dropdown-menu.active { display:block; }
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: background .15s;
        }
        .dropdown-item:hover { background: var(--teal-pale); }
        .dropdown-item.all-option {
            border-bottom: 1px solid var(--border);
            margin-bottom: 6px;
            padding-bottom: 8px;
            font-weight: 600;
        }

        /* â”€â”€ VIEW BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .view-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 7px;
        }
        .view-btn {
            padding: 8px 14px;
            border: 1.5px solid var(--border);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            background: white;
            color: var(--text-muted);
            transition: all .2s;
            white-space: nowrap;
        }
        .view-btn:hover { border-color: var(--teal-light); color: var(--teal-mid); }
        .view-btn.active {
            background: var(--teal-mid);
            color: white;
            border-color: var(--teal-mid);
            box-shadow: 0 3px 10px rgba(0,131,143,.3);
        }

        /* â”€â”€ METRIC FILTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .metric-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 7px;
            margin-top: 10px;
        }
        .metric-btn {
            padding: 6px 13px;
            border: 1.5px solid var(--border);
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            background: white;
            color: var(--text-muted);
            transition: all .2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .metric-btn:hover { border-color: var(--teal-light); }
        .metric-btn.active            { background:#26a69a; color:white; border-color:#26a69a; }
        .metric-btn.active.mortalidad { background:#ef5350; border-color:#ef5350; }
        .metric-btn.active.oxigeno    { background:#00acc1; border-color:#00acc1; }
        .metric-btn.active.temperatura{ background:#ff9800; border-color:#ff9800; }
        .metric-btn.active.poblacion  { background:#5c6bc0; border-color:#5c6bc0; }

        /* â”€â”€ SECTION TITLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .section-title {
            font-size: 15px;
            font-weight: 700;
            margin: 20px 0 14px 0;
            padding: 12px 18px;
            background: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--teal-light);
            color: var(--teal);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* â”€â”€ SUMMARY CARDS (4 big) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        .card {
            padding: 22px 18px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            color: white;
            text-align: center;
            transition: transform .25s, box-shadow .25s;
        }
        .card:hover { transform:translateY(-4px); box-shadow:var(--shadow-lg); }
        .card-supervivencia { background:linear-gradient(135deg,#26a69a,#00897b); }
        .card-mortalidad    { background:linear-gradient(135deg,#ef5350,#e53935); }
        .card-poblacion     { background:linear-gradient(135deg,#5c6bc0,#3949ab); }
        .card-estadio       { background:linear-gradient(135deg,#ff9800,#f57c00); }
        .card-title    { font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:1px; margin-bottom:10px; opacity:.9; }
        .card-value    { font-size:38px; font-weight:800; margin-bottom:4px; line-height:1; }
        .card-subtitle { font-size:11px; opacity:.85; }
        .card-info .card-title    { color:rgba(255,255,255,.95); }
        .card-info .card-subtitle { color:rgba(255,255,255,.8); }

        /* â”€â”€ COMPACT CARDS (6 small) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .card-compact {
            padding: 14px 12px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            text-align: center;
            transition: transform .2s;
            color: white;
            border: 1px solid rgba(255,255,255,.15);
        }
        .card-compact:hover { transform:translateY(-3px); box-shadow:var(--shadow-md); }
        .card-compact-title { font-size:10px; font-weight:700; margin-bottom:8px; opacity:.92; text-transform:uppercase; letter-spacing:.5px; }
        .card-compact-value { font-size:24px; font-weight:800; margin-bottom:3px; line-height:1.1; }
        .card-compact-unit  { font-size:10px; opacity:.8; }
        .card-oxigeno   { background:linear-gradient(135deg,#0093E9,#80D0C7); }
        .card-temperatura { background:linear-gradient(135deg,#f7971e,#e65100); }
        .card-nutricion { background:linear-gradient(135deg,#11998e,#38ef7d); }
        .card-calidad   { background:linear-gradient(135deg,#FC466B,#3F5EFB); }
        .card-info      { color:white; }

        /* â”€â”€ CORRIDA CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .corrida-section-title {
            color: var(--teal);
            font-size: 14px;
            font-weight: 700;
            margin: 18px 0 12px;
            padding: 9px 14px;
            background: var(--teal-pale);
            border-radius: var(--radius-sm);
            border-left: 4px solid var(--teal-light);
        }
        .corrida-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 18px;
        }
        .corrida-card {
            background: white;
            padding: 13px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            border-top: 3px solid var(--teal-light);
            transition: transform .2s;
        }
        .corrida-card:hover { transform:translateY(-2px); box-shadow:var(--shadow-md); }
        .corrida-card-header { font-size:10px; color:var(--text-muted); font-weight:700; margin-bottom:6px; text-transform:uppercase; letter-spacing:.5px; }
        .corrida-card-value  { font-size:22px; font-weight:800; color:var(--teal-mid); margin-bottom:4px; }
        .corrida-card-label  { font-size:10px; color:var(--text-muted); }

        /* â”€â”€ MORFOLOGÃA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .morfologia-section { margin-bottom:24px; }
        .morfologia-title {
            color: var(--teal);
            font-size: 15px;
            font-weight: 700;
            margin: 20px 0 12px;
            padding: 12px 16px;
            background: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            border-left: 4px solid #ff9800;
        }
        .morfologia-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        .morfologia-card {
            background: white;
            padding: 14px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            height: 320px;
            border: 1px solid var(--border);
        }
        .morfologia-card-title {
            color: var(--teal);
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 2px solid #b3e5fc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .morfologia-reference  { font-size:10px; color:#666; font-weight:normal; }
        .morfologia-acceptable { color:#26a69a; }
        .morfologia-warning    { color:#ff9800; }
        .morfologia-danger     { color:#ef5350; }

        /* â”€â”€ CHARTS CORE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
            margin-bottom: 12px;
            width: 100%;
            box-sizing: border-box;
        }
        /* 3-column variant for FBR */
        .charts-container-2col { grid-template-columns: repeat(2, 1fr); }

        .chart-wrapper {
            background: white;
            padding: 14px 16px 16px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            min-width: 0;
            overflow: hidden;
        }
        /* Canvas container: fixed height, canvas fills it natively â€” same as morfologÃ­a */
        .chart-canvas-wrap {
            position: relative;
            height: var(--chart-h);
            width: 100%;
            flex-shrink: 0;
        }
        .chart-canvas-wrap canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100% !important;
            height: 100% !important;
            display: block;
        }

        /* â”€â”€ DATE RANGE FILTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .date-filter-bar {
            background: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            padding: 10px 16px;
            margin-bottom: 14px;
            display: none;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .date-filter-bar.visible { display: flex; }
        .date-filter-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .6px;
            color: var(--teal-mid);
            white-space: nowrap;
        }
        .date-filter-inputs {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .date-input {
            padding: 5px 9px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 12px;
            color: var(--text);
            background: white;
            cursor: pointer;
            transition: border-color .2s;
        }
        .date-input:focus { outline: none; border-color: var(--teal-light); }
        .date-sep { font-size: 12px; color: var(--text-muted); }
        .date-preset-btns {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        .date-preset {
            padding: 4px 10px;
            border-radius: 14px;
            border: 1.5px solid var(--border);
            background: white;
            color: var(--text-muted);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all .15s;
        }
        .date-preset:hover { border-color: var(--teal-light); color: var(--teal-mid); }
        .date-preset.active-preset {
            background: var(--teal-mid);
            color: white;
            border-color: var(--teal-mid);
        }
        .date-clear-btn {
            padding: 4px 10px;
            border-radius: 14px;
            border: 1.5px solid #ef5350;
            background: white;
            color: #ef5350;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all .15s;
        }
        .date-clear-btn:hover { background: #ef5350; color: white; }

        .chart-title {
            font-size: 12px;
            font-weight: 700;
            color: var(--teal);
            margin-bottom: 8px;
            padding-bottom: 7px;
            border-bottom: 2px solid var(--teal-pale);
            text-transform: uppercase;
            letter-spacing: .4px;
        }

        /* â”€â”€ MODULE PAGINATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .module-page       { display:none; }
        .module-page.active{ display:block; }

        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 14px;
            margin: 20px 0;
            padding: 14px 20px;
            background: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
        }
        .page-btn {
            background: linear-gradient(135deg, var(--teal-light), #0097a7);
            color: white;
            padding: 8px 22px;
            border: none;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all .2s;
            box-shadow: 0 3px 8px rgba(0,172,193,.3);
        }
        .page-btn:hover:not(:disabled) { transform:translateY(-2px); box-shadow:0 5px 14px rgba(0,172,193,.4); }
        .page-btn:disabled { background:#cbd5e0; cursor:not-allowed; box-shadow:none; }
        .page-info { color:var(--teal); font-weight:700; font-size:14px; }

        /* â”€â”€ LOADING / NO-DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .loading { display:none; text-align:center; padding:20px; color:var(--teal-mid); font-size:16px; }
        .loading.active { display:block; }
        .no-data { text-align:center; color:var(--text-muted); padding:40px; font-size:14px; }

        /* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media (max-width:1100px) {
            .charts-container { grid-template-columns:1fr; }
        }
        @media (max-width:768px) {
            body { padding:10px; }
            .header { flex-direction:column; text-align:center; gap:12px; }
            .header-left { flex-direction:column; }
            .header h1 { font-size:15px; }
            .filters-container { flex-direction:column; }
            .view-buttons { flex-direction:column; width:100%; }
            .view-btn { width:100%; }
            .morfologia-card { height:280px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <div class="logo">
                <img src="https://www.omarsa.com.ec/wp-content/themes/omarsa_site/images/logo-omarsa.png" alt="OMARSA Logo" style="height:36px;width:auto;">
            </div>
            <h1>Registro de Sanidad y Calidad</h1>
        </div>
    </div>

    <div class="upload-section">
        <!-- Source selector tabs -->
        <div class="source-tabs">
            <button class="source-tab active" id="tabExcel" onclick="switchSource('excel')">
                ğŸ“ Cargar Excel
            </button>
            <button class="source-tab" id="tabSheets" onclick="switchSource('sheets')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 3c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm7 13H5v-.23c0-.62.28-1.2.76-1.58C7.47 15.82 9.64 15 12 15s4.53.82 6.24 2.19c.48.38.76.97.76 1.58V19z"/></svg>
                Google Sheets (Tiempo real)
            </button>
        </div>

        <!-- Panel: Excel upload -->
        <div class="upload-panel visible" id="panelExcel">
            <input type="file" id="fileInput" accept=".xlsx, .xls" style="display:none;" />
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                ğŸ“Š CARGAR ARCHIVO EXCEL
            </button>
            <div style="font-size:11px;color:var(--text-muted);">Admite .xlsx y .xls Â· Todas las hojas se cargan automÃ¡ticamente</div>
        </div>

        <!-- Panel: Google Sheets -->
        <div class="sheets-panel" id="panelSheets">
            <div class="sheets-config">
                <div class="sheets-config-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="#0F9D58"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
                    Conectar Google Sheets â€” actualizaciÃ³n automÃ¡tica
                </div>

                <!-- Steps guide â€” always visible, collapses after connect -->
                <div id="sheetsGuide" style="margin-bottom:14px;">
                  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">

                    <div style="flex:1;min-width:200px;background:#e8f5e9;border:1.5px solid #a5d6a7;border-radius:8px;padding:10px 13px;">
                      <div style="font-weight:700;color:#2e7d32;font-size:12px;margin-bottom:5px;">â‘  Publicar Google Sheets como CSV</div>
                      <div style="font-size:11px;color:#444;line-height:1.65;">En tu Sheets â†’ <strong>Archivo â†’ Compartir â†’ Publicar en la web</strong> â†’ "Todo el documento" â†’ ".csv" â†’ <strong>Publicar</strong> â†’ copia el enlace largo que aparece.</div>
                    </div>

                    <div style="flex:1;min-width:200px;background:#e3f2fd;border:1.5px solid #90caf9;border-radius:8px;padding:10px 13px;">
                      <div style="font-weight:700;color:#1565c0;font-size:12px;margin-bottom:5px;">â‘¡ Alojar el dashboard en GitHub Pages</div>
                      <div style="font-size:11px;color:#444;line-height:1.65;">Si abres el HTML como archivo local el navegador bloquea Google Sheets. Sube el HTML a <strong>github.com</strong> (gratis) â†’ activa Pages â†’ obtienes una URL <em>https://</em> desde la que todo funciona.</div>
                    </div>

                    <div style="flex:1;min-width:200px;background:#fce4ec;border:1.5px solid #f48fb1;border-radius:8px;padding:10px 13px;">
                      <div style="font-weight:700;color:#880e4f;font-size:12px;margin-bottom:5px;">â‘¢ Pega el enlace y conecta</div>
                      <div style="font-size:11px;color:#444;line-height:1.65;">Desde tu URL de GitHub Pages, pega el enlace <em>.../pub?output=csv</em> abajo y haz clic en <strong>Conectar</strong>. Se actualiza cada minuto automÃ¡ticamente.</div>
                    </div>
                  </div>
                  <div id="fileWarnInline" style="display:none;background:#fff3e0;border:1.5px solid #ffb74d;border-radius:8px;padding:9px 13px;font-size:11px;color:#e65100;margin-bottom:10px;">
                    âš ï¸ <strong>EstÃ¡s abriendo el dashboard como archivo local.</strong> El navegador bloquearÃ¡ Google Sheets. Primero sube el HTML a GitHub Pages (paso â‘¡) y Ã¡brelo desde esa URL.
                    <button onclick="document.getElementById('sheetsUrlRow').style.display='flex';document.getElementById('fileWarnInline').style.display='none';" style="margin-left:8px;padding:3px 10px;background:#e65100;color:white;border:none;border-radius:5px;cursor:pointer;font-size:10px;">Intentar igual</button>
                  </div>
                </div>

                <div id="sheetsUrlRow" class="sheets-url-row">
                    <input type="text" id="sheetsUrlInput" class="sheets-url-input"
                        placeholder="Pega aquÃ­ el enlace publicado de Google Sheets (.csv)..."
                        oninput="onSheetsUrlChange()" />
                    <button class="sheets-connect-btn" id="sheetsConnectBtn" onclick="connectSheets()">
                        Conectar
                    </button>
                </div>

                <div class="sheets-status" id="sheetsStatus"></div>

                <div class="sheets-options" id="sheetsOptions">
                    <span class="sheets-refresh-label">ğŸ”„ Actualizar cada:</span>
                    <select class="sheets-refresh-select" id="sheetsRefreshInterval" onchange="updateRefreshInterval()">
                        <option value="30">30 segundos</option>
                        <option value="60" selected>1 minuto</option>
                        <option value="120">2 minutos</option>
                        <option value="300">5 minutos</option>
                        <option value="0">Manual</option>
                    </select>
                    <button class="sheets-manual-refresh" onclick="fetchSheetsData(true)">â†» Actualizar ahora</button>
                    <span class="sheets-last-update" id="sheetsLastUpdate"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- â”€â”€ GLOBAL DATE RANGE FILTER BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="date-filter-bar" id="dateFilterBar">
        <span class="date-filter-label">ğŸ“… Fechas</span>
        <div class="date-filter-inputs">
            <input type="date" id="dateFrom" class="date-input" onchange="applyDateFilter()" title="Fecha desde">
            <span class="date-sep">â€”</span>
            <input type="date" id="dateTo" class="date-input" onchange="applyDateFilter()" title="Fecha hasta">
        </div>
        <div class="date-preset-btns">
            <button class="date-preset" onclick="setDatePreset('7d')"   id="preset7d">7 dÃ­as</button>
            <button class="date-preset" onclick="setDatePreset('1m')"   id="preset1m">1 mes</button>
            <button class="date-preset" onclick="setDatePreset('3m')"   id="preset3m">3 meses</button>
            <button class="date-preset" onclick="setDatePreset('6m')"   id="preset6m">6 meses</button>
            <button class="date-preset" onclick="setDatePreset('1y')"   id="preset1y">1 aÃ±o</button>
            <button class="date-preset active-preset" onclick="setDatePreset('all')" id="presetAll">Todo</button>
        </div>
        <button class="date-clear-btn" onclick="setDatePreset('all')">âœ• Limpiar</button>
    </div>

    <div class="filters-section" id="filtersSection">
        <div class="filters-container">
            <div class="filter-group">
                <label class="filter-label">Corrida</label>
                <div class="dropdown-container">
                    <div class="dropdown-toggle" id="corridaToggle" onclick="toggleDropdown('corrida')">
                        <span id="corridaSelected">Todas las Corridas</span>
                    </div>
                    <div class="dropdown-menu" id="corridaDropdown">
                        <div class="dropdown-item all-option">
                            <input type="checkbox" id="corrida_todas" checked onchange="toggleAllCorridas(this)">
                            <label for="corrida_todas">Todas las Corridas</label>
                        </div>
                        <div id="corridaOptions"></div>
                    </div>
                </div>
            </div>
            <div class="filter-group">
                <label class="filter-label">MÃ³dulo</label>
                <div class="dropdown-container">
                    <div class="dropdown-toggle" id="moduloToggle" onclick="toggleDropdown('modulo')">
                        <span id="moduloSelected">Todos los MÃ³dulos</span>
                    </div>
                    <div class="dropdown-menu" id="moduloDropdown">
                        <div class="dropdown-item all-option">
                            <input type="checkbox" id="modulo_todos" checked onchange="toggleAllModulos(this)">
                            <label for="modulo_todos">Todos los MÃ³dulos</label>
                        </div>
                        <div id="moduloOptions"></div>
                    </div>
                </div>
            </div>
            <div class="filter-group" id="filterCorridaAlgas" style="display: none;">
                <label class="filter-label">ğŸŒ¿ Corrida Algas</label>
                <div class="dropdown-container">
                    <div class="dropdown-toggle" id="corridaAlgasToggle" onclick="toggleDropdown('corridaAlgas')">
                        <span id="corridaAlgasSelected">Todas</span>
                    </div>
                    <div class="dropdown-menu" id="corridaAlgasDropdown">
                        <div class="dropdown-item all-option">
                            <input type="checkbox" id="corridaAlgas_todas" checked onchange="toggleAllCorridasAlgas(this)">
                            <label for="corridaAlgas_todas">Todas las Corridas</label>
                        </div>
                        <div id="corridaAlgasOptions"></div>
                    </div>
                </div>
            </div>
            <div class="filter-group" id="filterModuloAlgas" style="display: none;">
                <label class="filter-label">ğŸŒ¿ MÃ³dulo Algas</label>
                <div class="dropdown-container">
                    <div class="dropdown-toggle" id="moduloAlgasToggle" onclick="toggleDropdown('moduloAlgas')">
                        <span id="moduloAlgasSelected">Todos</span>
                    </div>
                    <div class="dropdown-menu" id="moduloAlgasDropdown">
                        <div class="dropdown-item all-option">
                            <input type="checkbox" id="moduloAlgas_todos" checked onchange="toggleAllModulosAlgas(this)">
                            <label for="moduloAlgas_todos">Todos los MÃ³dulos</label>
                        </div>
                        <div id="moduloAlgasOptions"></div>
                    </div>
                </div>
            </div>
            <div class="filter-group" id="filterSalaMad" style="display: none; min-width: 160px;">
                <label class="filter-label">Sala</label>
                <div class="dropdown-container">
                    <div class="dropdown-toggle" id="salaMadToggle" onclick="toggleDropdown('salaMad')">
                        <span id="salaMadSelected">Todas las Salas</span>
                    </div>
                    <div class="dropdown-menu" id="salaMadDropdown">
                        <div class="dropdown-item all-option">
                            <input type="checkbox" id="salaMad_todas" checked onchange="toggleAllSalasMad(this)">
                            <label for="salaMad_todas">Todas las Salas</label>
                        </div>
                        <div id="salaMadOptions"></div>
                    </div>
                </div>
            </div>
            <div class="filter-group" id="filterFaseMad" style="display: none; min-width: 155px;">
                <label class="filter-label">ğŸ“‹ Fase</label>
                <div style="display:flex;flex-direction:column;gap:7px;margin-top:5px;">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;color:#333;background:#f3e5f5;padding:5px 8px;border-radius:6px;border:1px solid #ce93d8;">
                        <input type="checkbox" id="faseMad_cuarentena" checked onchange="updateFaseMad()" style="accent-color:#9C27B0;width:15px;height:15px;">
                        ğŸ”’ Cuarentena (DÃ­as 1-16)
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;color:#333;background:#ede7f6;padding:5px 8px;border-radius:6px;border:1px solid #b39ddb;">
                        <input type="checkbox" id="faseMad_produccion" checked onchange="updateFaseMad()" style="accent-color:#673AB7;width:15px;height:15px;">
                        ProducciÃ³n (DÃ­as 17+)
                    </label>
                </div>
            </div>
            <div class="filter-group" id="filterTipoCultivo" style="display: none; min-width: 160px;">
                <label class="filter-label">&#x1F9EB; Tipo de Cultivo</label>
                <div style="display: flex; flex-direction: column; gap: 7px; margin-top: 5px;">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;color:#333;background:#f0fdf4;padding:5px 8px;border-radius:6px;border:1px solid #86efac;">
                        <input type="checkbox" id="tipoCultivo_masivos" checked onchange="updateTipoCultivo()" style="accent-color:#4CAF50;width:15px;height:15px;">
                        &#x1F331; Masivos
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;color:#333;background:#f0fdfa;padding:5px 8px;border-radius:6px;border:1px solid #5eead4;">
                        <input type="checkbox" id="tipoCultivo_premasivos" checked onchange="updateTipoCultivo()" style="accent-color:#26A69A;width:15px;height:15px;">
                        &#x1F52C; Pre-masivos
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;color:#333;background:#fff7ed;padding:5px 8px;border-radius:6px;border:1px solid #fdba74;">
                        <input type="checkbox" id="tipoCultivo_fundas" checked onchange="updateTipoCultivo()" style="accent-color:#FF9800;width:15px;height:15px;">
                        &#x1F6CD; Fundas
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;color:#333;background:#fdf4ff;padding:5px 8px;border-radius:6px;border:1px solid #e879f9;">
                        <input type="checkbox" id="tipoCultivo_fotobioreactor" checked onchange="updateTipoCultivo()" style="accent-color:#9C27B0;width:15px;height:15px;">
                        &#x2697; Fotobioreactor
                    </label>
                </div>
            </div>
            <div class="filter-group" style="flex: 2;">
                <label class="filter-label">NavegaciÃ³n</label>
                <div class="view-buttons">
                    <button class="view-btn active" onclick="changeView('detallado')" id="btnDetallado">
                        ğŸ“Š ParÃ¡metros Principales
                    </button>
                    <button class="view-btn" onclick="changeView('corridas')" id="btnCorridas">
                        ğŸ“ˆ Vista por Corridas
                    </button>
                    <button class="view-btn" onclick="changeView('morfologia')" id="btnMorfologia">
                        ğŸ”¬ MorfologÃ­a General
                    </button>
                    <button class="view-btn" onclick="changeView('algas')" id="btnAlgas" style="background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%); color: white; border: none;">
                        ğŸŒ¿ Laboratorio de Algas
                    </button>
                    <button class="view-btn" onclick="changeView('maduracion')" id="btnMaduracion" style="background: linear-gradient(135deg, #7B1FA2 0%, #4A148C 100%); color: white; border: none;">
                        ğŸ¦ Ãrea de MaduraciÃ³n
                    </button>
                    <button class="view-btn" onclick="downloadPDF()" id="btnPDF" style="background: #ff9800; color: white; border-color: #ff9800;" title="Descargar reporte en PDF de alta calidad">
                        ğŸ“¥ Descargar PDF
                    </button>
                    <button class="view-btn" onclick="generarVersionCompartible()" id="btnCompartir" style="background: #2196F3; color: white; border-color: #2196F3;" title="Generar archivo HTML con datos embebidos para compartir (solo visualizaciÃ³n)">
                        ğŸ”— Generar VersiÃ³n Compartible
                    </button>
                </div>
                <div class="metric-filters">
                    <button class="metric-btn active" onclick="toggleMetric('supervivencia')" id="metricSupervivencia">
                        âœ… Supervivencia
                    </button>
                    <button class="metric-btn active mortalidad" onclick="toggleMetric('mortalidad')" id="metricMortalidad">
                        âŒ Mortalidad
                    </button>
                    <button class="metric-btn active oxigeno" onclick="toggleMetric('oxigeno')" id="metricOxigeno">
                        ğŸ’§ OxÃ­geno
                    </button>
                    <button class="metric-btn active temperatura" onclick="toggleMetric('temperatura')" id="metricTemperatura">
                        ğŸŒ¡ï¸ Temperatura
                    </button>
                    <button class="metric-btn active poblacion" onclick="toggleMetric('poblacion')" id="metricPoblacion">
                        ğŸ¦ PoblaciÃ³n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="loading" id="loading">Procesando datos...</div>

    <div id="dashboardContent"></div>

    <script>
        let globalData = [];
        let currentView = 'detallado';
        let allCharts = [];
        let currentModulePage = 0;
        let totalModulePages = 0;
        let modulosArray = [];
        let selectedCorridas = [];
        let selectedModulos = [];
        let selectedCorridasAlgas = [];
        let selectedModulosAlgas = [];
        let selectedTiposCultivo = ['Masivo', 'Pre-masivo', 'Funda', 'Fotobioreactor'];
        let selectedSalasMad = [];
        let selectedFasesMad = ['Cuarentena', 'Produccion'];
        let activeMetrics = {
            supervivencia: true,
            mortalidad: true,
            oxigeno: true,
            temperatura: true,
            poblacion: true
        };

        // â”€â”€ GLOBAL DATE FILTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let dateFilterFrom = null;  // Date object or null
        let dateFilterTo   = null;  // Date object or null
        let dateActivePreset = 'all';

        function _parseAnyDate(raw) {
            if (!raw) return null;
            var s = String(raw).trim();
            if (!s) return null;
            var d;
            if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)) {
                var p = s.split('/');
                d = new Date(p[2]+'-'+p[1].padStart(2,'0')+'-'+p[0].padStart(2,'0'));
            } else if (/^\d{4}-\d{2}-\d{2}/.test(s)) {
                d = new Date(s.substring(0,10));
            } else if (typeof raw === 'number') {
                // Excel serial date
                d = new Date((raw - 25569) * 86400 * 1000);
            } else {
                d = new Date(s);
            }
            return isNaN(d.getTime()) ? null : d;
        }

        function _filterByDateRange(rows) {
            if (!dateFilterFrom && !dateFilterTo) return rows;
            return rows.filter(function(row) {
                var d = _parseAnyDate(row.Fecha || row.fecha);
                if (!d) return true;  // keep rows with unparseable dates
                if (dateFilterFrom && d < dateFilterFrom) return false;
                if (dateFilterTo   && d > dateFilterTo)   return false;
                return true;
            });
        }

        function _toInputDate(d) {
            if (!d) return '';
            var y = d.getFullYear();
            var m = String(d.getMonth()+1).padStart(2,'0');
            var dd = String(d.getDate()).padStart(2,'0');
            return y+'-'+m+'-'+dd;
        }

        function setDatePreset(preset) {
            dateActivePreset = preset;
            var today = new Date();
            today.setHours(23,59,59,999);
            var from = null;
            if (preset === '7d')  { from = new Date(); from.setDate(today.getDate()-7); from.setHours(0,0,0,0); }
            if (preset === '1m')  { from = new Date(); from.setMonth(today.getMonth()-1); from.setHours(0,0,0,0); }
            if (preset === '3m')  { from = new Date(); from.setMonth(today.getMonth()-3); from.setHours(0,0,0,0); }
            if (preset === '6m')  { from = new Date(); from.setMonth(today.getMonth()-6); from.setHours(0,0,0,0); }
            if (preset === '1y')  { from = new Date(); from.setFullYear(today.getFullYear()-1); from.setHours(0,0,0,0); }
            if (preset === 'all') { from = null; today = null; }
            dateFilterFrom = from;
            dateFilterTo   = today;
            // Update inputs
            var inFrom = document.getElementById('dateFrom');
            var inTo   = document.getElementById('dateTo');
            if (inFrom) inFrom.value = from ? _toInputDate(from) : '';
            if (inTo)   inTo.value   = today ? _toInputDate(today) : '';
            // Update preset button styles
            ['7d','1m','3m','6m','1y','all'].forEach(function(p) {
                var btn = document.getElementById('preset'+p.charAt(0).toUpperCase()+p.slice(1));
                if (btn) {
                    btn.classList.toggle('active-preset', p === preset);
                }
            });
            applyFilters();
        }

        function applyDateFilter() {
            var inFrom = document.getElementById('dateFrom');
            var inTo   = document.getElementById('dateTo');
            var fv = inFrom ? inFrom.value : '';
            var tv = inTo   ? inTo.value   : '';
            dateFilterFrom = fv ? new Date(fv+'T00:00:00') : null;
            dateFilterTo   = tv ? new Date(tv+'T23:59:59') : null;
            // Deactivate all presets since user manually set dates
            dateActivePreset = 'custom';
            ['7d','1m','3m','6m','1y','all'].forEach(function(p) {
                var btn = document.getElementById('preset'+p.charAt(0).toUpperCase()+p.slice(1));
                if (btn) btn.classList.remove('active-preset');
            });
            applyFilters();
        }

        function showDateFilterBar(visible) {
            var bar = document.getElementById('dateFilterBar');
            if (bar) bar.classList.toggle('visible', visible);
        }

        // â”€â”€ CHART.JS GLOBAL RESOLUTION SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Use device pixel ratio for crisp rendering on retina/HiDPI screens
        if (typeof Chart !== 'undefined') {
            Chart.defaults.devicePixelRatio = window.devicePixelRatio || 2;
            Chart.defaults.font.family = "'Segoe UI', system-ui, -apple-system, sans-serif";
            Chart.defaults.font.size = 12;
            Chart.defaults.color = '#555';
            Chart.defaults.elements.line.borderWidth = 2.5;
            Chart.defaults.elements.point.radius = 2;
            Chart.defaults.plugins.legend.labels.font = { size: 11 };
        }

        const colors = {
            supervivencia: 'rgba(38, 166, 154, 0.8)',
            mortalidad: 'rgba(239, 83, 80, 0.8)',
            od: 'rgba(0, 172, 193, 0.8)',
            temperatura: 'rgba(255, 152, 0, 0.8)',
            poblacion: 'rgba(92, 107, 192, 0.8)',
            border: {
                supervivencia: 'rgba(38, 166, 154, 1)',
                mortalidad: 'rgba(239, 83, 80, 1)',
                od: 'rgba(0, 172, 193, 1)',
                temperatura: 'rgba(255, 152, 0, 1)',
                poblacion: 'rgba(92, 107, 192, 1)'
            }
        };

        function toggleMetric(metric) {
            activeMetrics[metric] = !activeMetrics[metric];
            const btn = document.getElementById('metric' + metric.charAt(0).toUpperCase() + metric.slice(1));
            
            if (activeMetrics[metric]) {
                btn.classList.add('active');
                if (metric === 'mortalidad') btn.classList.add('mortalidad');
                if (metric === 'oxigeno') btn.classList.add('oxigeno');
                if (metric === 'temperatura') btn.classList.add('temperatura');
                if (metric === 'poblacion') btn.classList.add('poblacion');
            } else {
                btn.classList.remove('active');
            }
            
            applyFilters();
        }

        // Cerrar dropdowns al hacer clic fuera
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.dropdown-container')) {
                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    menu.classList.remove('active');
                });
            }
        });

        function toggleDropdown(type) {
            event.stopPropagation();
            const dropdown = document.getElementById(type + 'Dropdown');
            const isActive = dropdown.classList.contains('active');
            
            // Cerrar todos los dropdowns
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                menu.classList.remove('active');
            });
            
            // Abrir/cerrar el actual
            if (!isActive) {
                dropdown.classList.add('active');
            }
        }

        function toggleAllCorridas(checkbox) {
            const checkboxes = document.querySelectorAll('#corridaOptions input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            updateSelectedCorridas();
        }

        function toggleAllModulos(checkbox) {
            const checkboxes = document.querySelectorAll('#moduloOptions input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            updateSelectedModulos();
        }

        function updateSelectedCorridas() {
            const allCheckbox = document.getElementById('corrida_todas');
            const checkboxes = document.querySelectorAll('#corridaOptions input[type="checkbox"]');
            const checkedBoxes = Array.from(checkboxes).filter(cb => cb.checked);
            
            if (checkedBoxes.length === 0) {
                allCheckbox.checked = true;
                checkboxes.forEach(cb => cb.checked = true);
            } else if (checkedBoxes.length === checkboxes.length) {
                allCheckbox.checked = true;
            } else {
                allCheckbox.checked = false;
            }

            selectedCorridas = checkedBoxes.map(cb => cb.value);
            
            const display = allCheckbox.checked ? 'Todas las Corridas' : 
                           selectedCorridas.length === 1 ? selectedCorridas[0] :
                           `${selectedCorridas.length} corridas`;
            document.getElementById('corridaSelected').textContent = display;
            
            applyFilters();
        }

        function updateSelectedModulos() {
            const allCheckbox = document.getElementById('modulo_todos');
            const checkboxes = document.querySelectorAll('#moduloOptions input[type="checkbox"]');
            const checkedBoxes = Array.from(checkboxes).filter(cb => cb.checked);
            
            if (checkedBoxes.length === 0) {
                allCheckbox.checked = true;
                checkboxes.forEach(cb => cb.checked = true);
            } else if (checkedBoxes.length === checkboxes.length) {
                allCheckbox.checked = true;
            } else {
                allCheckbox.checked = false;
            }

            selectedModulos = checkedBoxes.map(cb => cb.value);
            
            const display = allCheckbox.checked ? 'Todos los MÃ³dulos' : 
                           selectedModulos.length === 1 ? selectedModulos[0] :
                           `${selectedModulos.length} mÃ³dulos`;
            document.getElementById('moduloSelected').textContent = display;
            
            applyFilters();
        }

        function toggleAllCorridasAlgas(checkbox) {
            const checkboxes = document.querySelectorAll('#corridaAlgasOptions input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            updateSelectedCorridasAlgas();
        }

        function updateSelectedCorridasAlgas() {
            const allCheckbox = document.getElementById('corridaAlgas_todas');
            const checkboxes = document.querySelectorAll('#corridaAlgasOptions input[type="checkbox"]');
            const checkedBoxes = Array.from(checkboxes).filter(cb => cb.checked);
            
            if (checkedBoxes.length === 0) {
                allCheckbox.checked = true;
                checkboxes.forEach(cb => cb.checked = true);
            } else if (checkedBoxes.length === checkboxes.length) {
                allCheckbox.checked = true;
            } else {
                allCheckbox.checked = false;
            }

            selectedCorridasAlgas = checkedBoxes.map(cb => cb.value);
            
            const display = allCheckbox.checked ? 'Todas' : 
                           selectedCorridasAlgas.length === 1 ? selectedCorridasAlgas[0] :
                           `${selectedCorridasAlgas.length} corridas`;
            document.getElementById('corridaAlgasSelected').textContent = display;
            
            applyFilters();
        }

        function toggleAllModulosAlgas(checkbox) {
            const checkboxes = document.querySelectorAll('#moduloAlgasOptions input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            updateSelectedModulosAlgas();
        }

        function updateSelectedModulosAlgas() {
            const allCheckbox = document.getElementById('moduloAlgas_todos');
            const checkboxes = document.querySelectorAll('#moduloAlgasOptions input[type="checkbox"]');
            const checkedBoxes = Array.from(checkboxes).filter(cb => cb.checked);
            
            if (checkedBoxes.length === 0) {
                allCheckbox.checked = true;
                checkboxes.forEach(cb => cb.checked = true);
            } else if (checkedBoxes.length === checkboxes.length) {
                allCheckbox.checked = true;
            } else {
                allCheckbox.checked = false;
            }

            selectedModulosAlgas = checkedBoxes.map(cb => cb.value);
            
            const display = allCheckbox.checked ? 'Todos' : 
                           selectedModulosAlgas.length === 1 ? selectedModulosAlgas[0] :
                           `${selectedModulosAlgas.length} mÃ³dulos`;
            document.getElementById('moduloAlgasSelected').textContent = display;
            
            applyFilters();
        }

        function nextPage() {
            if (currentModulePage < totalModulePages - 1) {
                currentModulePage++;
                updatePageDisplay();
            }
        }

        function prevPage() {
            if (currentModulePage > 0) {
                currentModulePage--;
                updatePageDisplay();
            }
        }

        function updatePageDisplay() {
            // Ocultar todas las pÃ¡ginas
            document.querySelectorAll('.module-page').forEach(page => {
                page.classList.remove('active');
            });

            // Mostrar pÃ¡gina actual
            const currentPage = document.getElementById(`module-page-${currentModulePage}`);
            if (currentPage) {
                currentPage.classList.add('active');
                
                // Destruir grÃ¡ficos anteriores antes de crear nuevos
                destroyAllCharts();
                
                // Crear grÃ¡ficos de la pÃ¡gina actual
                if (currentModulePage < modulosArray.length) {
                    const item = modulosArray[currentModulePage];
                    const itemName = item.name;
                    const itemData = item.data;
                    
                    // PequeÃ±o delay para asegurar que el DOM estÃ¡ listo
                    setTimeout(() => {
                        if (currentView === 'corridas') {
                            createCorridaCharts(itemName, itemData);
                        } else {
                            createModuloCharts(itemName, itemData);
                        }
                    }, 100);
                }
            }

            // Actualizar botones
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (prevBtn) prevBtn.disabled = currentModulePage === 0;
            if (nextBtn) nextBtn.disabled = currentModulePage === totalModulePages - 1;
            
            // Actualizar info de pÃ¡gina
            const pageInfo = document.getElementById('pageInfo');
            if (pageInfo && modulosArray[currentModulePage]) {
                const currentName = modulosArray[currentModulePage].name;
                const prefix = currentView === 'corridas' ? 'Corrida' : '';
                pageInfo.textContent = `${prefix} ${currentName} (${currentModulePage + 1}/${totalModulePages})`;
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GOOGLE SHEETS INTEGRATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let sheetsConnected   = false;
        let sheetsFetchUrl    = '';          // final CSV fetch URL
        let sheetsRawUrl      = '';          // original user URL
        let sheetsSheetNames  = [];          // detected sheet/tab names
        let sheetsRefreshTimer = null;
        let sheetsRefreshSecs  = 60;
        let sheetsDataStore    = {};         // sheetName â†’ rows[]

        // â”€â”€ Tab switcher â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function switchSource(src) {
            document.getElementById('tabExcel').classList.toggle('active',  src==='excel');
            document.getElementById('tabSheets').classList.toggle('active', src==='sheets');
            document.getElementById('panelExcel').classList.toggle('visible',  src==='excel');
            document.getElementById('panelSheets').classList.toggle('visible', src==='sheets');
        }

        function onSheetsUrlChange() {
            const btn = document.getElementById('sheetsConnectBtn');
            const val = document.getElementById('sheetsUrlInput').value.trim();
            btn.disabled = val.length < 20;
            setStatus('', '');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GOOGLE SHEETS ENGINE v3 â€” works from file:// via CORS proxy
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // Detect if opened as local file
        const IS_FILE_PROTOCOL = location.protocol === 'file:';

        // Show inline warning if file://
        document.addEventListener('DOMContentLoaded', function() {
            if (IS_FILE_PROTOCOL) {
                const inlineWarn = document.getElementById('fileWarnInline');
                const row        = document.getElementById('sheetsUrlRow');
                if (inlineWarn) inlineWarn.style.display = 'block';
                if (row)        row.style.display        = 'none';
            }
        });

        function setStatus(type, msg) {
            const el = document.getElementById('sheetsStatus');
            el.className = 'sheets-status' + (type ? ' ' + type : '');
            el.innerHTML = msg;
        }

        function onSheetsUrlChange() {
            const btn = document.getElementById('sheetsConnectBtn');
            const val = document.getElementById('sheetsUrlInput').value.trim();
            btn.disabled = val.length < 20;
            setStatus('', '');
        }

        // â”€â”€ Extract IDs from any Google Sheets URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function parseSheetsIds(raw) {
            raw = raw.trim();
            const pubM = raw.match(/\/d\/e\/([a-zA-Z0-9_-]+)/);
            if (pubM) return { type: 'pub', pubId: pubM[1], raw };
            const realM = raw.match(/\/spreadsheets\/d\/([a-zA-Z0-9_-]+)/);
            if (realM) return { type: 'real', realId: realM[1], raw };
            return null;
        }

        // â”€â”€ Build CSV URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // For gid=0: use base URL without &gid= (more compatible)
        // For gid>0: append &gid=N
        function buildPubCsvUrl(ids, gid) {
            gid = gid || 0;
            let base;
            if (ids.type === 'pub') {
                base = 'https://docs.google.com/spreadsheets/d/e/' + ids.pubId + '/pub?output=csv';
            } else {
                base = 'https://docs.google.com/spreadsheets/d/' + ids.realId + '/pub?output=csv';
            }
            return gid === 0 ? base : base + '&gid=' + gid;
        }

        // â”€â”€ Simple direct fetch â€” works from https:// (GitHub Pages) â”€
        async function fetchCSVRobust(url) {
            const r = await fetch(url, { cache: 'no-store' });
            if (!r.ok) throw new Error('HTTP ' + r.status);
            const text = await r.text();
            // Google returns an HTML error page if not published
            if (text.trim().startsWith('<!DOCTYPE') || text.trim().startsWith('<html')) {
                throw new Error(
                    'La hoja no estÃ¡ publicada correctamente. ' +
                    'Ve a Archivo â†’ Compartir â†’ Publicar en la web â†’ Todo el documento â†’ .csv â†’ Publicar.'
                );
            }
            return text;
        }

        // â”€â”€ Main connect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function connectSheets() {
            const raw = document.getElementById('sheetsUrlInput').value.trim();
            if (!raw) return;
            sheetsRawUrl    = raw;
            sheetsDataStore  = {};
            sheetsSheetNames = [];
            setStatus('loading', 'â³ Conectando...');
            document.getElementById('sheetsConnectBtn').disabled = true;
            document.getElementById('sheetsOptions').classList.remove('visible');

            const ids = parseSheetsIds(raw);
            if (!ids) {
                setStatus('error', 'âŒ Enlace no reconocido. Usa el enlace de "Publicar en la web" o el de Compartir.');
                document.getElementById('sheetsConnectBtn').disabled = false;
                return;
            }

            try {
                // Always start by fetching gid=0 of the published URL
                const baseUrl  = buildPubCsvUrl(ids, 0);
                setStatus('loading', 'â³ Descargando datos (gid=0)...');
                const firstCSV = await fetchCSVRobust(baseUrl);

                if (!firstCSV || firstCSV.trim().length < 5 || firstCSV.includes('<!DOCTYPE')) {
                    throw new Error('La hoja no estÃ¡ publicada. Ve a Archivo â†’ Compartir â†’ Publicar en la web â†’ Todo el documento â†’ .csv â†’ Publicar.');
                }

                const firstRows = parseCSV(firstCSV);
                const firstName = detectSheetName(firstRows, 0);
                sheetsDataStore[firstName]  = { gid: 0, rows: firstRows, ids };
                sheetsSheetNames.push(firstName);

                // Probe gids 1..9 for additional sheets
                // Non-200 or HTML response = sheet doesn't exist at that gid, stop
                for (let gid = 1; gid <= 9; gid++) {
                    try {
                        const r = await fetch(buildPubCsvUrl(ids, gid), { cache: 'no-store' });
                        if (!r.ok) break;  // 400/404 = no more sheets
                        const txt = await r.text();
                        if (!txt || txt.trim().length < 10) break;
                        if (txt.trim().startsWith('<!DOCTYPE') || txt.trim().startsWith('<html')) break;
                        const rows = parseCSV(txt);
                        if (rows.length < 1) break;
                        const name = detectSheetName(rows, gid);
                        if (!sheetsSheetNames.includes(name)) {
                            sheetsDataStore[name] = { gid, rows, ids };
                            sheetsSheetNames.push(name);
                        }
                    } catch(e) { break; }
                }

                onSheetsConnected();

            } catch(err) {
                setStatus('error', 'âŒ ' + err.message);
                document.getElementById('sheetsConnectBtn').disabled = false;
            }
        }

        function onSheetsConnected() {
            sheetsConnected = true;
            // Collapse the setup guide after successful connection
            const guide = document.getElementById('sheetsGuide');
            if (guide) guide.style.display = 'none';
            const tabCount  = sheetsSheetNames.length;
            setStatus('ok',
                '<span class="live-dot"></span> Conectado Â· ' +
                tabCount + ' hoja' + (tabCount > 1 ? 's' : '') +
                ' Â· ' + sheetsSheetNames.join(' Â· ')
            );
            document.getElementById('sheetsOptions').classList.add('visible');
            document.getElementById('sheetsConnectBtn').disabled = false;
            document.getElementById('sheetsConnectBtn').textContent = 'Reconectar';
            processAndDisplaySheetsData();
            startSheetsAutoRefresh();
        }

        // â”€â”€ Auto refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function startSheetsAutoRefresh() {
            clearSheetsTimer();
            sheetsRefreshSecs = parseInt(document.getElementById('sheetsRefreshInterval').value);
            if (sheetsRefreshSecs > 0) {
                sheetsRefreshTimer = setInterval(() => fetchSheetsData(false), sheetsRefreshSecs * 1000);
            }
        }

        function clearSheetsTimer() {
            if (sheetsRefreshTimer) { clearInterval(sheetsRefreshTimer); sheetsRefreshTimer = null; }
        }

        function updateRefreshInterval() {
            if (sheetsConnected) startSheetsAutoRefresh();
        }

        async function fetchSheetsData(manual = false) {
            if (!sheetsConnected) return;
            if (manual) setStatus('loading', 'â³ Actualizando...');
            try {
                for (const name of sheetsSheetNames) {
                    const tab = sheetsDataStore[name];
                    if (!tab) continue;
                    const txt = await fetchCSVRobust(buildPubCsvUrl(tab.ids, tab.gid));
                    tab.rows = parseCSV(txt);
                }
                processAndDisplaySheetsData();
                const ts = new Date().toLocaleTimeString('es-EC', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
                document.getElementById('sheetsLastUpdate').textContent = 'â± ' + ts;
                if (manual) setStatus('ok', '<span class="live-dot"></span> Actualizado Â· ' + sheetsSheetNames.join(' Â· '));
            } catch(err) {
                if (manual) setStatus('error', 'âŒ ' + err.message);
            }
        }

        // â”€â”€ Auto-detect sheet name from columns â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function detectSheetName(rows, gid) {
            if (!rows || !rows.length) return 'Hoja' + (gid + 1);
            const keys = Object.keys(rows[0]).map(k => k.toLowerCase());
            if (keys.some(k => k.includes('cel_ml') || k.includes('tipo_cultivo') || k.includes('corrida_algas'))) return 'Lab_Algas';
            if (keys.some(k => k.includes('sala') && (k.includes('machos') || k.includes('hembras') || k.includes('nauplio')))) return 'Maduracion';
            if (keys.some(k => k.includes('intestino') || k.includes('deformidad'))) return 'Morfologia';
            if (keys.some(k => k.includes('corrida') || k.includes('mÃ³dulo') || k.includes('modulo') || k.includes('tanque') || k.includes('supervivencia'))) return 'Larvicultura';
            if (keys.some(k => k.includes('sala') || k.includes('machos') || k.includes('hembras'))) return 'Maduracion';
            return 'Hoja' + (gid + 1);
        }

        // â”€â”€ CSV parser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function parseCSV(text) {
            const rows = [];
            const lines = text.split(/\r?\n/);
            if (lines.length < 2) return rows;
            const headers = parseCSVLine(lines[0]);
            if (!headers.length) return rows;
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                if (!line.trim()) continue;
                const vals = parseCSVLine(line);
                if (!vals.length) continue;
                const row = {};
                headers.forEach((h, idx) => {
                    row[h.trim()] = vals[idx] !== undefined ? vals[idx] : '';
                });
                rows.push(row);
            }
            return rows;
        }

        function parseCSVLine(line) {
            const result = [];
            let cur = '', inQ = false;
            for (let i = 0; i < line.length; i++) {
                const ch = line[i];
                if (ch === '"') {
                    if (inQ && line[i+1] === '"') { cur += '"'; i++; }
                    else inQ = !inQ;
                } else if (ch === ',' && !inQ) {
                    result.push(cur); cur = '';
                } else { cur += ch; }
            }
            result.push(cur);
            return result;
        }

        function processAndDisplaySheetsData() {
            let allData = [];
            Object.entries(sheetsDataStore).forEach(([tabName, tab]) => {
                tab.rows.forEach(row => {
                    row._SheetOrigin = tabName;
                    allData.push(row);
                });
            });

            if (!allData.length) {
                setStatus('error', 'âŒ No se encontraron datos en las hojas.');
                return;
            }

            globalData = allData;
            initializeFilters();
            applyFilters();
            document.getElementById('filtersSection').classList.add('active');
            showDateFilterBar(true);
            document.getElementById('loading').classList.remove('active');
        }

        // â”€â”€ Esperar a que el DOM estÃ© listo
        document.addEventListener('DOMContentLoaded', function() {
            console.log('âœ… DOM cargado');
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        });

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validar extensiÃ³n
            const validExtensions = ['.xlsx', '.xls'];
            const fileName = file.name.toLowerCase();
            const isValidFile = validExtensions.some(ext => fileName.endsWith(ext));

            if (!isValidFile) {
                console.warn('Archivo no vÃ¡lido');
                event.target.value = '';
                return;
            }

            document.getElementById('loading').classList.add('active');

            const reader = new FileReader();
            
            reader.onerror = function() {
                console.error('Error al leer el archivo');
                document.getElementById('loading').classList.remove('active');
                event.target.value = '';
            };

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    
                    if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                        throw new Error('Sin hojas');
                    }

                    console.log('ğŸ“Š Hojas encontradas:', workbook.SheetNames);

                    // Leer TODAS las hojas del Excel
                    let allData = [];
                    
                    workbook.SheetNames.forEach(sheetName => {
                        const sheet = workbook.Sheets[sheetName];
                        const sheetData = XLSX.utils.sheet_to_json(sheet, { 
                            defval: '',
                            raw: false,
                            dateNF: 'dd/mm/yyyy'
                        });
                        
                        if (sheetData && sheetData.length > 0) {
                            console.log(`âœ… Hoja "${sheetName}": ${sheetData.length} filas`);
                            
                            // Agregar identificador de hoja origen
                            sheetData.forEach(row => {
                                row._SheetOrigin = sheetName;
                            });
                            
                            allData = allData.concat(sheetData);
                        }
                    });
                    
                    if (!allData || allData.length === 0) {
                        throw new Error('Archivo vacÃ­o');
                    }

                    console.log('âœ… Total datos cargados:', allData.length, 'filas de', workbook.SheetNames.length, 'hojas');
                    
                    globalData = allData;
                    // Log sheet summary for debugging
                    const sheetSummary = {};
                    allData.forEach(r => { sheetSummary[r._SheetOrigin] = (sheetSummary[r._SheetOrigin]||0)+1; });
                    console.log('ğŸ“Š Resumen por hoja:', JSON.stringify(sheetSummary));
                    initializeFilters();
                    applyFilters();
                    document.getElementById('filtersSection').classList.add('active');
                    showDateFilterBar(true);
                    document.getElementById('loading').classList.remove('active');
                    
                } catch (error) {
                    console.error('âŒ Error al procesar Excel:', error);
                    document.getElementById('loading').classList.remove('active');
                    event.target.value = '';
                    document.getElementById('dashboardContent').innerHTML = `
                        <div style="background:white;border-radius:12px;padding:30px;margin:20px 0;box-shadow:0 4px 15px rgba(0,0,0,.1);border-left:5px solid #EF5350;">
                            <h3 style="color:#EF5350;margin-bottom:10px;">âš ï¸ Error al cargar el archivo</h3>
                            <p style="color:#555;margin-bottom:8px;">${error.message}</p>
                            <p style="color:#888;font-size:13px;">Verifique que el archivo Excel contiene hojas con los datos correctos y vuelva a intentarlo.</p>
                        </div>`;
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function initializeFilters() {
            if (!globalData || globalData.length === 0) {
                console.error('No hay datos para inicializar filtros');
                return;
            }

            try {
                // Solo filas de larvicultura vÃ¡lidas (con corrida y mÃ³dulo)
                const larviculturaRows = globalData.filter(row => tieneCorridaValida(row) && tieneModuloValido(row));

                const corridas = [...new Set(larviculturaRows.map(row => {
                    const val = row.Corrida || row.corrida || row.CORRIDA;
                    return val ? String(val).trim() : null;
                }).filter(v => v !== null && v !== ''))].sort();

                const modulos = [...new Set(larviculturaRows.map(row => {
                    const val = row.MÃ³dulo || row.Modulo || row.mÃ³dulo || row.modulo || row.MODULO;
                    return val ? String(val).trim() : null;
                }).filter(v => v !== null && v !== ''))].sort();

                if (corridas.length === 0 || modulos.length === 0) {
                    console.warn('âš ï¸ No hay datos de larvicultura (corridas/mÃ³dulos). El dashboard mostrarÃ¡ solo las vistas disponibles (Algas, MaduraciÃ³n).');
                    // Don't throw â€” still initialize other modules (algas, maduracion)
                }

                // Inicializar corridas (solo si hay datos de larvicultura)
                const corridaOptions = document.getElementById('corridaOptions');
                if (corridaOptions && corridas.length > 0) {
                    corridaOptions.innerHTML = '';
                    corridas.forEach(corrida => {
                    const safeId = String(corrida).replace(/[^a-zA-Z0-9]/g, '_');
                    corridaOptions.innerHTML += `
                        <div class="dropdown-item">
                            <input type="checkbox" id="corrida_${safeId}" value="${corrida}" checked onchange="updateSelectedCorridas()">
                            <label for="corrida_${safeId}">${corrida}</label>
                        </div>
                    `;
                });

                } // end corridaOptions
                // Inicializar mÃ³dulos (solo si hay datos de larvicultura)
                const moduloOptions = document.getElementById('moduloOptions');
                if (moduloOptions && modulos.length > 0) {
                    moduloOptions.innerHTML = '';
                    modulos.forEach(modulo => {
                    const safeId = String(modulo).replace(/[^a-zA-Z0-9]/g, '_');
                    moduloOptions.innerHTML += `
                        <div class="dropdown-item">
                            <input type="checkbox" id="modulo_${safeId}" value="${modulo}" checked onchange="updateSelectedModulos()">
                            <label for="modulo_${safeId}">${modulo}</label>
                        </div>
                    `;
                });

                } // end moduloOptions
                // Inicializar selecciones
                if (corridas.length > 0) selectedCorridas = corridas;
                if (modulos.length > 0) selectedModulos = modulos;

                // Inicializar corridas de ALGAS (separadas) - desde la hoja Lab_Algas
                // Algas rows: prefer SheetOrigin match, fallback to unique algas columns
                // Algas rows detection â€” flexible to support various sheet structures
                const _isAlgasRowInit = row => {
                    const origin = String(row._SheetOrigin || '').toLowerCase();
                    if (origin.includes('alga')) return true;
                    const hasCelMl  = row.hasOwnProperty('Cel_ml') || row.hasOwnProperty('cel_ml');
                    const hasCorrAl = row.hasOwnProperty('Corrida_Algas') || row.hasOwnProperty('corrida_algas');
                    const tc = String(row.Tipo_Cultivo || row.tipo_cultivo || '').toLowerCase();
                    const isTipoAlgas = tc.includes('masivo') || tc.includes('pre') || tc.includes('funda') ||
                                        tc.includes('foto') || tc.includes('fbr');
                    const hasLarvCols = row.hasOwnProperty('Corrida') && row.hasOwnProperty('MÃ³dulo') &&
                                        !hasCelMl && !hasCorrAl;
                    if (hasLarvCols) return false;
                    return hasCelMl || hasCorrAl || isTipoAlgas;
                };
                const algasRows = globalData.filter(_isAlgasRowInit);

                const corridasAlgas = [...new Set(algasRows.map(row => {
                    const val = row.Corrida_Algas || row.corrida_algas || row.Corrida || row.corrida;
                    return val ? String(val).trim() : null;
                }).filter(v => v !== null))].sort();

                const corridaAlgasOptions = document.getElementById('corridaAlgasOptions');
                if (corridaAlgasOptions) {
                    corridaAlgasOptions.innerHTML = '';
                    if (corridasAlgas.length > 0) {
                        corridasAlgas.forEach(corrida => {
                            const safeId = String(corrida).replace(/[^a-zA-Z0-9]/g, '_');
                            corridaAlgasOptions.innerHTML += `
                                <div class="dropdown-item">
                                    <input type="checkbox" id="corridaAlgas_${safeId}" value="${corrida}" checked onchange="updateSelectedCorridasAlgas()">
                                    <label for="corridaAlgas_${safeId}">${corrida}</label>
                                </div>
                            `;
                        });
                        selectedCorridasAlgas = corridasAlgas;
                        console.log('Corridas de algas inicializadas:', corridasAlgas.length);
                    }
                }

                // Inicializar mÃ³dulos de ALGAS (separados) - desde la hoja Lab_Algas
                const modulosAlgas = [...new Set(algasRows.map(row => {
                    const val = row.Modulo_Algas || row.modulo_algas || row.MÃ³dulo || row.Modulo || row.mÃ³dulo || row.modulo;
                    return val ? String(val).trim() : null;
                }).filter(v => v !== null))].sort();

                const moduloAlgasOptions = document.getElementById('moduloAlgasOptions');
                if (moduloAlgasOptions) {
                    moduloAlgasOptions.innerHTML = '';
                    if (modulosAlgas.length > 0) {
                        modulosAlgas.forEach(modulo => {
                            const safeId = String(modulo).replace(/[^a-zA-Z0-9]/g, '_');
                            moduloAlgasOptions.innerHTML += `
                                <div class="dropdown-item">
                                    <input type="checkbox" id="moduloAlgas_${safeId}" value="${modulo}" checked onchange="updateSelectedModulosAlgas()">
                                    <label for="moduloAlgas_${safeId}">${modulo}</label>
                                </div>
                            `;
                        });
                        selectedModulosAlgas = modulosAlgas;
                        console.log('MÃ³dulos de algas inicializados:', modulosAlgas.length);
                    }
                }

                console.log('Filtros inicializados:', corridas.length, 'corridas,', modulos.length, 'mÃ³dulos');

                // Pre-init MaduraciÃ³n filters if data available
                const madRows = getMadData();
                if (madRows.length > 0) {
                    initMaduracionFilters(madRows);
                    console.log('MaduraciÃ³n: ' + madRows.length + ' registros encontrados');
                }
            } catch (error) {
                console.error('âš ï¸ Error al inicializar filtros:', error);
                // Don't alert â€” just log. Partial data may still work.
            }
        }

        function applyFilters() {
            let filteredData = globalData;

            // â”€â”€ Apply global date filter first â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            filteredData = _filterByDateRange(filteredData);

            // Vista de algas: filtrar SOLO filas de Lab_Algas y aplicar filtros de corrida/mÃ³dulo
            if (currentView === 'algas') {
                // Filtrar usando la misma lÃ³gica de algasRows (SheetOrigin + campos especÃ­ficos)
                const _isAlgasRow = row => {
                    const origin = String(row._SheetOrigin || '').toLowerCase();
                    if (origin.includes('alga')) return true;
                    // Has algas-specific columns
                    const hasCelMl  = row.hasOwnProperty('Cel_ml') || row.hasOwnProperty('cel_ml');
                    const hasCorrAl = row.hasOwnProperty('Corrida_Algas') || row.hasOwnProperty('corrida_algas');
                    // Tipo_Cultivo matches an algas type
                    const tc = String(row.Tipo_Cultivo || row.tipo_cultivo || '').toLowerCase();
                    const isTipoAlgas = tc.includes('masivo') || tc.includes('pre') || tc.includes('funda') ||
                                        tc.includes('foto') || tc.includes('fbr');
                    // Has larvicultura-specific columns (to exclude larvicultura rows)
                    const hasLarvCols = row.hasOwnProperty('Corrida') && row.hasOwnProperty('MÃ³dulo') &&
                                        !hasCelMl && !hasCorrAl;
                    if (hasLarvCols) return false;
                    return hasCelMl || hasCorrAl || isTipoAlgas;
                };
                let algasFiltered = _filterByDateRange(globalData).filter(_isAlgasRow);
                
                // Aplicar filtro de corridas de algas
                const allAlgasChecked = document.getElementById('corridaAlgas_todas');
                if (allAlgasChecked && !allAlgasChecked.checked && selectedCorridasAlgas.length > 0) {
                    algasFiltered = algasFiltered.filter(row => {
                        const val = String(row.Corrida_Algas || row.corrida_algas || row.Corrida || row.corrida || '');
                        return selectedCorridasAlgas.includes(val);
                    });
                }
                
                // Aplicar filtro de mÃ³dulos de algas
                const allModulosAlgasChecked = document.getElementById('moduloAlgas_todos');
                if (allModulosAlgasChecked && !allModulosAlgasChecked.checked && selectedModulosAlgas.length > 0) {
                    algasFiltered = algasFiltered.filter(row => {
                        const val = String(row.Modulo_Algas || row.modulo_algas || row.MÃ³dulo || row.Modulo || row.mÃ³dulo || row.modulo || '');
                        return selectedModulosAlgas.includes(val);
                    });
                }
                
                renderAlgasView(algasFiltered);
                return;
            }

            // Filtrar filas sin corrida/mÃ³dulo vÃ¡lidos (excluir basura del Excel)
            filteredData = filteredData.filter(row => tieneCorridaValida(row) && tieneModuloValido(row));

            // Filtrar por corridas seleccionadas
            const _corridaEl = document.getElementById('corrida_todas');
            const allCorridasChecked = _corridaEl ? _corridaEl.checked : true;
            if (!allCorridasChecked && selectedCorridas.length > 0) {
                filteredData = filteredData.filter(row => 
                    selectedCorridas.includes(String(row.Corrida || row.corrida).trim())
                );
            }

            // Filtrar por mÃ³dulos seleccionados
            const _moduloEl = document.getElementById('modulo_todos');
            const allModulosChecked = _moduloEl ? _moduloEl.checked : true;
            if (!allModulosChecked && selectedModulos.length > 0) {
                filteredData = filteredData.filter(row => 
                    selectedModulos.includes(String(row.MÃ³dulo || row.Modulo || row.mÃ³dulo || row.modulo).trim())
                );
            }

            if (currentView === 'detallado') {
                renderDetailedView(filteredData);
            } else if (currentView === 'corridas') {
                renderCorridasView(filteredData);
            } else if (currentView === 'morfologia') {
                renderMorfologiaView(filteredData);
            } else if (currentView === 'maduracion') {
                // maduracion uses its own data from globalData
                renderMaduracionView();
            }
        }

        function changeView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            
            // Mostrar/ocultar filtros segÃºn la vista
            const filterCorridaAlgas = document.getElementById('filterCorridaAlgas');
            const filterModuloAlgas = document.getElementById('filterModuloAlgas');
            const filterTipoCultivo = document.getElementById('filterTipoCultivo');
            const filterCorrida = document.querySelector('.filter-group:nth-child(1)');
            const filterModulo = document.querySelector('.filter-group:nth-child(2)');
            
            if (view === 'algas') {
                // Vista de algas: mostrar filtros de algas, ocultar filtros de larvicultura
                if (filterCorridaAlgas) filterCorridaAlgas.style.display = 'block';
                if (filterModuloAlgas) filterModuloAlgas.style.display = 'block';
                if (filterTipoCultivo) filterTipoCultivo.style.display = 'block';
                if (filterCorrida) filterCorrida.style.display = 'none';
                if (filterModulo) filterModulo.style.display = 'none';
                document.getElementById('btnAlgas').classList.add('active');
            } else {
                // Vistas de larvicultura: mostrar filtros de larvicultura, ocultar filtros de algas
                if (filterCorridaAlgas) filterCorridaAlgas.style.display = 'none';
                if (filterModuloAlgas) filterModuloAlgas.style.display = 'none';
                if (filterTipoCultivo) filterTipoCultivo.style.display = 'none';
                if (filterCorrida) filterCorrida.style.display = 'block';
                if (filterModulo) filterModulo.style.display = 'block';
                
                if (view === 'detallado') {
                    document.getElementById('btnDetallado').classList.add('active');
                } else if (view === 'corridas') {
                    document.getElementById('btnCorridas').classList.add('active');
                } else if (view === 'morfologia') {
                    document.getElementById('btnMorfologia').classList.add('active');
                } else if (view === 'maduracion') {
                    document.getElementById('btnMaduracion').classList.add('active');
                }
            }

            // Show/hide Maduracion filters
            const filterSalaMad = document.getElementById('filterSalaMad');
            const filterFaseMad = document.getElementById('filterFaseMad');
            if (view === 'maduracion') {
                if (filterSalaMad) filterSalaMad.style.display = 'block';
                if (filterFaseMad) filterFaseMad.style.display = 'block';
                if (filterCorrida) filterCorrida.style.display = 'none';
                if (filterModulo) filterModulo.style.display = 'none';
                if (filterCorridaAlgas) filterCorridaAlgas.style.display = 'none';
                if (filterModuloAlgas) filterModuloAlgas.style.display = 'none';
                if (filterTipoCultivo) filterTipoCultivo.style.display = 'none';
                document.getElementById('btnMaduracion').classList.add('active');
            } else {
                if (filterSalaMad) filterSalaMad.style.display = 'none';
                if (filterFaseMad) filterFaseMad.style.display = 'none';
            }
            
            // Date filter bar: always visible when data is loaded
            showDateFilterBar(globalData.length > 0);
            applyFilters();
        }

        function tieneModuloValido(row) {
            const m = row.MÃ³dulo || row.Modulo || row.mÃ³dulo || row.modulo;
            return m !== null && m !== undefined && String(m).trim() !== '';
        }

        function tieneCorridaValida(row) {
            const c = row.Corrida || row.corrida;
            return c !== null && c !== undefined && String(c).trim() !== '';
        }

        function renderDetailedView(data) {
            destroyAllCharts();
            currentModulePage = 0;

            // Filtrar filas sin mÃ³dulo ni corrida vÃ¡lidos (filas vacÃ­as/basura del Excel)
            data = data.filter(row => tieneModuloValido(row) && tieneCorridaValida(row));

            // Agrupar por mÃ³dulo
            const modulosData = {};
            data.forEach(row => {
                const modulo = String(row.MÃ³dulo || row.Modulo || row.mÃ³dulo || row.modulo).trim();
                if (!modulosData[modulo]) {
                    modulosData[modulo] = [];
                }
                modulosData[modulo].push(row);
            });

            // Guardar mÃ³dulos para paginaciÃ³n
            modulosArray = Object.keys(modulosData).sort().map(modulo => ({
                name: modulo,
                data: modulosData[modulo]
            }));

            totalModulePages = modulosArray.length;

            let html = '<div class="cards-container">';
            
            // Calcular totales generales
            const totalSuper = calculateAverage(data, ['Supervivencia', 'supervivencia']);
            const totalMort = calculateAverage(data, ['Mortalidad', 'mortalidad']);
            const totalPoblacion = calculateSum(data, ['PoblaciÃ³n', 'poblacion', 'Poblacion']);
            const estadioActual = getMostFrequentStage(data);

            html += `
                <div class="card card-supervivencia">
                    <div class="card-title">Supervivencia Total</div>
                    <div class="card-value">${totalSuper.toFixed(2)}%</div>
                    <div class="card-subtitle">Promedio General</div>
                </div>
                <div class="card card-mortalidad">
                    <div class="card-title">Mortalidad Total</div>
                    <div class="card-value">${totalMort.toFixed(2)}%</div>
                    <div class="card-subtitle">Promedio General</div>
                </div>
                <div class="card card-poblacion">
                    <div class="card-title">PoblaciÃ³n Total</div>
                    <div class="card-value">${formatNumber(totalPoblacion)}</div>
                    <div class="card-subtitle">Larvas Totales</div>
                </div>
                <div class="card card-estadio">
                    <div class="card-title">EstadÃ­o Actual</div>
                    <div class="card-value">${estadioActual}</div>
                    <div class="card-subtitle">MÃ¡s Frecuente</div>
                </div>
            `;
            html += '</div>';

            // NUEVAS TARJETAS DE ANÃLISIS PROFESIONALES - 3x2 Layout
            html += '<div class="summary-cards-compact" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 12px;">';
            
            // Calcular anÃ¡lisis adicionales con validaciÃ³n
            const oxigenoProm = calculateAverage(data, ['OxÃ­geno', 'oxÃ­geno', 'OD', 'od']);
            const tempProm = calculateAverage(data, ['Temperatura', 'temperatura', 'Temp', 'temp']);
            const intestinoLleno = calculateAverage(data, ['Intestino_Lleno', 'IntestinoLleno', 'intestino_lleno']);
            const lipidos = calculateAverage(data, ['LÃ­pidos', 'Lipidos', 'lÃ­pidos', 'lipidos']);
            
            // Calcular nÃºmero total de tanques
            const tanquesUnicos = [...new Set(data.map(row => row.Tanque || row.tanque))].filter(t => t).length;
            
            // Calcular dÃ­as en proceso (fechas Ãºnicas)
            const diasProceso = [...new Set(data.map(row => row.Fecha || row.fecha))].filter(f => f).length;

            // FunciÃ³n auxiliar para formatear valores
            const formatValue = (val) => (val > 0 ? val.toFixed(1) : 'N/A');
            const getStatus = (val, min, max) => {
                if (val === 0 || !val) return '';
                return (val >= min && val <= max) ? 'âœ“' : 'âš ';
            };

            html += `
                <div class="card-compact card-oxigeno">
                    <div class="card-compact-title">OxÃ­geno Disuelto ${getStatus(oxigenoProm, 5, 10)}</div>
                    <div class="card-compact-value">${formatValue(oxigenoProm)}</div>
                    <div class="card-compact-unit">mg/L</div>
                </div>
                <div class="card-compact card-temperatura">
                    <div class="card-compact-title">Temperatura ${getStatus(tempProm, 28, 32)}</div>
                    <div class="card-compact-value">${formatValue(tempProm)}</div>
                    <div class="card-compact-unit">Â°C</div>
                </div>
                <div class="card-compact card-nutricion">
                    <div class="card-compact-title">NutriciÃ³n ${getStatus(intestinoLleno, 85, 100)}</div>
                    <div class="card-compact-value">${formatValue(intestinoLleno)}</div>
                    <div class="card-compact-unit">% Intestino Lleno</div>
                </div>
                <div class="card-compact card-calidad">
                    <div class="card-compact-title">Calidad Larval ${getStatus(lipidos, 90, 100)}</div>
                    <div class="card-compact-value">${formatValue(lipidos)}</div>
                    <div class="card-compact-unit">% LÃ­pidos</div>
                </div>
                <div class="card-compact card-info" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="card-compact-title">Resumen Operativo</div>
                    <div class="card-compact-value" style="font-size: 22px;">${tanquesUnicos > 0 ? tanquesUnicos : 0} TQ â€¢ ${diasProceso > 0 ? diasProceso : 0} D</div>
                    <div class="card-compact-unit">En Monitoreo</div>
                </div>
                <div class="card-compact card-info" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="card-compact-title">Eficiencia Global</div>
                    <div class="card-compact-value" style="font-size: 22px;">${totalSuper > 0 ? ((totalSuper - totalMort) / totalSuper * 100).toFixed(1) : 'N/A'}%</div>
                    <div class="card-compact-unit">Supervivencia Neta</div>
                </div>
            `;
            html += '</div>';

            // Tarjetas por corrida (5 tarjetas por corrida)
            const corridasData = {};
            data.forEach(row => {
                const corrida = String(row.Corrida || row.corrida).trim();
                if (!corridasData[corrida]) {
                    corridasData[corrida] = [];
                }
                corridasData[corrida].push(row);
            });

            if (Object.keys(corridasData).length > 0) {
                html += '<div class="corrida-section-title">ğŸ¦ Resumen por Corrida</div>';
                
                Object.keys(corridasData).sort().forEach(corrida => {
                    const corridaData = corridasData[corrida];
                    
                    // Obtener fechas Ãºnicas para calcular dÃ­as
                    const fechasUnicas = [...new Set(corridaData.map(row => row.Fecha || row.fecha))];
                    const dias = fechasUnicas.length;
                    
                    // Calcular totales
                    const superCorrida = calculateAverage(corridaData, ['Supervivencia', 'supervivencia']);
                    const mortCorrida = calculateAverage(corridaData, ['Mortalidad', 'mortalidad']);
                    const pobCorrida = calculateSum(corridaData, ['PoblaciÃ³n', 'poblacion', 'Poblacion']);
                    const pobPromedioDiaria = Math.round(pobCorrida / dias);
                    const estadioCorrida = getMostFrequentStage(corridaData);
                    
                    html += `<div class="corrida-cards">`;
                    html += `
                        <div class="corrida-card">
                            <div class="corrida-card-header">Corrida ${corrida}</div>
                            <div class="corrida-card-value">${dias} dÃ­as</div>
                            <div class="corrida-card-label">DuraciÃ³n del proceso</div>
                        </div>
                        <div class="corrida-card">
                            <div class="corrida-card-header">Corrida ${corrida}</div>
                            <div class="corrida-card-value">${formatNumber(pobPromedioDiaria)}</div>
                            <div class="corrida-card-label">PoblaciÃ³n promedio/dÃ­a</div>
                        </div>
                        <div class="corrida-card">
                            <div class="corrida-card-header">Corrida ${corrida}</div>
                            <div class="corrida-card-value">${superCorrida.toFixed(1)}%</div>
                            <div class="corrida-card-label">Supervivencia total</div>
                        </div>
                        <div class="corrida-card">
                            <div class="corrida-card-header">Corrida ${corrida}</div>
                            <div class="corrida-card-value">${mortCorrida.toFixed(1)}%</div>
                            <div class="corrida-card-label">Mortalidad total</div>
                        </div>
                        <div class="corrida-card">
                            <div class="corrida-card-header">Corrida ${corrida}</div>
                            <div class="corrida-card-value">${estadioCorrida}</div>
                            <div class="corrida-card-label">EstadÃ­o predominante</div>
                        </div>
                    `;
                    html += '</div>';
                });
            }

            // Crear controles de paginaciÃ³n si hay mÃ¡s de un mÃ³dulo
            if (totalModulePages > 1) {
                html += `
                    <div class="pagination-controls">
                        <button class="page-btn" id="prevBtn" onclick="prevPage()">â—€ Anterior</button>
                        <div class="page-info" id="pageInfo">MÃ³dulo 1 de ${totalModulePages}</div>
                        <button class="page-btn" id="nextBtn" onclick="nextPage()">Siguiente â–¶</button>
                    </div>
                `;
            }

            // Crear estructura de pÃ¡ginas para cada mÃ³dulo
            modulosArray.forEach((moduloObj, index) => {
                const modulo = moduloObj.name;
                const activeClass = index === 0 ? 'active' : '';
                const estadioModulo = getMostFrequentStage(moduloObj.data);
                
                html += `<div class="module-page ${activeClass}" id="module-page-${index}">`;
                html += `<div class="section-title">ğŸ¦ ${modulo} - EstadÃ­o: ${estadioModulo}</div>`;
                html += '<div class="charts-container">';
                
                // GrÃ¡ficos de Supervivencia
                if (activeMetrics.supervivencia) {
                    html += `
                        <div class="chart-wrapper">
                            <div class="chart-title">âœ… Supervivencia por Fecha - ${modulo}</div>
                            <div class="chart-canvas-wrap"><canvas id="super_modulo_${modulo}"></canvas></div>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart-title">âœ… Supervivencia por Tanque</div>
                            <div class="chart-canvas-wrap"><canvas id="super_tanque_${modulo}"></canvas></div>
                        </div>
                    `;
                }
                html += '</div>';
                
                // GrÃ¡ficos de Mortalidad
                if (activeMetrics.mortalidad) {
                    html += '<div class="charts-container">';
                    html += `
                        <div class="chart-wrapper">
                            <div class="chart-title">âŒ Mortalidad por Fecha - ${modulo}</div>
                            <div class="chart-canvas-wrap"><canvas id="mort_modulo_${modulo}"></canvas></div>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart-title">âŒ Mortalidad por Tanque</div>
                            <div class="chart-canvas-wrap"><canvas id="mort_tanque_${modulo}"></canvas></div>
                        </div>
                    `;
                    html += '</div>';
                }
                
                // GrÃ¡ficos de OxÃ­geno
                if (activeMetrics.oxigeno) {
                    html += '<div class="charts-container">';
                    html += `
                        <div class="chart-wrapper">
                            <div class="chart-title">ğŸ’§ OxÃ­geno Disuelto por Fecha - ${modulo}</div>
                            <div class="chart-canvas-wrap"><canvas id="od_modulo_${modulo}"></canvas></div>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart-title">ğŸ’§ OxÃ­geno por Tanque</div>
                            <div class="chart-canvas-wrap"><canvas id="od_tanque_${modulo}"></canvas></div>
                        </div>
                    `;
                    html += '</div>';
                }
                
                // GrÃ¡ficos de Temperatura
                if (activeMetrics.temperatura) {
                    html += '<div class="charts-container">';
                    html += `
                        <div class="chart-wrapper">
                            <div class="chart-title">ğŸŒ¡ï¸ Temperatura por Fecha - ${modulo}</div>
                            <div class="chart-canvas-wrap"><canvas id="temp_modulo_${modulo}"></canvas></div>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart-title">ğŸŒ¡ï¸ Temperatura por Tanque</div>
                            <div class="chart-canvas-wrap"><canvas id="temp_tanque_${modulo}"></canvas></div>
                        </div>
                    `;
                    html += '</div>';
                }

                // GrÃ¡ficos de PoblaciÃ³n
                if (activeMetrics.poblacion) {
                    html += '<div class="charts-container">';
                    html += `
                        <div class="chart-wrapper">
                            <div class="chart-title">ğŸ¦ PoblaciÃ³n por Fecha - ${modulo}</div>
                            <div class="chart-canvas-wrap"><canvas id="pob_modulo_${modulo}"></canvas></div>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart-title">ğŸ¦ PoblaciÃ³n por Tanque</div>
                            <div class="chart-canvas-wrap"><canvas id="pob_tanque_${modulo}"></canvas></div>
                        </div>
                    `;
                    html += '</div>';
                }
                
                html += '</div>'; // Cierre module-page
            });

            document.getElementById('dashboardContent').innerHTML = html;

            // Crear grÃ¡ficos solo para la primera pÃ¡gina
            if (modulosArray.length > 0) {
                const firstModulo = modulosArray[0];
                createModuloCharts(firstModulo.name, firstModulo.data);
            }

            // Actualizar controles de paginaciÃ³n
            if (totalModulePages > 1) {
                updatePageDisplay();
            }
        }

        function getMostFrequentStage(data) {
            const stages = {};
            data.forEach(row => {
                const stage = row.EstadÃ­o || row.Estadio || row.estadÃ­o || row.estadio || row.ESTADIO || row.ESTADÃO;
                if (stage) {
                    const stageStr = String(stage).trim().toUpperCase();
                    stages[stageStr] = (stages[stageStr] || 0) + 1;
                }
            });
            
            if (Object.keys(stages).length === 0) return 'N/A';
            
            // Encontrar el estadÃ­o mÃ¡s frecuente
            let maxCount = 0;
            let mostFrequent = 'N/A';
            for (let stage in stages) {
                if (stages[stage] > maxCount) {
                    maxCount = stages[stage];
                    mostFrequent = stage;
                }
            }
            
            return mostFrequent;
        }

        function calculateSum(data, possibleKeys) {
            let sum = 0;
            data.forEach(row => {
                for (let key of possibleKeys) {
                    if (row[key] !== undefined && row[key] !== null && row[key] !== '') {
                        const value = parseFloat(row[key]);
                        if (!isNaN(value)) {
                            sum += value;
                        }
                        break;
                    }
                }
            });
            return sum;
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toFixed(0);
        }

        function renderCorridasView(data) {
            destroyAllCharts();
            currentModulePage = 0;

            // Filtrar filas sin corrida vÃ¡lida
            data = data.filter(row => tieneCorridaValida(row) && tieneModuloValido(row));

            // Agrupar por corrida
            const corridasData = {};
            data.forEach(row => {
                const corrida = String(row.Corrida || row.corrida).trim();
                if (!corridasData[corrida]) {
                    corridasData[corrida] = [];
                }
                corridasData[corrida].push(row);
            });

            // Guardar corridas para paginaciÃ³n
            modulosArray = Object.keys(corridasData).sort().map(corrida => ({
                name: corrida,
                data: corridasData[corrida]
            }));

            totalModulePages = modulosArray.length;

            let html = '<div class="section-title">ğŸ“Š Vista por Corridas</div>';

            // Crear controles de paginaciÃ³n si hay mÃ¡s de una corrida
            if (totalModulePages > 1) {
                html += `
                    <div class="pagination-controls">
                        <button class="page-btn" id="prevBtn" onclick="prevPage()">â—€ Anterior</button>
                        <div class="page-info" id="pageInfo">Corrida 1 de ${totalModulePages}</div>
                        <button class="page-btn" id="nextBtn" onclick="nextPage()">Siguiente â–¶</button>
                    </div>
                `;
            }

            // Crear pÃ¡ginas para cada corrida
            modulosArray.forEach((corridaObj, index) => {
                const corrida = corridaObj.name;
                const corridaData = corridaObj.data;
                const activeClass = index === 0 ? 'active' : '';

                // Obtener mÃ³dulos de esta corrida
                const modulosEnCorrida = [...new Set(corridaData.map(row => 
                    row.MÃ³dulo || row.Modulo || row.mÃ³dulo || row.modulo
                ))].sort();

                html += `<div class="module-page ${activeClass}" id="module-page-${index}">`;
                html += `<div class="section-title">ğŸƒ Corrida ${corrida}</div>`;
                
                // Tarjetas con totales de la corrida
                const superCorrida = calculateAverage(corridaData, ['Supervivencia', 'supervivencia']);
                const mortCorrida = calculateAverage(corridaData, ['Mortalidad', 'mortalidad']);

                html += '<div class="cards-container">';
                html += `
                    <div class="card card-supervivencia">
                        <div class="card-title">Supervivencia Corrida ${corrida}</div>
                        <div class="card-value">${superCorrida.toFixed(2)}%</div>
                        <div class="card-subtitle">Promedio de la Corrida</div>
                    </div>
                    <div class="card card-mortalidad">
                        <div class="card-title">Mortalidad Corrida ${corrida}</div>
                        <div class="card-value">${mortCorrida.toFixed(2)}%</div>
                        <div class="card-subtitle">Promedio de la Corrida</div>
                    </div>
                `;
                html += '</div>';

                // GrÃ¡ficos por mÃ³dulo en esta corrida
                html += '<div class="charts-container">';
                
                // Supervivencia por mÃ³dulo
                const superPorModulo = modulosEnCorrida.map(modulo => {
                    const moduloData = corridaData.filter(row => 
                        (row.MÃ³dulo || row.Modulo || row.mÃ³dulo || row.modulo) === modulo
                    );
                    return calculateAverage(moduloData, ['Supervivencia', 'supervivencia']);
                });
                html += `
                    <div class="chart-wrapper">
                        <div class="chart-title">âœ… Supervivencia por MÃ³dulo</div>
                        <div class="chart-canvas-wrap"><canvas id="super_corrida_${corrida}"></canvas></div>
                    </div>
                `;
                
                // Mortalidad por mÃ³dulo
                const mortPorModulo = modulosEnCorrida.map(modulo => {
                    const moduloData = corridaData.filter(row => 
                        (row.MÃ³dulo || row.Modulo || row.mÃ³dulo || row.modulo) === modulo
                    );
                    return calculateAverage(moduloData, ['Mortalidad', 'mortalidad']);
                });
                html += `
                    <div class="chart-wrapper">
                        <div class="chart-title">âŒ Mortalidad por MÃ³dulo</div>
                        <div class="chart-canvas-wrap"><canvas id="mort_corrida_${corrida}"></canvas></div>
                    </div>
                `;

                // OxÃ­geno por mÃ³dulo
                const odPorModulo = modulosEnCorrida.map(modulo => {
                    const moduloData = corridaData.filter(row => 
                        (row.MÃ³dulo || row.Modulo || row.mÃ³dulo || row.modulo) === modulo
                    );
                    return calculateAverage(moduloData, ['OxÃ­geno', 'oxÃ­geno', 'OD', 'od']);
                });
                html += `
                    <div class="chart-wrapper">
                        <div class="chart-title">ğŸ’§ OxÃ­geno Disuelto por MÃ³dulo</div>
                        <div class="chart-canvas-wrap"><canvas id="od_corrida_${corrida}"></canvas></div>
                    </div>
                `;

                // Temperatura por mÃ³dulo
                const tempPorModulo = modulosEnCorrida.map(modulo => {
                    const moduloData = corridaData.filter(row => 
                        (row.MÃ³dulo || row.Modulo || row.mÃ³dulo || row.modulo) === modulo
                    );
                    return calculateAverage(moduloData, ['Temperatura', 'temperatura']);
                });
                html += `
                    <div class="chart-wrapper">
                        <div class="chart-title">ğŸŒ¡ï¸ Temperatura por MÃ³dulo</div>
                        <div class="chart-canvas-wrap"><canvas id="temp_corrida_${corrida}"></canvas></div>
                    </div>
                `;

                html += '</div>'; // charts-container

                // Guardar datos para crear grÃ¡ficos despuÃ©s
                if (index === 0) {
                    // Crear grÃ¡ficos para la primera corrida inmediatamente
                    setTimeout(() => {
                        createChartByTank(`super_corrida_${corrida}`, 'bar', modulosEnCorrida, superPorModulo, '% Supervivencia', colors.supervivencia, colors.border.supervivencia, 100, '%', 'MÃ³dulo');
                        createChartByTank(`mort_corrida_${corrida}`, 'bar', modulosEnCorrida, mortPorModulo, '% Mortalidad', colors.mortalidad, colors.border.mortalidad, 100, '%', 'MÃ³dulo');
                        createChartByTank(`od_corrida_${corrida}`, 'bar', modulosEnCorrida, odPorModulo, 'OD (mg/L)', colors.od, colors.border.od, null, 'mg/L', 'MÃ³dulo');
                        createChartByTank(`temp_corrida_${corrida}`, 'bar', modulosEnCorrida, tempPorModulo, 'Temperatura (Â°C)', colors.temperatura, colors.border.temperatura, null, 'Â°C', 'MÃ³dulo');
                    }, 100);
                }

                html += '</div>'; // module-page
            });

            document.getElementById('dashboardContent').innerHTML = html;

            // Actualizar display si hay paginaciÃ³n
            if (totalModulePages > 1) {
                updatePageDisplay();
            }
        }

        function createCorridaCharts(corrida, corridaData) {
            // Obtener mÃ³dulos de esta corrida
            const modulosEnCorrida = [...new Set(corridaData.map(row => 
                row.MÃ³dulo || row.Modulo || row.mÃ³dulo || row.modulo
            ))].filter(m => m).sort();

            if (modulosEnCorrida.length === 0) return;

            // Calcular datos por mÃ³dulo
            const superPorModulo = modulosEnCorrida.map(modulo => {
                const moduloData = corridaData.filter(row => 
                    (row.MÃ³dulo || row.Modulo || row.mÃ³dulo || row.modulo) === modulo
                );
                return calculateAverage(moduloData, ['Supervivencia', 'supervivencia']);
            });

            const mortPorModulo = modulosEnCorrida.map(modulo => {
                const moduloData = corridaData.filter(row => 
                    (row.MÃ³dulo || row.Modulo || row.mÃ³dulo || row.modulo) === modulo
                );
                return calculateAverage(moduloData, ['Mortalidad', 'mortalidad']);
            });

            const odPorModulo = modulosEnCorrida.map(modulo => {
                const moduloData = corridaData.filter(row => 
                    (row.MÃ³dulo || row.Modulo || row.mÃ³dulo || row.modulo) === modulo
                );
                return calculateAverage(moduloData, ['OxÃ­geno', 'oxÃ­geno', 'OD', 'od']);
            });

            const tempPorModulo = modulosEnCorrida.map(modulo => {
                const moduloData = corridaData.filter(row => 
                    (row.MÃ³dulo || row.Modulo || row.mÃ³dulo || row.modulo) === modulo
                );
                return calculateAverage(moduloData, ['Temperatura', 'temperatura']);
            });

            // Crear grÃ¡ficos
            createChartByTank(`super_corrida_${corrida}`, 'bar', modulosEnCorrida, superPorModulo, '% Supervivencia', colors.supervivencia, colors.border.supervivencia, 100, '%', 'MÃ³dulo');
            createChartByTank(`mort_corrida_${corrida}`, 'bar', modulosEnCorrida, mortPorModulo, '% Mortalidad', colors.mortalidad, colors.border.mortalidad, 100, '%', 'MÃ³dulo');
            createChartByTank(`od_corrida_${corrida}`, 'bar', modulosEnCorrida, odPorModulo, 'OD (mg/L)', colors.od, colors.border.od, null, 'mg/L', 'MÃ³dulo');
            createChartByTank(`temp_corrida_${corrida}`, 'bar', modulosEnCorrida, tempPorModulo, 'Temperatura (Â°C)', colors.temperatura, colors.border.temperatura, null, 'Â°C', 'MÃ³dulo');
        }

        function createModuloCharts(modulo, data) {
            // Ordenar datos por fecha
            const sortedData = data.sort((a, b) => {
                const dateA = parseDateString(a.Fecha || a.fecha);
                const dateB = parseDateString(b.Fecha || b.fecha);
                return dateA - dateB;
            });

            // Obtener fechas Ãºnicas ordenadas
            const fechasCompletas = [...new Set(sortedData.map(row => row.Fecha || row.fecha))];
            const tanques = sortTanquesOrdinally([...new Set(sortedData.map(row => row.Tanque || row.tanque))]);

            // Convertir fechas a dÃ­as
            const dias = fechasCompletas.map(fecha => {
                const date = parseDateString(fecha);
                return date.getDate();
            });

            // Obtener mes/aÃ±o para el subtÃ­tulo
            const primeraFecha = parseDateString(fechasCompletas[0]);
            const mesAnio = primeraFecha.toLocaleDateString('es-EC', { month: 'long', year: 'numeric' });

            // === GRÃFICOS POR FECHA (evoluciÃ³n temporal del mÃ³dulo) ===
            
            // Supervivencia por fecha
            if (activeMetrics.supervivencia) {
                const superPorFecha = fechasCompletas.map(fecha => {
                    const dataFecha = sortedData.filter(row => (row.Fecha || row.fecha) === fecha);
                    return calculateAverage(dataFecha, ['Supervivencia', 'supervivencia']);
                });
                createMainChart(`super_modulo_${modulo}`, fechasCompletas, superPorFecha, '% Supervivencia', colors.supervivencia, colors.border.supervivencia, 100, mesAnio, '%');

                // Supervivencia por tanque
                const superTanques = tanques.map(tanque => {
                    const tanqueData = sortedData.filter(row => (row.Tanque || row.tanque) === tanque);
                    return calculateAverage(tanqueData, ['Supervivencia', 'supervivencia']);
                });
                createChartByTank(`super_tanque_${modulo}`, 'bar', tanques, superTanques, '% Supervivencia', colors.supervivencia, colors.border.supervivencia, 100, '%');
            }

            // Mortalidad por fecha
            if (activeMetrics.mortalidad) {
                const mortPorFecha = fechasCompletas.map(fecha => {
                    const dataFecha = sortedData.filter(row => (row.Fecha || row.fecha) === fecha);
                    return calculateAverage(dataFecha, ['Mortalidad', 'mortalidad']);
                });
                createMainChart(`mort_modulo_${modulo}`, fechasCompletas, mortPorFecha, '% Mortalidad', colors.mortalidad, colors.border.mortalidad, 100, mesAnio, '%');

                // Mortalidad por tanque
                const mortTanques = tanques.map(tanque => {
                    const tanqueData = sortedData.filter(row => (row.Tanque || row.tanque) === tanque);
                    return calculateAverage(tanqueData, ['Mortalidad', 'mortalidad']);
                });
                createChartByTank(`mort_tanque_${modulo}`, 'bar', tanques, mortTanques, '% Mortalidad', colors.mortalidad, colors.border.mortalidad, 100, '%');
            }

            // OxÃ­geno por fecha
            if (activeMetrics.oxigeno) {
                const odPorFecha = fechasCompletas.map(fecha => {
                    const dataFecha = sortedData.filter(row => (row.Fecha || row.fecha) === fecha);
                    return calculateAverage(dataFecha, ['OxÃ­geno', 'oxÃ­geno', 'OD', 'od']);
                });
                createMainChart(`od_modulo_${modulo}`, fechasCompletas, odPorFecha, 'OD (mg/L)', colors.od, colors.border.od, null, mesAnio, 'mg/L');

                // OxÃ­geno por tanque
                const odTanques = tanques.map(tanque => {
                    const tanqueData = sortedData.filter(row => (row.Tanque || row.tanque) === tanque);
                    return calculateAverage(tanqueData, ['OxÃ­geno', 'oxÃ­geno', 'OD', 'od']);
                });
                createChartByTank(`od_tanque_${modulo}`, 'bar', tanques, odTanques, 'OD (mg/L)', colors.od, colors.border.od, null, 'mg/L');
            }

            // Temperatura por fecha
            if (activeMetrics.temperatura) {
                const tempPorFecha = fechasCompletas.map(fecha => {
                    const dataFecha = sortedData.filter(row => (row.Fecha || row.fecha) === fecha);
                    return calculateAverage(dataFecha, ['Temperatura', 'temperatura']);
                });
                createMainChart(`temp_modulo_${modulo}`, fechasCompletas, tempPorFecha, 'Temperatura (Â°C)', colors.temperatura, colors.border.temperatura, null, mesAnio, 'Â°C');

                // Temperatura por tanque
                const tempTanques = tanques.map(tanque => {
                    const tanqueData = sortedData.filter(row => (row.Tanque || row.tanque) === tanque);
                    return calculateAverage(tanqueData, ['Temperatura', 'temperatura']);
                });
                createChartByTank(`temp_tanque_${modulo}`, 'bar', tanques, tempTanques, 'Temperatura (Â°C)', colors.temperatura, colors.border.temperatura, null, 'Â°C');
            }

            // PoblaciÃ³n por fecha
            if (activeMetrics.poblacion) {
                const pobPorFecha = fechasCompletas.map(fecha => {
                    const dataFecha = sortedData.filter(row => (row.Fecha || row.fecha) === fecha);
                    return calculateSum(dataFecha, ['PoblaciÃ³n', 'poblacion', 'Poblacion']);
                });
                createMainChart(`pob_modulo_${modulo}`, fechasCompletas, pobPorFecha, 'PoblaciÃ³n (larvas)', colors.poblacion, colors.border.poblacion, null, mesAnio, 'Larvas');

                // PoblaciÃ³n por tanque (suma total del perÃ­odo)
                const pobTanques = tanques.map(tanque => {
                    const tanqueData = sortedData.filter(row => (row.Tanque || row.tanque) === tanque);
                    // Obtener la Ãºltima fecha para cada tanque (poblaciÃ³n final)
                    const ultimaFecha = tanqueData[tanqueData.length - 1];
                    return parseFloat(ultimaFecha?.PoblaciÃ³n || ultimaFecha?.poblacion || ultimaFecha?.Poblacion || 0);
                });
                createChartByTank(`pob_tanque_${modulo}`, 'bar', tanques, pobTanques, 'PoblaciÃ³n Final (larvas)', colors.poblacion, colors.border.poblacion, null, 'Larvas');
            }
        }

        function createMainChart(canvasId, labels, data, label, bgColor, borderColor, maxY = null, mesAnio = '', yAxisTitle = '') {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            // Calcular rango dinÃ¡mico
            let minY = 0;
            let calculatedMaxY = maxY;
            let useBeginAtZero = true;
            
            const validData = data.filter(d => d !== null && d !== undefined && !isNaN(d));
            
            if (validData.length > 0) {
                const dataMin = Math.min(...validData);
                const dataMax = Math.max(...validData);
                const range = dataMax - dataMin;
                
                if (maxY === 100 && range < 40) {
                    const margin = Math.max(range * 0.15, 5);
                    minY = Math.max(0, dataMin - margin);
                    calculatedMaxY = Math.min(100, dataMax + margin);
                    useBeginAtZero = false;
                    
                    minY = Math.floor(minY);
                    calculatedMaxY = Math.ceil(calculatedMaxY);
                } else if (!maxY) {
                    const margin = range * 0.1;
                    minY = Math.max(0, dataMin - margin);
                    calculatedMaxY = dataMax + margin;
                    useBeginAtZero = false;
                    
                    minY = Math.floor(minY * 10) / 10;
                    calculatedMaxY = Math.ceil(calculatedMaxY * 10) / 10;
                }
            }

            const chartConfig = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: bgColor,
                        borderColor: borderColor,
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.75)',
                            padding: 10,
                            titleFont: { size: 12 },
                            bodyFont: { size: 11 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: useBeginAtZero,
                            min: minY,
                            max: calculatedMaxY,
                            title: { display: !!(yAxisTitle), text: yAxisTitle||label, font: { size: 11, weight: '600' }, color: '#444' },
                            ticks: { font: { size: 10 }, maxTicksLimit: 6 },
                            grid: { color: 'rgba(0,0,0,0.07)' }
                        },
                        x: {
                            title: { display: true, text: 'Fecha', font: { size: 11, weight: '600' }, color: '#444' },
                            ticks: { font: { size: 10 }, maxRotation: 45, minRotation: 30, maxTicksLimit: 10 },
                            grid: { display: false }
                        }
                    },
                    layout: { padding: { top: 4, right: 8, bottom: 4, left: 4 } }
                }
            };

            const chart = new Chart(ctx, chartConfig);
            allCharts.push(chart);
        }

        function sortTanquesOrdinally(tanques) {
            return tanques.sort((a, b) => {
                // Extraer el nÃºmero del tanque (TQ1 -> 1, TQ10 -> 10)
                const numA = parseInt(a.replace(/\D/g, '')) || 0;
                const numB = parseInt(b.replace(/\D/g, '')) || 0;
                return numA - numB;
            });
        }

        function parseDateString(dateStr) {
            if (!dateStr) return new Date(0);
            
            // Intentar diferentes formatos de fecha
            // Formato DD/MM/YYYY
            if (dateStr.includes('/')) {
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    return new Date(parts[2], parts[1] - 1, parts[0]);
                }
            }
            
            // Formato YYYY-MM-DD
            if (dateStr.includes('-')) {
                return new Date(dateStr);
            }
            
            // Intentar parseo directo
            return new Date(dateStr);
        }

        function generarVersionCompartible() {
            if (!globalData || globalData.length === 0) {
                alert('âš ï¸ No hay datos cargados\n\nPrimero debe cargar un archivo Excel para poder generar una versiÃ³n compartible.');
                return;
            }

            const btnCompartir = document.getElementById('btnCompartir');
            const originalText = btnCompartir.innerHTML;
            btnCompartir.innerHTML = 'â³ Generando...';
            btnCompartir.disabled = true;

            try {
                // Crear los datos embebidos
                const datosJSON = JSON.stringify(globalData);
                
                // Leer el contenido actual del documento
                const htmlActual = document.documentElement.cloneNode(true);
                
                // Crear el nuevo documento
                const nuevoHTML = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Larvicultura - OMARSA [SOLO VISUALIZACIÃ“N]</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"><\/script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"><\/script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"><\/script>
    <script>
        window.DATOS_EMBEBIDOS = ${datosJSON};
        window.MODO_SOLO_VISUALIZACION = true;
    <\/script>
</head>
<body>
    <div style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; padding: 10px 20px; text-align: center; font-weight: bold; border-bottom: 3px solid #1565C0; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
        ğŸ”’ MODO SOLO VISUALIZACIÃ“N - Los datos estÃ¡n embebidos en este archivo. No se pueden modificar.
    </div>
` + htmlActual.querySelector('body').innerHTML + `
    <script>
    window.addEventListener('DOMContentLoaded', function() {
        console.log('%cğŸ”’ DASHBOARD EN MODO SOLO VISUALIZACIÃ“N', 'color: #2196F3; font-size: 16px; font-weight: bold;');
        console.log('%cLos datos estÃ¡n embebidos en este archivo.', 'color: #1976D2; font-size: 12px;');
        
        if (window.DATOS_EMBEBIDOS && window.DATOS_EMBEBIDOS.length > 0) {
            console.log('âœ… Cargando ' + window.DATOS_EMBEBIDOS.length + ' registros...');
            globalData = window.DATOS_EMBEBIDOS;
            initializeFilters();
            applyFilters();
            console.log('âœ… Dashboard cargado exitosamente');
            
            const uploadSection = document.querySelector('.upload-section');
            if (uploadSection) uploadSection.style.display = 'none';
            
            const btnCarga = document.querySelector('.upload-btn');
            if (btnCarga) {
                btnCarga.innerHTML = 'ğŸ”’ CARGA DESHABILITADA';
                btnCarga.onclick = function() { alert('âš ï¸ Modo Solo VisualizaciÃ³n'); };
                btnCarga.style.opacity = '0.5';
                btnCarga.style.cursor = 'not-allowed';
            }
            
            const fileInput = document.getElementById('fileInput');
            if (fileInput) fileInput.disabled = true;
            
            const btnCompartir = document.getElementById('btnCompartir');
            if (btnCompartir) btnCompartir.style.display = 'none';
        }
    });
    <\/script>
</body>
</html>`;

                // Insertar estilos del head original
                const estilos = htmlActual.querySelector('head').innerHTML;
                const htmlFinal = nuevoHTML.replace('</head>', estilos + '</head>');

                // Crear y descargar archivo
                const blob = new Blob([htmlFinal], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const fecha = new Date().toISOString().split('T')[0];
                a.download = `Dashboard_Larvicultura_Compartible_${fecha}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                setTimeout(() => {
                    alert('âœ… VersiÃ³n Compartible Generada Exitosamente\n\n' +
                          'ğŸ“ El archivo se ha descargado.\n\n' +
                          'ğŸ“¤ Comparta este archivo HTML con otras personas.\n' +
                          'ğŸ‘ï¸ PodrÃ¡n visualizar todos los datos pero NO modificarlos.\n' +
                          'ğŸ”’ Los datos estÃ¡n embebidos de forma segura en el archivo.');
                }, 500);

            } catch (error) {
                console.error('Error al generar versiÃ³n compartible:', error);
                alert('âŒ Error al generar la versiÃ³n compartible\n\nDetalles: ' + error.message);
            } finally {
                btnCompartir.innerHTML = originalText;
                btnCompartir.disabled = false;
            }
        }

        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            
            // Mostrar indicador de carga
            const btnPDF = document.getElementById('btnPDF');
            const originalText = btnPDF.innerHTML;
            btnPDF.innerHTML = 'â³ Generando PDF...';
            btnPDF.disabled = true;

            try {
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 15;
                let yPosition = margin;

                // Encabezado
                pdf.setFillColor(0, 96, 100);
                pdf.rect(0, 0, pageWidth, 35, 'F');
                
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(20);
                pdf.setFont(undefined, 'bold');
                pdf.text('REGISTRO SANIDAD Y CALIDAD DE LARVAS', pageWidth / 2, 15, { align: 'center' });
                
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'normal');
                pdf.text('OMARSA - Dashboard de Larvicultura', pageWidth / 2, 25, { align: 'center' });

                yPosition = 45;

                // InformaciÃ³n general
                pdf.setTextColor(0, 0, 0);
                pdf.setFontSize(10);
                const fecha = new Date().toLocaleDateString('es-EC');
                pdf.text(`Fecha de generaciÃ³n: ${fecha}`, margin, yPosition);
                yPosition += 7;

                // Filtros aplicados
                const corridaText = document.getElementById('corridaSelected').textContent;
                const moduloText = document.getElementById('moduloSelected').textContent;
                pdf.text(`Corridas: ${corridaText}`, margin, yPosition);
                yPosition += 6;
                pdf.text(`MÃ³dulos: ${moduloText}`, margin, yPosition);
                yPosition += 10;

                // Capturar las tarjetas principales
                const cardsContainer = document.querySelector('.cards-container');
                if (cardsContainer) {
                    pdf.setFontSize(14);
                    pdf.setFont(undefined, 'bold');
                    pdf.setTextColor(0, 131, 143);
                    pdf.text('Resumen General', margin, yPosition);
                    yPosition += 8;

                    const canvas = await html2canvas(cardsContainer, { 
                        scale: 3,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#ffffff',
                        logging: false,
                        imageTimeout: 0
                    });
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = pageWidth - (margin * 2);
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;

                    if (yPosition + imgHeight > pageHeight - margin) {
                        pdf.addPage();
                        yPosition = margin;
                    }

                    pdf.addImage(imgData, 'PNG', margin, yPosition, imgWidth, imgHeight);
                    yPosition += imgHeight + 10;
                }

                // Capturar tarjetas de corrida
                const corridaCards = document.querySelector('.corrida-cards');
                if (corridaCards) {
                    if (yPosition > pageHeight - 80) {
                        pdf.addPage();
                        yPosition = margin;
                    }

                    pdf.setFontSize(14);
                    pdf.setFont(undefined, 'bold');
                    pdf.setTextColor(0, 131, 143);
                    pdf.text('Resumen por Corrida', margin, yPosition);
                    yPosition += 8;

                    const canvas = await html2canvas(corridaCards, { 
                        scale: 3,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#ffffff',
                        logging: false,
                        imageTimeout: 0
                    });
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = pageWidth - (margin * 2);
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;

                    if (yPosition + imgHeight > pageHeight - margin) {
                        pdf.addPage();
                        yPosition = margin;
                    }

                    pdf.addImage(imgData, 'PNG', margin, yPosition, imgWidth, imgHeight);
                    yPosition += imgHeight + 10;
                }

                // Capturar grÃ¡ficos principales (solo los visibles)
                const chartsContainers = document.querySelectorAll('.module-page.active .charts-container');
                for (let i = 0; i < chartsContainers.length; i++) {
                    const container = chartsContainers[i];
                    
                    if (yPosition > pageHeight - 100) {
                        pdf.addPage();
                        yPosition = margin;
                    }

                    const canvas = await html2canvas(container, { 
                        scale: 3,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#ffffff',
                        logging: false,
                        imageTimeout: 0
                    });
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = pageWidth - (margin * 2);
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;

                    if (yPosition + imgHeight > pageHeight - margin) {
                        pdf.addPage();
                        yPosition = margin;
                    }

                    pdf.addImage(imgData, 'PNG', margin, yPosition, imgWidth, imgHeight);
                    yPosition += imgHeight + 8;
                }

                // Pie de pÃ¡gina en todas las pÃ¡ginas
                const totalPages = pdf.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    pdf.setPage(i);
                    pdf.setFontSize(8);
                    pdf.setTextColor(128, 128, 128);
                    pdf.text(`PÃ¡gina ${i} de ${totalPages}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                }

                // Guardar PDF
                const fileName = `Reporte_Larvicultura_${fecha.replace(/\//g, '-')}.pdf`;
                pdf.save(fileName);

                console.log('âœ… PDF generado exitosamente');

            } catch (error) {
                console.error('Error al generar PDF:', error);
                alert('Hubo un error al generar el PDF. Por favor, intenta de nuevo.');
            } finally {
                btnPDF.innerHTML = originalText;
                btnPDF.disabled = false;
            }
        }

        function updateTipoCultivo() {
            selectedTiposCultivo = [];
            if (document.getElementById('tipoCultivo_masivos')?.checked) selectedTiposCultivo.push('Masivo');
            if (document.getElementById('tipoCultivo_premasivos')?.checked) selectedTiposCultivo.push('Pre-masivo');
            if (document.getElementById('tipoCultivo_fundas')?.checked) selectedTiposCultivo.push('Funda');
            if (document.getElementById('tipoCultivo_fotobioreactor')?.checked) selectedTiposCultivo.push('Fotobioreactor');
            if (selectedTiposCultivo.length === 0) {
                // Si nada seleccionado, seleccionar todos
                ['masivos','premasivos','fundas','fotobioreactor'].forEach(t => {
                    const cb = document.getElementById('tipoCultivo_' + t);
                    if (cb) cb.checked = true;
                });
                selectedTiposCultivo = ['Masivo', 'Pre-masivo', 'Funda', 'Fotobioreactor'];
            }
            applyFilters();
        }

        function getTipoCultivo(row) {
            const tc = row.Tipo_Cultivo || row.tipo_cultivo || '';
            return String(tc).trim();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  LABORATORIO DE ALGAS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function renderAlgasView(data) {
            destroyAllCharts();
            window._lastAlgasData = data;

            if (!data || data.length === 0) {
                document.getElementById('dashboardContent').innerHTML =
                    '<div style="text-align:center;padding:60px;color:#999;font-size:15px;">' +
                    'No se encontraron datos de Laboratorio de Algas.</div>';
                return;
            }

            // Classify by cultivo type
            function getTipoA(r) {
                var tc = String(r.Tipo_Cultivo || r.tipo_cultivo || '').toLowerCase();
                if (tc.includes('masivo') && !tc.includes('pre')) return 'masivo';
                if (tc.includes('pre'))    return 'premasivo';
                if (tc.includes('funda'))  return 'funda';
                if (tc.includes('foto') || tc.includes('fbr') || tc.includes('reactor')) return 'fbr';
                var sis = String(r.Sistema || r.sistema || '').toUpperCase();
                if (sis.startsWith('MA'))  return 'masivo';
                if (sis.startsWith('PM'))  return 'premasivo';
                if (sis.startsWith('FBR')) return 'fbr';
                return 'funda';
            }

            var masivosData    = data.filter(function(r){ return getTipoA(r)==='masivo'; });
            var premasivosData = data.filter(function(r){ return getTipoA(r)==='premasivo'; });
            var fundasData     = data.filter(function(r){ return getTipoA(r)==='funda'; });
            var fbrData        = data.filter(function(r){ return getTipoA(r)==='fbr'; });

            var showMasivos    = selectedTiposCultivo.includes('Masivo');
            var showPremasivos = selectedTiposCultivo.includes('Pre-masivo');
            var showFundas     = selectedTiposCultivo.includes('Funda');
            var showFbr        = selectedTiposCultivo.includes('Fotobioreactor');

            // Data already date-filtered by global date filter â€” no separate period needed
            var masivosF    = showMasivos    ? masivosData    : [];
            var premasivosF = showPremasivos ? premasivosData : [];
            var fundasF     = showFundas     ? fundasData     : [];
            var fbrF        = showFbr        ? fbrData        : [];
            var periodBtns  = ''; // period buttons removed â€” use global date filter bar above

            // Summary stats
            function celProm(d) { return d.length ? d.reduce(function(s,r){ return s+(parseFloat(r.Cel_ml||r.cel_ml)||0); },0)/d.length : 0; }
            var disponibles = premasivosData.filter(function(r){ return String(r.Disponibilidad||r.disponibilidad||'').toLowerCase().startsWith('s'); }).length;

            // Build HTML using string concatenation (no template literals with emojis)
            var h = '';
            h += '<div class="section-title" style="background:linear-gradient(135deg,#1B5E20,#0D2F10);color:white;padding:14px 15px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;">';
            h += '<span>Laboratorio de Algas</span>';
            h += '</div>';

            // Summary cards
            var nMas  = [...new Set(masivosData.map(function(r){ return r.Sistema||r.sistema; }))].filter(Boolean).length;
            var nPre  = [...new Set(premasivosData.map(function(r){ return r.Sistema||r.sistema; }))].filter(Boolean).length;
            var nFund = [...new Set(fundasData.map(function(r){ return r.Lote||r.lote||r.Sistema||r.sistema; }))].filter(Boolean).length;
            var nFbr  = [...new Set(fbrData.map(function(r){ return r.Modulo_Algas||r.modulo_algas||r.Sistema||r.sistema; }))].filter(Boolean).length;
            var densGlobal = Math.round(celProm(data)).toLocaleString();

            h += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin:18px 0;">';
            h += '<div style="background:linear-gradient(135deg,#66BB6A,#43A047);color:white;padding:12px;border-radius:8px;text-align:center;">';
            h += '<div style="font-size:10px;opacity:.9;margin-bottom:4px;">Masivos</div>';
            h += '<div style="font-size:24px;font-weight:700;">' + nMas + '</div>';
            h += '<div style="font-size:10px;opacity:.8;">' + masivosData.length + ' registros</div></div>';

            h += '<div style="background:linear-gradient(135deg,#26A69A,#00897B);color:white;padding:12px;border-radius:8px;text-align:center;">';
            h += '<div style="font-size:10px;opacity:.9;margin-bottom:4px;">Pre-masivos</div>';
            h += '<div style="font-size:24px;font-weight:700;">' + nPre + '</div>';
            h += '<div style="font-size:10px;opacity:.8;">' + disponibles + ' disponibles</div></div>';

            h += '<div style="background:linear-gradient(135deg,#FF9800,#F57C00);color:white;padding:12px;border-radius:8px;text-align:center;">';
            h += '<div style="font-size:10px;opacity:.9;margin-bottom:4px;">Fundas</div>';
            h += '<div style="font-size:24px;font-weight:700;">' + nFund + '</div>';
            h += '<div style="font-size:10px;opacity:.8;">' + fundasData.length + ' registros</div></div>';

            h += '<div style="background:linear-gradient(135deg,#AB47BC,#8E24AA);color:white;padding:12px;border-radius:8px;text-align:center;">';
            h += '<div style="font-size:10px;opacity:.9;margin-bottom:4px;">Fotobioreactor</div>';
            h += '<div style="font-size:24px;font-weight:700;">' + nFbr + '</div>';
            h += '<div style="font-size:10px;opacity:.8;">' + fbrData.length + ' registros</div></div>';

            h += '<div style="background:linear-gradient(135deg,#5C6BC0,#3949AB);color:white;padding:12px;border-radius:8px;text-align:center;">';
            h += '<div style="font-size:10px;opacity:.9;margin-bottom:4px;">Densidad Global</div>';
            h += '<div style="font-size:20px;font-weight:700;">' + densGlobal + '</div>';
            h += '<div style="font-size:10px;opacity:.8;">Cel/ml promedio</div></div>';
            h += '</div>';

            // Species cards
            var tiposEsp = [
                {label:'Masivos',     color:'#2E7D32', rows:masivosData,    idFn:function(r){return r.Sistema||r.sistema||'?';}},
                {label:'Pre-masivos', color:'#1565C0', rows:premasivosData, idFn:function(r){return r.Sistema||r.sistema||'?';}},
                {label:'Fundas',      color:'#E65100', rows:fundasData,     idFn:function(r){return r.Lote||r.lote||r.Sistema||r.sistema||'?';}},
                {label:'FBR',         color:'#6A1B9A', rows:fbrData,        idFn:function(r){return r.Modulo_Algas||r.modulo_algas||r.Sistema||r.sistema||'?';}}
            ].filter(function(t){ return t.rows.length > 0; });

            if (tiposEsp.length > 0) {
                h += '<div style="margin:16px 0 20px;">';
                h += '<div style="font-weight:700;font-size:13px;color:#444;margin-bottom:10px;">Especies en Cultivo</div>';
                h += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;">';
                tiposEsp.forEach(function(t) {
                    var espMap = {};
                    t.rows.forEach(function(r) {
                        var e = r.Especie||r.especie||'Sin datos';
                        var id = t.idFn(r);
                        if (!espMap[e]) espMap[e] = new Set();
                        espMap[e].add(id);
                    });
                    var total = new Set(t.rows.map(t.idFn)).size;
                    h += '<div style="background:white;border-radius:10px;padding:13px;border-top:3px solid ' + t.color + ';box-shadow:0 2px 6px rgba(0,0,0,.07);">';
                    h += '<div style="font-weight:700;color:' + t.color + ';font-size:12px;margin-bottom:8px;">' + t.label;
                    h += '<span style="float:right;font-weight:400;font-size:10px;color:#999;">' + total + ' uds</span></div>';
                    Object.entries(espMap).sort(function(a,b){return b[1].size-a[1].size;}).forEach(function(entry) {
                        var esp = entry[0], ids = entry[1];
                        var pct = Math.round(ids.size/total*100);
                        h += '<div style="margin-bottom:5px;">';
                        h += '<div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:2px;">';
                        h += '<span style="font-weight:600;">' + esp + '</span>';
                        h += '<span style="color:#888;">' + ids.size + ' (' + pct + '%)</span></div>';
                        h += '<div style="background:#f0f0f0;border-radius:3px;height:4px;">';
                        h += '<div style="background:' + t.color + ';border-radius:3px;height:4px;width:' + pct + '%;"></div></div></div>';
                    });
                    h += '</div>';
                });
                h += '</div></div>';
            }

            // Masivos & Pre-masivos section
            if (showMasivos || showPremasivos) {
                var secLabel = (showMasivos && showPremasivos) ? 'Masivos y Pre-masivos' : (showMasivos ? 'Masivos' : 'Pre-masivos');
                h += '<div class="section-title" style="background:linear-gradient(135deg,#2E7D32,#1B5E20);color:white;padding:12px 15px;margin-top:16px;">Sistemas ' + secLabel + '</div>';
                h += '<div style="text-align:center;margin:12px 0;background:#f5f5f5;padding:10px;border-radius:10px;">';
                h += '<button onclick="toggleTendenciaAlgas(\'densidad\')" id="btnTendDensidad" class="view-btn active" style="background:#4CAF50;color:white;border:none;padding:8px 18px;margin:3px;">Densidad Celular</button>';
                h += '<button onclick="toggleTendenciaAlgas(\'protozoarios\')" id="btnTendProtozoarios" class="view-btn" style="padding:8px 18px;margin:3px;">Protozoarios</button></div>';

                h += '<div id="tendenciaDensidadAlgas" style="display:flex;gap:20px;flex-wrap:wrap;">';
                if (showMasivos)    h += '<div class="chart-wrapper" style="flex:1;min-width:260px;"><div class="chart-title">Densidad - Masivos</div><div id="tend_dens_masivos_pills"></div><div class="chart-canvas-wrap"><canvas id="tend_dens_masivos"></canvas></div></div>';
                if (showPremasivos) h += '<div class="chart-wrapper" style="flex:1;min-width:260px;"><div class="chart-title">Densidad - Pre-masivos</div><div id="tend_dens_premasivos_pills"></div><div class="chart-canvas-wrap"><canvas id="tend_dens_premasivos"></canvas></div></div>';
                h += '</div>';

                h += '<div id="tendenciaProtozoariosAlgas" style="display:none;gap:20px;flex-wrap:wrap;">';
                if (showMasivos)    h += '<div class="chart-wrapper" style="flex:1;min-width:260px;"><div class="chart-title">Protozoarios - Masivos</div><div id="tend_prot_masivos_pills"></div><div class="chart-canvas-wrap"><canvas id="tend_prot_masivos"></canvas></div></div>';
                if (showPremasivos) h += '<div class="chart-wrapper" style="flex:1;min-width:260px;"><div class="chart-title">Protozoarios - Pre-masivos</div><div id="tend_prot_premasivos_pills"></div><div class="chart-canvas-wrap"><canvas id="tend_prot_premasivos"></canvas></div></div>';
                h += '</div>';

                h += '<div class="charts-container" style="margin-top:12px;">';
                if (showMasivos)    h += '<div class="chart-wrapper" ><div class="chart-title">pH - Masivos</div><div id="ph_masivos_pills"></div><div class="chart-canvas-wrap"><canvas id="ph_masivos"></canvas></div></div>';
                if (showMasivos)    h += '<div class="chart-wrapper" ><div class="chart-title">Salinidad - Masivos</div><div id="sal_masivos_pills"></div><div class="chart-canvas-wrap"><canvas id="sal_masivos"></canvas></div></div>';
                if (showPremasivos) h += '<div class="chart-wrapper" ><div class="chart-title">pH - Pre-masivos</div><div id="ph_premasivos_pills"></div><div class="chart-canvas-wrap"><canvas id="ph_premasivos"></canvas></div></div>';
                if (showPremasivos) h += '<div class="chart-wrapper" ><div class="chart-title">Salinidad - Pre-masivos</div><div id="sal_premasivos_pills"></div><div class="chart-canvas-wrap"><canvas id="sal_premasivos"></canvas></div></div>';
                h += '</div>';
            }

            // Fundas section
            if (showFundas) {
                h += '<div class="section-title" style="background:linear-gradient(135deg,#E65100,#BF360C);color:white;padding:12px 15px;margin-top:20px;">Fundas de Produccion</div>';
                if (fundasF.length === 0) {
                    h += '<div style="text-align:center;padding:25px;background:white;border-radius:10px;color:#999;margin:12px 0;">Sin datos de Fundas en el periodo seleccionado.</div>';
                } else {
                    var loteKey = (fundasF[0] && (fundasF[0].Lote || fundasF[0].lote)) ? 'Lote' : 'Sistema';
                    var lotes = [...new Set(fundasF.map(function(r){ return r[loteKey]||r[loteKey.toLowerCase()]||r.Sistema||r.sistema; }))].filter(Boolean).sort();
                    var celPF  = Math.round(celProm(fundasF)).toLocaleString();
                    var protPF = Math.round(fundasF.reduce(function(s,r){ return s+(parseFloat(r.Protozoarios||r.protozoarios)||0); },0) / (fundasF.length||1));

                    h += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin:12px 0;">';
                    h += '<div style="background:white;border-radius:8px;padding:12px;border-left:4px solid #FF9800;box-shadow:0 2px 6px rgba(0,0,0,.06);"><div style="font-size:10px;color:#888;margin-bottom:4px;">Lotes activos</div><div style="font-size:22px;font-weight:700;color:#E65100;">' + lotes.length + '</div></div>';
                    h += '<div style="background:white;border-radius:8px;padding:12px;border-left:4px solid #4CAF50;box-shadow:0 2px 6px rgba(0,0,0,.06);"><div style="font-size:10px;color:#888;margin-bottom:4px;">Densidad promedio</div><div style="font-size:18px;font-weight:700;color:#2E7D32;">' + celPF + ' Cel/ml</div></div>';
                    h += '<div style="background:white;border-radius:8px;padding:12px;border-left:4px solid #FF9800;box-shadow:0 2px 6px rgba(0,0,0,.06);"><div style="font-size:10px;color:#888;margin-bottom:4px;">Protozoarios prom.</div><div style="font-size:18px;font-weight:700;color:#E65100;">' + protPF + '</div></div>';
                    h += '</div>';

                    h += '<div class="charts-container">';
                    h += '<div class="chart-wrapper" ><div class="chart-title">Densidad por Lote</div><div id="fundas_densidad_lote_pills"></div><div class="chart-canvas-wrap"><canvas id="fundas_densidad_lote"></canvas></div></div>';
                    h += '<div class="chart-wrapper" ><div class="chart-title">Protozoarios por Lote</div><div id="fundas_protozoarios_lote_pills"></div><div class="chart-canvas-wrap"><canvas id="fundas_protozoarios_lote"></canvas></div></div>';
                    h += '</div>';

                    // Table
                    h += '<div style="background:white;border-radius:10px;padding:16px;margin:12px 0;overflow-x:auto;box-shadow:0 2px 8px rgba(0,0,0,.06);">';
                    h += '<div style="font-weight:700;font-size:13px;color:#444;margin-bottom:10px;">Resumen por Lote</div>';
                    h += '<table style="width:100%;border-collapse:collapse;font-size:12px;">';
                    h += '<thead><tr style="background:linear-gradient(135deg,#E65100,#BF360C);color:white;">';
                    h += '<th style="padding:8px 12px;text-align:left;">Lote</th><th style="padding:8px 12px;text-align:center;">Especie</th><th style="padding:8px 12px;text-align:center;">Registros</th><th style="padding:8px 12px;text-align:center;">Cel/ml prom.</th><th style="padding:8px 12px;text-align:center;">Protoz. prom.</th></tr></thead><tbody>';
                    lotes.forEach(function(lote, idx) {
                        var lr  = fundasF.filter(function(r){ return (r[loteKey]||r[loteKey.toLowerCase()]||r.Sistema||r.sistema)===lote; });
                        var esp = (lr[0] && (lr[0].Especie||lr[0].especie)) || '-';
                        var cP  = Math.round(celProm(lr)).toLocaleString();
                        var pP  = Math.round(lr.reduce(function(s,r){ return s+(parseFloat(r.Protozoarios||r.protozoarios)||0); },0)/(lr.length||1));
                        var bg  = idx%2===0 ? '#fff' : '#FFF3E0';
                        h += '<tr style="background:' + bg + ';border-bottom:1px solid #FFE0B2;">';
                        h += '<td style="padding:7px 12px;font-weight:600;">' + lote + '</td>';
                        h += '<td style="padding:7px 12px;text-align:center;">' + esp + '</td>';
                        h += '<td style="padding:7px 12px;text-align:center;">' + lr.length + '</td>';
                        h += '<td style="padding:7px 12px;text-align:center;">' + cP + '</td>';
                        h += '<td style="padding:7px 12px;text-align:center;">' + pP + '</td></tr>';
                    });
                    h += '</tbody></table></div>';
                }
            }

            // FBR section
            if (showFbr) {
                h += '<div class="section-title" style="background:linear-gradient(135deg,#6A1B9A,#4A148C);color:white;padding:12px 15px;margin-top:20px;">Fotobioreactor</div>';
                if (fbrF.length === 0) {
                    h += '<div style="text-align:center;padding:25px;background:white;border-radius:10px;color:#999;margin:12px 0;">Sin datos del FBR en el periodo seleccionado.</div>';
                } else {
                    // 6 FBR charts in 3 rows of 2 â€” equal size
                    var fbrRows = [
                        [{cid:'fbr_densidad',    title:'Densidad'},    {cid:'fbr_temperatura', title:'Temperatura'}],
                        [{cid:'fbr_luz',         title:'Intensidad Luz'},   {cid:'fbr_ph',          title:'pH'}],
                        [{cid:'fbr_salinidad',   title:'Salinidad'},      {cid:'fbr_protozoarios',title:'Protozoarios'}]
                    ];
                    fbrRows.forEach(function(pair) {
                        h += '<div class="charts-container" style="margin-top:12px;">';
                        pair.forEach(function(cfg) {
                            h += '<div class="chart-wrapper"><div class="chart-title">' + cfg.title + '</div>' +
                                 '<div id="' + cfg.cid + '_pills"></div>' +
                                 '<div class="chart-canvas-wrap"><canvas id="' + cfg.cid + '"></canvas></div></div>';
                        });
                        h += '</div>';
                    });
                }
            }

            // Write HTML then build charts
            document.getElementById('dashboardContent').innerHTML = h;

            if (window._algasChartTimer) clearTimeout(window._algasChartTimer);
            window._algasChartTimer = setTimeout(function() {
                _buildAlgasCharts(masivosF, premasivosF, fundasF, fbrF,
                                  showMasivos, showPremasivos, showFundas, showFbr);
            }, 30);
        }

        function _buildAlgasCharts(masF, preF, fundF, fbrF, showMas, showPre, showFund, showFbr) {

            var colores = ['#4CAF50','#2196F3','#FF9800','#E91E63','#9C27B0',
                           '#00BCD4','#FFC107','#795548','#FF5722','#607D8B','#8BC34A','#03A9F4'];
            var palette  = ['#FF6F00','#E91E63','#00897B','#8E24AA','#F57F17','#1565C0'];
            var fbrPal   = ['#AB47BC','#FF7043','#F9A825','#42A5F5','#26C6DA','#EC407A','#4CAF50','#FF9800'];

            // â”€â”€ Date helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            function sortFechas(arr) {
                return [...new Set(arr)].filter(Boolean).sort(function(a,b) {
                    function ts(s){s=String(s);return s.includes('/')?s.split('/').reverse().join('-'):s;}
                    return ts(a).localeCompare(ts(b));
                });
            }
            function getAllFechas(rows) {
                return sortFechas(rows.map(function(r){return r.Fecha||r.fecha;}));
            }

            // â”€â”€ Compound key â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            function cKey(r, sk) {
                var sist = String(r[sk]||r[String(sk).toLowerCase()]||r.Sistema||r.sistema||r.Lote||r.lote||'?').trim();
                var cor  = String(r.Corrida_Algas||r.corrida_algas||r.Corrida||r.corrida||'').trim();
                return cor ? (cor + ' - ' + sist) : sist;
            }
            function getKeys(rows, sk) {
                var m = new Map();
                rows.forEach(function(r){var k=cKey(r,sk);if(!m.has(k))m.set(k,r.Fecha||r.fecha||'');});
                return [...m.entries()].sort(function(a,b){
                    function ts(s){s=String(s);return s.includes('/')?s.split('/').reverse().join('-'):s;}
                    return ts(a[1]).localeCompare(ts(b[1]))||a[0].localeCompare(b[0]);
                }).map(function(e){return e[0];});
            }

            // â”€â”€ Multi-key value reader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            function readVal(r, keys) {
                for (var i=0;i<keys.length;i++) {
                    var v = r[keys[i]];
                    if (v===undefined||v===null||v==='') continue;
                    var n = parseFloat(v);
                    if (!isNaN(n)) return n;
                }
                return null;
            }

            function seriesByKey(rows, key, fechas, valKeys, sk) {
                var ks = Array.isArray(valKeys) ? valKeys : [valKeys];
                return fechas.map(function(f) {
                    var regs = rows.filter(function(r){return cKey(r,sk)===key&&(r.Fecha||r.fecha)===f;});
                    var vals = regs.map(function(r){return readVal(r,ks);}).filter(function(v){return v!==null&&v>=0;});
                    return vals.length ? vals.reduce(function(s,v){return s+v;},0)/vals.length : null;
                });
            }

            // â”€â”€ Chart registry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            var _areg = {};

            // â”€â”€ Dropdown pill builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // Rendered ABOVE the chart wrapper, centered, as a compact selector.
            // Does NOT overlap the chart canvas.
            function buildDropdownPills(cid, datasets) {
                var el = document.getElementById(cid+'_pills');
                if (!el || !datasets.length) return;

                // Single series: just show a color badge
                if (datasets.length === 1) {
                    el.innerHTML =
                        '<div style="text-align:center;padding:4px 0 6px;">' +
                        '<span style="display:inline-block;padding:2px 12px;border-radius:12px;' +
                        'background:'+datasets[0].borderColor+';color:#fff;font-size:10px;font-weight:600;">' +
                        datasets[0].label+'</span></div>';
                    return;
                }

                var dd = 'dd_'+cid;
                // Wrapper: centered, above canvas
                var h = '<div style="display:flex;justify-content:center;padding:0 0 8px;position:relative;">';
                // Trigger button â€” neutral, compact
                h += '<button onclick="_aDropToggle(\''+dd+'\')" style="'+
                    'padding:4px 14px 4px 12px;border-radius:20px;'+
                    'border:1.5px solid #bbb;background:#fafafa;color:#444;'+
                    'font-size:11px;font-weight:600;cursor:pointer;'+
                    'display:inline-flex;align-items:center;gap:7px;'+
                    'box-shadow:0 1px 4px rgba(0,0,0,.08);transition:border-color .15s;"'+
                    ' onmouseover="this.style.borderColor=\'#888\'" onmouseout="this.style.borderColor=\'#bbb\'">' +
                    '<span id="'+dd+'_lbl">Todas las series</span>' +
                    '<span style="font-size:9px;color:#888;">&#9660;</span></button>';
                // Dropdown panel â€” centered below button, scrollable
                h += '<div id="'+dd+'" style="display:none;position:absolute;top:calc(100% + 2px);'+
                    'left:50%;transform:translateX(-50%);z-index:9999;'+
                    'background:#fff;border:1.5px solid #ddd;border-radius:10px;padding:8px 10px;'+
                    'box-shadow:0 6px 20px rgba(0,0,0,.13);min-width:210px;max-height:270px;overflow-y:auto;">';
                // "Todas" row
                h += '<div style="display:flex;align-items:center;gap:7px;'+
                    'padding:4px 2px 6px;border-bottom:1px solid #eee;margin-bottom:5px;">'+
                    '<input type="checkbox" id="'+dd+'_all" checked '+
                    'onchange="_aDropAll(\''+cid+'\',this.checked)" style="cursor:pointer;width:14px;height:14px;">'+
                    '<label for="'+dd+'_all" style="cursor:pointer;font-size:11px;font-weight:700;color:#333;">Todas las series</label></div>';
                // Individual rows
                datasets.forEach(function(ds, i) {
                    var col = ds.borderColor||'#999';
                    var sid = dd+'_s'+i;
                    var safeAttr = ds.label.replace(/"/g,'&quot;').replace(/'/g,'&#39;');
                    var safeJs   = ds.label.replace(/'/g,'&#39;');
                    h += '<div style="display:flex;align-items:center;gap:7px;padding:4px 2px;">'+
                        '<input type="checkbox" id="'+sid+'" data-series="'+safeAttr+'" checked '+
                        'onchange="_aDropToggleSeries(\''+cid+'\',\''+safeJs+'\',this.checked)" '+
                        'style="cursor:pointer;width:14px;height:14px;">'+
                        '<label for="'+sid+'" style="cursor:pointer;font-size:11px;'+
                        'display:flex;align-items:center;gap:6px;color:#333;">'+
                        '<span style="display:inline-block;width:11px;height:11px;border-radius:50%;'+
                        'background:'+col+';flex-shrink:0;"></span>'+
                        ds.label+'</label></div>';
                });
                h += '</div></div>';
                el.innerHTML = h;

                // Close on outside click (register only once)
                if (!window._aDropOutside) {
                    window._aDropOutside = true;
                    document.addEventListener('click', function(e) {
                        document.querySelectorAll('[id^="dd_"][id$="_lbl"]').forEach(function(lbl) {
                            var ddId = lbl.id.replace('_lbl','');
                            var panel = document.getElementById(ddId);
                            if (!panel) return;
                            var wrap = lbl.closest('[style*="position:relative"]');
                            if (wrap && !wrap.contains(e.target)) panel.style.display='none';
                        });
                    });
                }
            }

            function _updateDropLabel(cid, reg) {
                var lbl = document.getElementById('dd_'+cid+'_lbl');
                if (!lbl) return;
                var tot = reg.datasets.length, act = reg.active.size;
                lbl.textContent = act===tot ? 'Todas las series' :
                                  act===1   ? [...reg.active][0] :
                                  act+' de '+tot+' series';
            }

            window._aDropToggle = function(ddId) {
                var el = document.getElementById(ddId);
                if (!el) return;
                el.style.display = el.style.display==='none' ? 'block' : 'none';
            };

            window._aDropAll = function(cid, checked) {
                var reg = _areg[cid]; if (!reg) return;
                // Always show all (never allow hiding everything via "all" uncheck)
                reg.active = new Set(reg.datasets.map(function(d){return d.label;}));
                var dd = 'dd_'+cid;
                reg.datasets.forEach(function(_,i){
                    var cb=document.getElementById(dd+'_s'+i); if(cb)cb.checked=true;
                });
                var allCb=document.getElementById(dd+'_all'); if(allCb)allCb.checked=true;
                _aApplyFilter(cid);
            };

            window._aDropToggleSeries = function(cid, label, checked) {
                var reg = _areg[cid]; if (!reg) return;
                if (checked) {
                    reg.active.add(label);
                } else {
                    // Prevent deselecting the last one
                    if (reg.active.size <= 1) {
                        var dd='dd_'+cid;
                        reg.datasets.forEach(function(d,i){
                            if(d.label===label){var cb=document.getElementById(dd+'_s'+i);if(cb)cb.checked=true;}
                        });
                        return;
                    }
                    reg.active.delete(label);
                }
                var allCb=document.getElementById('dd_'+cid+'_all');
                if(allCb) allCb.checked = reg.active.size===reg.datasets.length;
                _aApplyFilter(cid);
            };

            // â”€â”€ Apply filter: trim both X and Y axes to active data â”€â”€â”€â”€â”€â”€â”€
            function _aApplyFilter(cid) {
                var reg = _areg[cid]; if (!reg) return;
                var allLabels = reg.allLabels;
                var activeDS  = reg.datasets.filter(function(d){return reg.active.has(d.label);});

                // 1. X range: first & last index with any non-null value
                var fi = allLabels.length, li = -1;
                activeDS.forEach(function(d){
                    d.data.forEach(function(v,i){
                        if(v!==null&&v!==undefined&&!isNaN(v)){fi=Math.min(fi,i);li=Math.max(li,i);}
                    });
                });
                if(li<0){fi=0;li=allLabels.length-1;}
                fi=Math.max(0,fi); li=Math.min(allLabels.length-1,li);

                // 2. Trim labels & data
                var trimLabels=allLabels.slice(fi,li+1);
                var n=trimLabels.length;
                var trimDS=activeDS.map(function(d){
                    return Object.assign({},d,{
                        data:d.data.slice(fi,li+1),
                        pointRadius:n>20?1:n>10?2:3,
                        pointHoverRadius:n>20?4:n>10?5:6
                    });
                });

                // 3. Y range â€” NEVER go below 0 for count/density/% metrics
                var allVals=[];
                trimDS.forEach(function(d){
                    d.data.forEach(function(v){if(v!==null&&v!==undefined&&!isNaN(v))allVals.push(v);});
                });
                var yMin=null,yMax=null;
                if(allVals.length){
                    var rawMin=Math.min.apply(null,allVals);
                    var rawMax=Math.max.apply(null,allVals);
                    var range=rawMax-rawMin||rawMax*0.1||1;
                    // For non-negative metrics always clamp yMin â‰¥ 0
                    yMin = reg.allowNeg ? rawMin-range*0.1 : Math.max(0, rawMin-range*0.08);
                    yMax = rawMax + range*0.12;
                    // Round nicely
                    yMin = Math.floor(yMin);
                    yMax = Math.ceil(yMax);
                }

                // 4. Update chart
                var ch=reg.chart;
                ch.data.labels=trimLabels;
                ch.data.datasets=trimDS;
                if(yMin!==null){
                    ch.options.scales.y.min=yMin;
                    ch.options.scales.y.max=yMax;
                } else {
                    delete ch.options.scales.y.min;
                    delete ch.options.scales.y.max;
                }
                ch.options.scales.x.ticks.maxTicksLimit=n>20?8:n>10?10:n;
                ch.update('none');
                _updateDropLabel(cid,reg);
            }

            // â”€â”€ Chart factory â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // xLabel/yLabel shown as axis titles; allowNeg=true for pH/temp (can go <0)
            function makeChart(cid, labels, datasets, yLabel, yFmt, xLabel, allowNeg) {
                var el = document.getElementById(cid);
                if (!el || !datasets.length) return;
                var n = labels.length;
                var pr = n>20?1:n>10?2:3;
                var ds = datasets.map(function(d){
                    return Object.assign({},d,{
                        borderWidth: d.borderWidth || 2.5,
                        pointRadius: Math.max(pr, 2),
                        pointHoverRadius: Math.max(pr+3, 5)
                    });
                });
                var tickCb = yFmt ? function(v){try{return yFmt(v);}catch(e){return v;}} : function(v){return v;};
                var ch = new Chart(el, {
                    type:'line', data:{labels:labels, datasets:ds},
                    options:{
                        responsive:true, maintainAspectRatio:false, animation:{duration:200},
                        plugins:{
                            legend:{display:false},
                            tooltip:{
                                backgroundColor:'rgba(0,0,0,0.78)',
                                padding:10,
                                titleFont:{size:12},
                                bodyFont:{size:11},
                                callbacks:{
                                    label:function(ctx){
                                        var v=ctx.parsed.y;
                                        return '  '+ctx.dataset.label+': '+(v===null||v===undefined?'â€”':yFmt?yFmt(v):v);
                                    }
                                }
                            }
                        },
                        scales:{
                            y:{
                                title:{display:!!yLabel, text:yLabel||'', font:{size:11,weight:'600'}, color:'#444'},
                                ticks:{font:{size:10}, maxTicksLimit:6, callback:tickCb},
                                grid:{color:'rgba(0,0,0,0.07)'}
                            },
                            x:{
                                title:{display:!!xLabel, text:xLabel||'', font:{size:11,weight:'600'}, color:'#444'},
                                ticks:{font:{size:10}, maxRotation:45, maxTicksLimit:n>20?8:n>10?10:n},
                                grid:{display:false}
                            }
                        },
                        layout:{padding:{top:6,right:12,bottom:6,left:6}}
                    }
                });
                allCharts.push(ch);
                _areg[cid] = {
                    chart:ch, datasets:ds, allLabels:labels,
                    active:new Set(ds.map(function(d){return d.label;})),
                    allowNeg: !!allowNeg
                };
                buildDropdownPills(cid, ds);
            }

            // â”€â”€ Dataset builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            function mkDS(rows, keys, fechas, valKeys, sk, pal) {
                var ks = Array.isArray(valKeys)?valKeys:[valKeys];
                return keys.map(function(k,i) {
                    return {
                        label:k,
                        data:seriesByKey(rows,k,fechas,ks,sk),
                        borderColor:pal[i%pal.length],
                        backgroundColor:'transparent',
                        tension:0.3, borderWidth:2.5, spanGaps:true
                    };
                });
            }

            // â”€â”€ MASIVOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (showMas && masF.length > 0) {
                var sk='Sistema', keys=getKeys(masF,sk), fechas=getAllFechas(masF);
                makeChart('tend_dens_masivos', fechas,
                    mkDS(masF,keys,fechas,['Cel_ml','cel_ml','Cel/ml'],sk,colores),
                    'Cel/ml', function(v){return Math.round(v).toLocaleString();}, 'Fecha', false);
                makeChart('tend_prot_masivos', fechas,
                    mkDS(masF,keys,fechas,['Protozoarios','protozoarios'],sk,colores),
                    'NÃºmero', function(v){return Math.round(v);}, 'Fecha', false);
                makeChart('ph_masivos', fechas,
                    mkDS(masF,keys,fechas,['pH','ph','PH'],sk,colores),
                    'pH', function(v){return Number(v).toFixed(2);}, 'Fecha', true);
                makeChart('sal_masivos', fechas,
                    mkDS(masF,keys,fechas,['Salinidad_ppt','Salinidad','salinidad','Sal_ppt','sal_ppt'],sk,colores),
                    'ppt', function(v){return Number(v).toFixed(1);}, 'Fecha', false);
            }

            // â”€â”€ PRE-MASIVOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (showPre && preF.length > 0) {
                var sk2='Sistema', keys2=getKeys(preF,sk2), fechas2=getAllFechas(preF);
                makeChart('tend_dens_premasivos', fechas2,
                    mkDS(preF,keys2,fechas2,['Cel_ml','cel_ml','Cel/ml'],sk2,palette),
                    'Cel/ml', function(v){return Math.round(v).toLocaleString();}, 'Fecha', false);
                makeChart('tend_prot_premasivos', fechas2,
                    mkDS(preF,keys2,fechas2,['Protozoarios','protozoarios'],sk2,palette),
                    'NÃºmero', function(v){return Math.round(v);}, 'Fecha', false);
                makeChart('ph_premasivos', fechas2,
                    mkDS(preF,keys2,fechas2,['pH','ph','PH'],sk2,palette),
                    'pH', function(v){return Number(v).toFixed(2);}, 'Fecha', true);
                makeChart('sal_premasivos', fechas2,
                    mkDS(preF,keys2,fechas2,['Salinidad_ppt','Salinidad','salinidad','Sal_ppt','sal_ppt'],sk2,palette),
                    'ppt', function(v){return Number(v).toFixed(1);}, 'Fecha', false);
            }

            // â”€â”€ FUNDAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (showFund && fundF.length > 0) {
                var sk3=(fundF[0]&&(fundF[0].Lote||fundF[0].lote))?'Lote':'Sistema';
                var keys3=getKeys(fundF,sk3), fechas3=getAllFechas(fundF);
                makeChart('fundas_densidad_lote', fechas3,
                    mkDS(fundF,keys3,fechas3,['Cel_ml','cel_ml','Cel/ml'],sk3,colores),
                    'Cel/ml', function(v){return Math.round(v).toLocaleString();}, 'Fecha', false);
                makeChart('fundas_protozoarios_lote', fechas3,
                    mkDS(fundF,keys3,fechas3,['Protozoarios','protozoarios'],sk3,colores),
                    'NÃºmero', function(v){return Math.round(v);}, 'Fecha', false);
            }

            // â”€â”€ FBR â€” real-date X axis, adaptive on filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (showFbr && fbrF.length > 0) {
                function getFbrKey(r) {
                    var mod=String(r.Modulo_Algas||r.modulo_algas||r.Sistema||r.sistema||r.Lote||r.lote||'FBR').trim();
                    var cor=String(r.Corrida_Algas||r.corrida_algas||r.Corrida||r.corrida||'').trim();
                    return cor?(cor+' - '+mod):mod;
                }
                var fbrSorted=[...fbrF].sort(function(a,b){
                    function ts(s){s=String(s||'');return s.includes('/')?s.split('/').reverse().join('-'):s;}
                    return ts(a.Fecha||a.fecha).localeCompare(ts(b.Fecha||b.fecha));
                });
                var groupMap={};
                fbrSorted.forEach(function(r){var k=getFbrKey(r);if(!groupMap[k])groupMap[k]=[];groupMap[k].push(r);});

                // Sort corridas by their first date
                var fbrKeys=Object.keys(groupMap).sort(function(a,b){
                    function ts(s){s=String(s||'');return s.includes('/')?s.split('/').reverse().join('-'):s;}
                    var fa=(groupMap[a][0]||{}).Fecha||(groupMap[a][0]||{}).fecha||'';
                    var fb=(groupMap[b][0]||{}).Fecha||(groupMap[b][0]||{}).fecha||'';
                    return ts(fa).localeCompare(ts(fb));
                });

                // Global sorted date union across all corridas
                var allFbrFechas = sortFechas(fbrF.map(function(r){return r.Fecha||r.fecha;}));

                // Build datasets: each corrida plots its values at its own real dates,
                // nulls for dates it doesn't have
                function fbrDS(valKeys) {
                    var ks=Array.isArray(valKeys)?valKeys:[valKeys];
                    return fbrKeys.map(function(k,i) {
                        var rows=groupMap[k];
                        var vals=allFbrFechas.map(function(f){
                            var fr=rows.filter(function(r){return (r.Fecha||r.fecha)===f;});
                            if(!fr.length) return null;
                            var vs=fr.map(function(r){return readVal(r,ks);}).filter(function(v){return v!==null&&v>=0;});
                            return vs.length?vs.reduce(function(s,v){return s+v;},0)/vs.length:null;
                        });
                        return {
                            label:k, data:vals,
                            borderColor:fbrPal[i%fbrPal.length],
                            backgroundColor:fbrPal[i%fbrPal.length]+'22',
                            tension:0.35, borderWidth:2.5,
                            pointRadius:4, pointHoverRadius:6,
                            spanGaps:false,
                            fill:fbrKeys.length===1
                        };
                    });
                }

                var fbrCfg=[
                    {cid:'fbr_densidad',     keys:['Cel_ml','cel_ml'],                            yLab:'Cel/ml',   fmt:function(v){return Math.round(v).toLocaleString();}, neg:false},
                    {cid:'fbr_temperatura',  keys:['Temperatura_C','Temperatura','temperatura'],    yLab:'Â°C',       fmt:function(v){return Number(v).toFixed(1);},           neg:true},
                    {cid:'fbr_luz',          keys:['Intensidad_Luz_%','Intensidad_Luz','Luz_%','Luz'],yLab:'%',     fmt:function(v){return Number(v).toFixed(1);},           neg:false},
                    {cid:'fbr_ph',           keys:['pH','ph','PH'],                                 yLab:'pH',       fmt:function(v){return Number(v).toFixed(2);},           neg:true},
                    {cid:'fbr_salinidad',    keys:['Salinidad_ppt','Salinidad','salinidad'],        yLab:'ppt',      fmt:function(v){return Number(v).toFixed(1);},           neg:false},
                    {cid:'fbr_protozoarios', keys:['Protozoarios','protozoarios'],                  yLab:'NÃºmero', fmt:function(v){return Math.round(v);},                 neg:false}
                ];
                fbrCfg.forEach(function(cfg){
                    makeChart(cfg.cid, allFbrFechas, fbrDS(cfg.keys), cfg.yLab, cfg.fmt, 'Fecha', cfg.neg);
                });
            }
        }



        function toggleTendenciaAlgas(tipo) {
            const densDiv = document.getElementById('tendenciaDensidadAlgas');
            const protDiv = document.getElementById('tendenciaProtozoariosAlgas');
            const btnDens = document.getElementById('btnTendDensidad');
            const btnProt = document.getElementById('btnTendProtozoarios');
            if (!densDiv || !protDiv) return;
            if (tipo === 'densidad') {
                densDiv.style.display = 'flex';
                protDiv.style.display = 'none';
                if (btnDens) { btnDens.style.background='#4CAF50'; btnDens.style.color='white'; }
                if (btnProt) { btnProt.style.background=''; btnProt.style.color=''; }
            } else {
                densDiv.style.display = 'none';
                protDiv.style.display = 'flex';
                if (btnProt) { btnProt.style.background='#4CAF50'; btnProt.style.color='white'; }
                if (btnDens) { btnDens.style.background=''; btnDens.style.color=''; }
            }
        }



        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  ÃREA DE MADURACIÃ“N â€“ funciones de filtro y renderizado
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // DistribuciÃ³n de tanques por sala (fija)
        const SALA_CONFIG = {
            'SALA 1':  { tanques: Array.from({length:15}, (_,i)=>i+1),  color:'#5C6BC0', colorLight:'#E8EAF6' },
            'SALA 2':  { tanques: Array.from({length:6},  (_,i)=>i+16), color:'#26A69A', colorLight:'#E0F2F1' },
            'SALA 3':  { tanques: Array.from({length:6},  (_,i)=>i+22), color:'#EF5350', colorLight:'#FFEBEE' },
            'SALA 4A': { tanques: Array.from({length:4},  (_,i)=>i+1),  color:'#FF9800', colorLight:'#FFF3E0' },
            'SALA 4B': { tanques: Array.from({length:4},  (_,i)=>i+5),  color:'#AB47BC', colorLight:'#F3E5F5' },
        };

        function getMadData() {
            return globalData.filter(row => {
                const origin = String(row._SheetOrigin || '').toLowerCase();
                // Primary: SheetOrigin match
                if (origin === 'maduracion' || origin === 'maduraciÃ³n' || origin === 'maduracion' ) return true;
                // Fallback: has maduracion-specific columns AND a Sala value
                const hasMadCols = (row.hasOwnProperty('N_Machos') || row.hasOwnProperty('n_machos') ||
                                    row.hasOwnProperty('Total_Nauplios') || row.hasOwnProperty('Tasa_Copula_%'));
                const hasSala = String(row.Sala || row.sala || '').trim() !== '';
                // Exclude larvicultura rows that also have some matching fields
                const hasLarvCols = row.hasOwnProperty('Corrida') && row.hasOwnProperty('MÃ³dulo');
                return hasMadCols && hasSala && !hasLarvCols;
            });
        }

        function toggleAllSalasMad(checkbox) {
            document.querySelectorAll('#salaMadOptions input[type="checkbox"]').forEach(cb => cb.checked = checkbox.checked);
            updateSelectedSalasMad();
        }

        function updateSelectedSalasMad() {
            const allCb = document.getElementById('salaMad_todas');
            const cbs = Array.from(document.querySelectorAll('#salaMadOptions input[type="checkbox"]'));
            const checked = cbs.filter(cb => cb.checked);
            if (checked.length === 0) { allCb.checked = true; cbs.forEach(cb => cb.checked = true); }
            else if (checked.length === cbs.length) allCb.checked = true;
            else allCb.checked = false;
            selectedSalasMad = checked.map(cb => cb.value);
            document.getElementById('salaMadSelected').textContent =
                allCb.checked ? 'Todas las Salas' : selectedSalasMad.length === 1 ? selectedSalasMad[0] : `${selectedSalasMad.length} salas`;
            if (currentView === 'maduracion') renderMaduracionView();
        }

        function updateFaseMad() {
            selectedFasesMad = [];
            if (document.getElementById('faseMad_cuarentena')?.checked) selectedFasesMad.push('Cuarentena');
            if (document.getElementById('faseMad_produccion')?.checked) selectedFasesMad.push('Produccion');
            if (selectedFasesMad.length === 0) {
                document.getElementById('faseMad_cuarentena').checked = true;
                document.getElementById('faseMad_produccion').checked = true;
                selectedFasesMad = ['Cuarentena', 'Produccion'];
            }
            if (currentView === 'maduracion') renderMaduracionView();
        }

        function initMaduracionFilters(madData) {
            const salas = [...new Set(madData.map(r => String(r.Sala || r.sala || '').trim()))].filter(Boolean).sort();
            selectedSalasMad = salas;
            const salaMadOpts = document.getElementById('salaMadOptions');
            if (salaMadOpts) {
                salaMadOpts.innerHTML = '';
                salas.forEach(sala => {
                    const cfg = SALA_CONFIG[sala];
                    const dot = cfg ? `<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${cfg.color};margin-right:4px;"></span>` : '';
                    salaMadOpts.innerHTML += `<div class="dropdown-item">
                        <input type="checkbox" id="salaMad_${sala.replace(/\s/g,'_')}" value="${sala}" checked onchange="updateSelectedSalasMad()">
                        <label for="salaMad_${sala.replace(/\s/g,'_')}">${dot}${sala}</label>
                    </div>`;
                });
            }
        }

        function parseFecha(f) {
            if (!f) return new Date(0);
            f = String(f).trim();
            if (f.includes('/')) { const [d,m,y]=f.split('/'); return new Date(y,m-1,d); }
            if (f.includes('-')) return new Date(f);
            return new Date(f);
        }

        function fmtNum(n, dec=0) {
            if (n === null || n === undefined || isNaN(n)) return 'â€”';
            return Number(n).toLocaleString('es-EC', {minimumFractionDigits:dec, maximumFractionDigits:dec});
        }

        function avgField(rows, key) {
            const vals = rows.map(r=>parseFloat(r[key]||0)).filter(v=>!isNaN(v)&&v>0);
            return vals.length ? vals.reduce((s,v)=>s+v,0)/vals.length : 0;
        }

        function sumField(rows, key) {
            return rows.reduce((s,r)=>s+(parseFloat(r[key]||0)||0),0);
        }

        function renderMaduracionView() {
            destroyAllCharts();
            const allMad = getMadData();

            if (allMad.length === 0) {
                document.getElementById('dashboardContent').innerHTML = `
                    <div style="text-align:center;padding:60px 20px;background:white;border-radius:12px;margin:40px;box-shadow:0 4px 15px rgba(0,0,0,.1);">
                        <div style="font-size:64px;margin-bottom:20px;">ğŸ¦</div>
                        <h2 style="color:#7B1FA2;margin-bottom:15px;">Ãrea de MaduraciÃ³n</h2>
                        <p style="color:#666;font-size:16px;">No se encontraron datos de maduraciÃ³n en el archivo Excel.<br>
                        AsegÃºrese de que la hoja se llame <b>Maduracion</b> y tenga la columna <b>Sala</b>.</p>
                    </div>`;
                return;
            }

            // Init filters only if not already populated
            const salaMadOptsCheck = document.getElementById('salaMadOptions');
            if (!salaMadOptsCheck || salaMadOptsCheck.children.length === 0) {
                initMaduracionFilters(allMad);
            }

            // Filter by sala
            const allSalasCb = document.getElementById('salaMad_todas');
            let madData = allMad;
            if (allSalasCb && !allSalasCb.checked && selectedSalasMad.length > 0) {
                madData = madData.filter(r => selectedSalasMad.includes(String(r.Sala||r.sala||'').trim()));
            } else if (allSalasCb && allSalasCb.checked) {
                // all selected - no filter
            }

            // Sort by date
            madData = [...madData].sort((a,b) => parseFecha(a.Fecha||a.fecha) - parseFecha(b.Fecha||b.fecha));

            // Separate phases
            const cuarentenaData = madData.filter(r => {
                const dia = parseInt(r.Dia_Proceso || r.dia_proceso || 0);
                const estado = String(r.Estado || r.estado || '').toLowerCase();
                return dia <= 16 || estado.includes('cuarentena');
            });
            const produccionData = madData.filter(r => {
                const dia = parseInt(r.Dia_Proceso || r.dia_proceso || 0);
                const estado = String(r.Estado || r.estado || '').toLowerCase();
                return dia > 16 || estado.includes('producci');
            });

            const showCuarentena = selectedFasesMad.includes('Cuarentena');
            const showProduccion = selectedFasesMad.includes('Produccion');
            const activeData = [...(showCuarentena ? cuarentenaData : []), ...(showProduccion ? produccionData : [])];

            const salas = [...new Set(madData.map(r=>String(r.Sala||r.sala||'').trim()))].filter(Boolean).sort();

            // â”€â”€ KPI CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const totalMachos = sumField(produccionData.length ? produccionData : madData, 'N_Machos') || sumField(madData.slice(-salas.length*5), 'N_Machos');
            const totalHembras = sumField(produccionData.length ? produccionData : madData, 'N_Hembras') || sumField(madData.slice(-salas.length*5), 'N_Hembras');

            // Get last day's data for KPIs
            const fechasAll = [...new Set(madData.map(r=>r.Fecha||r.fecha))].filter(Boolean);
            const lastFecha = fechasAll[fechasAll.length - 1];
            const lastDayData = madData.filter(r=>(r.Fecha||r.fecha)===lastFecha);
            const naupliosHoy = sumField(lastDayData, 'Total_Nauplios');
            const totalMachosHoy = sumField(lastDayData, 'N_Machos');
            const totalHembrasHoy = sumField(lastDayData, 'N_Hembras');
            const tasaCopulaHoy = avgField(lastDayData.filter(r=>parseFloat(r.Tasa_Copula_||r['Tasa_Copula_%']||0)>0), 'Tasa_Copula_%') ||
                                  avgField(lastDayData, 'Tasa_Copula_');

            let html = `<div class="section-title" style="background:linear-gradient(135deg,#4A148C,#6A1B9A);color:white;text-shadow:2px 2px 4px rgba(0,0,0,.4);padding:15px;">
                ğŸ¦ Ãrea de MaduraciÃ³n - Monitoreo de Reproductores</div>`;

            // KPI bar
            html += `<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin:18px 0;">
                <div style="background:linear-gradient(135deg,#1565C0,#0D47A1);color:white;padding:14px;border-radius:10px;text-align:center;box-shadow:0 3px 10px rgba(0,0,0,.2);">
                    <div style="font-size:16px;font-weight:700;margin-bottom:4px;opacity:.8;">â™‚</div>
                    <div style="font-size:11px;opacity:.85;margin-bottom:4px;">Machos (hoy)</div>
                    <div style="font-size:26px;font-weight:700;">${fmtNum(totalMachosHoy)}</div>
                </div>
                <div style="background:linear-gradient(135deg,#AD1457,#880E4F);color:white;padding:14px;border-radius:10px;text-align:center;box-shadow:0 3px 10px rgba(0,0,0,.2);">
                    <div style="font-size:16px;font-weight:700;margin-bottom:4px;opacity:.8;">â™€</div>
                    <div style="font-size:11px;opacity:.85;margin-bottom:4px;">Hembras (hoy)</div>
                    <div style="font-size:26px;font-weight:700;">${fmtNum(totalHembrasHoy)}</div>
                </div>
                <div style="background:linear-gradient(135deg,#2E7D32,#1B5E20);color:white;padding:14px;border-radius:10px;text-align:center;box-shadow:0 3px 10px rgba(0,0,0,.2);">
                    <div style="font-size:18px;margin-bottom:4px;">ğŸŒŠ</div>
                    <div style="font-size:11px;opacity:.85;margin-bottom:4px;">Salas en Proceso</div>
                    <div style="font-size:26px;font-weight:700;">${salas.length}</div>
                    <div style="font-size:9px;opacity:.7;">35 tanques / 5 salas</div>
                </div>
                <div style="background:linear-gradient(135deg,#E65100,#BF360C);color:white;padding:14px;border-radius:10px;text-align:center;box-shadow:0 3px 10px rgba(0,0,0,.2);">
                    <div style="font-size:18px;margin-bottom:4px;">ğŸ§¬</div>
                    <div style="font-size:11px;opacity:.85;margin-bottom:4px;">Nauplios hoy</div>
                    <div style="font-size:22px;font-weight:700;">${fmtNum(naupliosHoy)}</div>
                </div>
                <div style="background:linear-gradient(135deg,#6A1B9A,#4A148C);color:white;padding:14px;border-radius:10px;text-align:center;box-shadow:0 3px 10px rgba(0,0,0,.2);">
                    <div style="font-size:18px;margin-bottom:4px;">ğŸ”—</div>
                    <div style="font-size:11px;opacity:.85;margin-bottom:4px;">Tasa CÃ³pula hoy</div>
                    <div style="font-size:26px;font-weight:700;">${fmtNum(tasaCopulaHoy,1)}%</div>
                </div>
            </div>`;

            // â”€â”€ DISTRIBUCIÃ“N DE SALAS â€” datos reales â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // Build sala summary from actual data
            const salaSummary = {};
            salas.forEach(sala => {
                const sr = madData.filter(r=>String(r.Sala||r.sala||'').trim()===sala);
                const tanquesUniq = [...new Set(sr.map(r=>String(r.Tanque||r.tanque||'').trim()))].filter(Boolean);
                // Last record per tanque to get current phase
                const lastDia = sr.length ? Math.max(...sr.map(r=>parseInt(r.Dia_Proceso||r.dia_proceso||0)||0)) : 0;
                const lastEstado = sr.length
                    ? String(sr.sort((a,b)=>parseFecha(b.Fecha||b.fecha)-parseFecha(a.Fecha||a.fecha))[0].Estado||sr[0].estado||'').toLowerCase()
                    : '';
                const esCuarentena = lastEstado.includes('cuarentena') || (lastDia > 0 && lastDia <= 16 && !lastEstado.includes('producci'));
                const codGen = [...new Set(sr.map(r=>String(r.Codigo_Genetico||r.codigo_genetico||'').trim()).filter(Boolean))].join(', ');
                const lastFechaSala = sr.length ? [...new Set(sr.map(r=>r.Fecha||r.fecha))].filter(Boolean).sort((a,b)=>parseFecha(b)-parseFecha(a))[0] : null;
                const lastDaySala = lastFechaSala ? sr.filter(r=>(r.Fecha||r.fecha)===lastFechaSala) : [];
                salaSummary[sala] = {
                    tanques: tanquesUniq, lastDia, esCuarentena, codGen, lastDaySala,
                    machos: lastDaySala.reduce((s,r)=>s+(parseInt(r.N_Machos||r.n_machos||0)||0),0),
                    hembras: lastDaySala.reduce((s,r)=>s+(parseInt(r.N_Hembras||r.n_hembras||0)||0),0),
                    nauplios: lastDaySala.reduce((s,r)=>s+(parseInt(r.Total_Nauplios||r.total_nauplios||0)||0),0),
                };
            });

            const SALA_COLORS_LIST = ['#5C6BC0','#26A69A','#EF5350','#FF9800','#AB47BC','#1E88E5'];

            html += `<div style="background:white;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,.08);padding:18px;margin-bottom:18px;">
                <div style="font-size:15px;font-weight:700;color:#4A148C;margin-bottom:14px;padding-bottom:8px;border-bottom:2px solid #EDE7F6;">
                    ğŸ“ Estado Actual por Sala
                </div>
                <div style="display:grid;grid-template-columns:repeat(${Math.min(salas.length,5)},1fr);gap:10px;">`;

            salas.forEach((sala, idx) => {
                const sm = salaSummary[sala];
                const col = SALA_COLORS_LIST[idx % SALA_COLORS_LIST.length];
                const colLight = col + '18';
                const faseColor = sm.esCuarentena ? '#1565C0' : '#2E7D32';
                const faseLabel = sm.esCuarentena ? 'Cuarentena' : 'ProducciÃ³n';
                const faseIcon  = sm.esCuarentena ? 'ğŸ”’' : 'âš™ï¸';
                const totalPob = sm.machos + sm.hembras;

                html += `<div style="background:${colLight};border-radius:10px;padding:13px;text-align:center;border-top:4px solid ${col};border:1.5px solid ${col}22;border-top:4px solid ${col};">
                    <div style="font-weight:700;color:${col};font-size:14px;margin-bottom:3px;">${sala}</div>
                    ${sm.codGen ? `<div style="background:${col};color:white;display:inline-block;padding:1px 9px;border-radius:8px;font-size:10px;font-weight:600;margin-bottom:6px;">${sm.codGen}</div>` : ''}
                    <div style="display:flex;justify-content:center;gap:5px;margin:6px 0;">
                        <div style="background:white;border-radius:6px;padding:4px 6px;flex:1;">
                            <div style="font-size:9px;color:#888;">Tanques</div>
                            <div style="font-size:15px;font-weight:700;color:${col};">${sm.tanques.length}</div>
                        </div>
                        <div style="background:#EBF2FF;border-radius:6px;padding:4px 6px;flex:1;">
                            <div style="font-size:9px;color:#1565C0;font-weight:600;">â™‚ Machos</div>
                            <div style="font-size:15px;font-weight:700;color:#1565C0;">${sm.machos > 0 ? fmtNum(sm.machos) : 'â€”'}</div>
                        </div>
                        <div style="background:#FCEAF3;border-radius:6px;padding:4px 6px;flex:1;">
                            <div style="font-size:9px;color:#AD1457;font-weight:600;">â™€ Hembras</div>
                            <div style="font-size:15px;font-weight:700;color:#AD1457;">${sm.hembras > 0 ? fmtNum(sm.hembras) : 'â€”'}</div>
                        </div>
                    </div>
                    <div style="font-size:10px;color:#666;margin:2px 0;">${totalPob > 0 ? `PoblaciÃ³n total: <b>${fmtNum(totalPob)}</b>` : ''}</div>
                    ${sm.nauplios > 0 ? `<div style="font-size:10px;color:#555;margin:3px 0;">ğŸ§¬ ${fmtNum(sm.nauplios)} nauplios hoy</div>` : ''}
                    ${sm.lastDia > 0
                        ? `<div style="margin-top:6px;background:${faseColor};color:white;padding:3px 8px;border-radius:8px;font-size:10px;font-weight:600;display:inline-block;">${faseIcon} ${faseLabel} Â· DÃ­a ${sm.lastDia}</div>`
                        : `<div style="font-size:10px;color:#bbb;margin-top:6px;">Sin datos cargados</div>`}
                </div>`;
            });
            html += `</div></div>`;

            // â”€â”€ FASE 1: CUARENTENA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (showCuarentena) {
                html += `<div class="section-title" style="background:linear-gradient(135deg,#1565C0,#0D47A1);color:white;padding:12px 15px;margin-top:10px;">
                    ğŸ”’ FASE 1: CUARENTENA â€” DÃ­as 1 al 16</div>`;

                if (cuarentenaData.length === 0) {
                    html += `<div style="background:white;border-radius:10px;padding:25px;text-align:center;color:#999;margin:10px 0;">Sin datos de Cuarentena en el perÃ­odo.</div>`;
                } else {
                    const fechasCQ = [...new Set(cuarentenaData.map(r=>r.Fecha||r.fecha))].filter(Boolean);
                    const tanquesCQ = [...new Set(cuarentenaData.map(r=>String(r.Tanque||r.tanque||'').trim()))].filter(Boolean)
                        .sort((a,b)=>{ const nA=parseInt(String(a).replace(/\D/g,''))||0, nB=parseInt(String(b).replace(/\D/g,''))||0; return nA-nB; });

                    html += `<div class="charts-container" style="margin-top:12px;">
                        <div class="chart-wrapper" >
                            <div class="chart-title">ğŸŒ¡ï¸ Temperatura</div><div id="cq_temp_pills"></div>
                            <div class="chart-canvas-wrap"><canvas id="cq_temp"></canvas></div>
                        </div>
                        <div class="chart-wrapper" >
                            <div class="chart-title">ğŸ’¨ OxÃ­geno</div><div id="cq_oxigeno_pills"></div>
                            <div class="chart-canvas-wrap"><canvas id="cq_oxigeno"></canvas></div>
                        </div>
                    </div>
                    <div class="charts-container" style="margin-top:12px;">
                        <div class="chart-wrapper" >
                            <div class="chart-title">â™‚ Mortalidad de Machos</div><div id="cq_mort_machos_pills"></div>
                            <div class="chart-canvas-wrap"><canvas id="cq_mort_machos"></canvas></div>
                        </div>
                        <div class="chart-wrapper" >
                            <div class="chart-title">â™€ Mortalidad de Hembras</div><div id="cq_mort_hembras_pills"></div>
                            <div class="chart-canvas-wrap"><canvas id="cq_mort_hembras"></canvas></div>
                        </div>
                    </div>`;

                    // Cuarentena summary cards per sala
                    html += `<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin:12px 0;">`;
                    salas.forEach(sala => {
                        const sd = cuarentenaData.filter(r=>String(r.Sala||r.sala||'').trim()===sala);
                        if (!sd.length) return;
                        const cfg = SALA_CONFIG[sala] || {color:'#607D8B',colorLight:'#ECEFF1'};
                        const tempProm = avgField(sd, 'Temperatura_C');
                        const oxProm = avgField(sd, 'Oxigeno_mgL');
                        const mortProm = avgField(sd, 'Mortalidad_%');
                        html += `<div style="background:${cfg.colorLight};border-top:3px solid ${cfg.color};border-radius:8px;padding:12px;">
                            <div style="font-weight:700;color:${cfg.color};font-size:13px;margin-bottom:8px;">${sala}</div>
                            <div style="font-size:12px;color:#555;line-height:1.8;">
                                ğŸŒ¡ï¸ Temp: <b>${fmtNum(tempProm,1)}Â°C</b><br>
                                ğŸ’¨ Oâ‚‚: <b>${fmtNum(oxProm,2)} mg/L</b><br>
                                Mort: <b>${fmtNum(mortProm,2)}%</b>
                            </div>
                        </div>`;
                    });
                    html += `</div>`;
                }
            }

            // â”€â”€ FASE 2: PRODUCCIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (showProduccion) {
                html += `<div class="section-title" style="background:linear-gradient(135deg,#6A1B9A,#4A148C);color:white;padding:12px 15px;margin-top:18px;">
                    âš™ï¸ FASE 2: PRODUCCIÃ“N â€” DÃ­as 17 en adelante</div>`;

                if (produccionData.length === 0) {
                    html += `<div style="background:white;border-radius:10px;padding:25px;text-align:center;color:#999;margin:10px 0;">Sin datos de ProducciÃ³n en el perÃ­odo.</div>`;
                } else {
                    const fechasProd = [...new Set(produccionData.map(r=>r.Fecha||r.fecha))].filter(Boolean);

                    // Row 1: Tasa de CÃ³pula + Muda
                    html += `<div class="charts-container" style="margin-top:12px;">
                        <div class="chart-wrapper" >
                            <div class="chart-title">Tasa de CÃ³pula</div><div id="prod_copula_pills"></div>
                            <div class="chart-canvas-wrap"><canvas id="prod_copula"></canvas></div>
                        </div>
                        <div class="chart-wrapper" >
                            <div class="chart-title">% Muda</div><div id="prod_muda_pills"></div>
                            <div class="chart-canvas-wrap"><canvas id="prod_muda"></canvas></div>
                        </div>
                    </div>`;

                    // Row 2: Nauplios + Mortalidad
                    html += `<div class="charts-container">
                        <div class="chart-wrapper" >
                            <div class="chart-title">Nauplios por DÃ­a</div><div id="prod_nauplios_pills"></div>
                            <div class="chart-canvas-wrap"><canvas id="prod_nauplios"></canvas></div>
                        </div>
                        <div class="chart-wrapper" >
                            <div class="chart-title">Mortalidad</div><div id="prod_mortalidad_pills"></div>
                            <div class="chart-canvas-wrap"><canvas id="prod_mortalidad"></canvas></div>
                        </div>
                    </div>`;

                    // Row 3: PoblaciÃ³n apilada + Copuladas
                    html += `<div class="charts-container">
                        <div class="chart-wrapper" >
                            <div class="chart-title">EvoluciÃ³n de PoblaciÃ³n</div><div id="prod_poblacion_pills"></div>
                            <div class="chart-canvas-wrap"><canvas id="prod_poblacion"></canvas></div>
                        </div>
                        <div class="chart-wrapper" >
                            <div class="chart-title">Hembras Copuladas</div><div id="prod_copuladas_pills"></div>
                            <div class="chart-canvas-wrap"><canvas id="prod_copuladas"></canvas></div>
                        </div>
                    </div>`;

                    // Row 4: Mortalidad Machos + Mortalidad Hembras
                    html += '<div class="charts-container">' +
                        '<div class="chart-wrapper" >' +
                            '<div class="chart-title">â™‚ Mortalidad de Machos</div><div id="prod_mort_machos_pills"></div>' +
                            '<div class="chart-canvas-wrap"><canvas id="prod_mort_machos"></canvas></div>' +
                        '</div>' +
                        '<div class="chart-wrapper" >' +
                            '<div class="chart-title">â™€ Mortalidad de Hembras</div><div id="prod_mort_hembras_pills"></div>' +
                            '<div class="chart-canvas-wrap"><canvas id="prod_mort_hembras"></canvas></div>' +
                        '</div>' +
                    '</div>';

                    // â”€â”€ TABLA COMPARATIVA POR SALA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                    html += `<div style="background:white;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,.08);padding:20px;margin:15px 0;overflow-x:auto;">
                        <div class="chart-title" style="margin-bottom:14px;">ğŸ“Š Tabla Comparativa de Rendimiento por Sala</div>
                        <table style="width:100%;border-collapse:collapse;font-size:13px;">
                            <thead>
                                <tr style="background:linear-gradient(135deg,#6A1B9A,#4A148C);color:white;">
                                    <th style="padding:10px 14px;text-align:left;border-radius:6px 0 0 0;">Sala</th>
                                    <th style="padding:10px 14px;text-align:center;">CÃ³d. GenÃ©tico</th>
                                    <th style="padding:10px 14px;text-align:center;">Tanques</th>
                                    <th style="padding:10px 14px;text-align:center;">Machos</th>
                                    <th style="padding:10px 14px;text-align:center;">Hembras</th>
                                    <th style="padding:10px 14px;text-align:center;">CÃ³pula %</th>
                                    <th style="padding:10px 14px;text-align:center;">Copuladas</th>
                                    <th style="padding:10px 14px;text-align:center;">Muda %</th>
                                    <th style="padding:10px 14px;text-align:center;">Nauplios Tot.</th>
                                    <th style="padding:10px 14px;text-align:center;border-radius:0 6px 0 0;">Mort. %</th>
                                </tr>
                            </thead>
                            <tbody>`;

                    salas.forEach((sala, idx) => {
                        const sd = produccionData.filter(r=>String(r.Sala||r.sala||'').trim()===sala);
                        if (!sd.length) return;
                        const cfg = SALA_CONFIG[sala] || {color:'#607D8B',colorLight:'#ECEFF1'};
                        const codGen = [...new Set(sd.map(r=>r.Codigo_Genetico||r.codigo_genetico||'').filter(Boolean))].join(', ') || 'â€”';
                        const tanquesActivos = [...new Set(sd.map(r=>r.Tanque||r.tanque))].filter(Boolean).length;
                        const lastFechaSala = [...new Set(sd.map(r=>r.Fecha||r.fecha))].filter(Boolean).sort().slice(-1)[0];
                        const lastSd = sd.filter(r=>(r.Fecha||r.fecha)===lastFechaSala);
                        const machos = sumField(lastSd, 'N_Machos');
                        const hembras = sumField(lastSd, 'N_Hembras');
                        const copula = avgField(sd.filter(r=>parseFloat(r['Tasa_Copula_%']||r.Tasa_Copula_||0)>0), 'Tasa_Copula_%') ||
                                       avgField(sd, 'Tasa_Copula_');
                        const copuladas = sumField(sd, 'Copuladas');
                        const muda = avgField(sd.filter(r=>parseFloat(r.Pct_Muda||r.pct_muda||0)>0), 'Pct_Muda');
                        const nauplios = sumField(sd, 'Total_Nauplios');
                        const mort = avgField(sd.filter(r=>parseFloat(r['Mortalidad_%']||r.Mortalidad_||0)>0), 'Mortalidad_%');
                        const bg = idx%2===0?'#fff':'#faf5ff';
                        html += `<tr style="background:${bg};border-bottom:1px solid #EDE7F6;">
                            <td style="padding:9px 14px;font-weight:700;color:${cfg.color};">${sala}</td>
                            <td style="padding:9px 14px;text-align:center;"><span style="background:${cfg.color};color:white;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;">${codGen}</span></td>
                            <td style="padding:9px 14px;text-align:center;">${tanquesActivos}</td>
                            <td style="padding:9px 14px;text-align:center;color:#1565C0;font-weight:600;">${fmtNum(machos)}</td>
                            <td style="padding:9px 14px;text-align:center;color:#AD1457;font-weight:600;">${fmtNum(hembras)}</td>
                            <td style="padding:9px 14px;text-align:center;">${fmtNum(copula,1)}%</td>
                            <td style="padding:9px 14px;text-align:center;">${fmtNum(copuladas)}</td>
                            <td style="padding:9px 14px;text-align:center;">${fmtNum(muda,1)}%</td>
                            <td style="padding:9px 14px;text-align:center;font-weight:700;color:#E65100;">${fmtNum(nauplios)}</td>
                            <td style="padding:9px 14px;text-align:center;color:${mort>5?'#EF5350':'#43A047'};font-weight:600;">${fmtNum(mort,2)}%</td>
                        </tr>`;
                    });

                    // Totals row
                    const totMachos = sumField(lastDayData, 'N_Machos');
                    const totHembras = sumField(lastDayData, 'N_Hembras');
                    const totCopula = avgField(produccionData.filter(r=>parseFloat(r['Tasa_Copula_%']||0)>0), 'Tasa_Copula_%');
                    const totCopuladas = sumField(produccionData, 'Copuladas');
                    const totMuda = avgField(produccionData.filter(r=>parseFloat(r.Pct_Muda||0)>0), 'Pct_Muda');
                    const totNauplios = sumField(produccionData, 'Total_Nauplios');
                    const totMort = avgField(produccionData.filter(r=>parseFloat(r['Mortalidad_%']||0)>0), 'Mortalidad_%');
                    html += `<tr style="background:linear-gradient(135deg,#EDE7F6,#D1C4E9);font-weight:700;border-top:2px solid #6A1B9A;">
                        <td style="padding:10px 14px;color:#4A148C;">TOTAL / PROM.</td>
                        <td style="padding:10px 14px;text-align:center;">â€”</td>
                        <td style="padding:10px 14px;text-align:center;">35</td>
                        <td style="padding:10px 14px;text-align:center;color:#1565C0;">${fmtNum(totMachos)}</td>
                        <td style="padding:10px 14px;text-align:center;color:#AD1457;">${fmtNum(totHembras)}</td>
                        <td style="padding:10px 14px;text-align:center;">${fmtNum(totCopula,1)}%</td>
                        <td style="padding:10px 14px;text-align:center;">${fmtNum(totCopuladas)}</td>
                        <td style="padding:10px 14px;text-align:center;">${fmtNum(totMuda,1)}%</td>
                        <td style="padding:10px 14px;text-align:center;color:#E65100;">${fmtNum(totNauplios)}</td>
                        <td style="padding:10px 14px;text-align:center;">${fmtNum(totMort,2)}%</td>
                    </tr>`;
                    html += `</tbody></table></div>`;
                }
            }

            document.getElementById('dashboardContent').innerHTML = html;

            // â”€â”€ CREATE CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            setTimeout(() => {

                // â”€â”€ Colores por sala (hasta 12) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                const MAD_COLORS = ['#5C6BC0','#26A69A','#EF5350','#FF9800','#AB47BC','#1E88E5','#43A047','#F4511E','#8D6E63','#546E7A','#00ACC1','#FFB300'];

                // â”€â”€ Ordenar fechas DD/MM/YYYY o YYYY-MM-DD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                function toISO(s) {
                    s = String(s||'').trim();
                    if (!s) return '';
                    if (s.includes('/')) { const p=s.split('/'); return `${p[2]||''}-${(p[1]||'').padStart(2,'0')}-${(p[0]||'').padStart(2,'0')}`; }
                    return s;
                }
                function sortFechasMad(arr) {
                    return [...arr].sort((a,b)=>toISO(a).localeCompare(toISO(b)));
                }
                function getUniqFechas(data) {
                    return sortFechasMad([...new Set(data.map(r=>r.Fecha||r.fecha||'').filter(Boolean))]);
                }

                // â”€â”€ Tick config adaptativa â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                function xTickMad(n) {
                    if (n <= 7)  return { font:{size:11}, maxRotation:30 };
                    if (n <= 15) return { font:{size:10}, maxRotation:45, maxTicksLimit:n };
                    if (n <= 30) return { font:{size:10}, maxRotation:60, maxTicksLimit:12 };
                    return { font:{size:10}, maxRotation:60, maxTicksLimit:10 };
                }

                // â”€â”€ Pill registry local (sobrevive re-renders) â”€â”€â”€â”€â”€â”€â”€â”€â”€
                const _pmReg = {};

                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // MADURACIÃ“N PILLS â€” multi-selecciÃ³n real
                // Clic individual = toggle ON/OFF
                // "Todos"         = activar todo
                // Botones grupo   = activar/desactivar parejas (â™‚+â™€ por sala)
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                // â”€â”€ PILLS SYSTEM (MaduraciÃ³n) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // Todos = activa todo | clic individual = toggle ON/OFF
                // Sin botones de grupo â€” solo "Todos" + pills individuales

                function _madRefreshStyles(cid) {
                    const reg = _pmReg[cid]; if (!reg) return;
                    const pid = cid + '_pills';
                    document.querySelectorAll(`#${pid} [data-series]`).forEach(btn => {
                        const on  = reg.active.has(btn.dataset.series);
                        const col = (reg.ds.find(d=>d.label===btn.dataset.series)||{}).borderColor || '#999';
                        btn.style.background = on ? col : '#fff';
                        btn.style.color      = on ? '#fff' : col;
                        btn.style.opacity    = on ? '1'   : '0.42';
                        btn.style.fontWeight = on ? '700' : '400';
                    });
                    const todosBtn = document.querySelector(`#${pid} [data-todos]`);
                    if (todosBtn) {
                        const allOn = reg.active.size === reg.ds.length;
                        todosBtn.style.background = allOn ? '#333' : '#fff';
                        todosBtn.style.color      = allOn ? '#fff' : '#333';
                        todosBtn.style.fontWeight = allOn ? '700' : '400';
                    }
                }

                // â”€â”€ DROPDOWN FILTER (MaduraciÃ³n) â€” replaces inline pills â”€â”€â”€
                // Centered above each chart; panel with checkboxes by sala.
                // Closes on outside click; button shows current state.

                function _buildPills(canvasId, datasets) {
                    const el = document.getElementById(canvasId + '_pills');
                    if (!el || datasets.length === 0) return;

                    if (datasets.length === 1) {
                        const col = datasets[0].borderColor || '#666';
                        el.innerHTML = '<div style="display:flex;justify-content:center;padding:4px 0 8px;">' +
                            '<span style="display:inline-block;padding:2px 12px;border-radius:12px;' +
                            'background:'+col+';color:#fff;font-size:10px;font-weight:600;">'+datasets[0].label+'</span></div>';
                        return;
                    }

                    const dd = 'mdd_' + canvasId;
                    let h = '<div style="display:flex;justify-content:center;padding:2px 0 8px;position:relative;">';

                    // Trigger button
                    h += '<button onclick="window._madDropToggle(\'' + dd + '\')" ' +
                         'style="padding:4px 14px 4px 12px;border-radius:20px;' +
                         'border:1.5px solid #bbb;background:#fafafa;color:#444;' +
                         'font-size:11px;font-weight:600;cursor:pointer;' +
                         'display:inline-flex;align-items:center;gap:7px;' +
                         'box-shadow:0 1px 4px rgba(0,0,0,.08);" ' +
                         'onmouseover="this.style.borderColor=&quot;#888&quot;" onmouseout="this.style.borderColor=&quot;#bbb&quot;">' +
                         '<span id="'+dd+'_lbl">Todas las salas</span>' +
                         '<span style="font-size:9px;color:#888;">&#9660;</span></button>';

                    // Panel
                    h += '<div id="'+dd+'" style="display:none;position:absolute;top:calc(100% + 2px);' +
                         'left:50%;transform:translateX(-50%);z-index:9999;' +
                         'background:#fff;border:1.5px solid #ddd;border-radius:10px;' +
                         'padding:8px 10px;box-shadow:0 6px 20px rgba(0,0,0,.13);' +
                         'min-width:200px;max-height:260px;overflow-y:auto;">';

                    // Todas row
                    h += '<div style="display:flex;align-items:center;gap:7px;padding:4px 2px 6px;' +
                         'border-bottom:1px solid #eee;margin-bottom:5px;">' +
                         '<input type="checkbox" id="'+dd+'_all" checked ' +
                         'onchange="window._madDropAll(\'' + canvasId + '\',this.checked)" ' +
                         'style="cursor:pointer;width:14px;height:14px;">' +
                         '<label for="'+dd+'_all" style="cursor:pointer;font-size:11px;font-weight:700;color:#333;">Todas las salas</label></div>';

                    datasets.forEach((ds, i) => {
                        const col = ds.borderColor || MAD_COLORS[i % MAD_COLORS.length];
                        const sid = dd+'_s'+i;
                        const safeAttr = ds.label.replace(/"/g,'&quot;').replace(/'/g,'&#39;');
                        const safeJs   = ds.label.replace(/'/g,'&#39;');
                        h += '<div style="display:flex;align-items:center;gap:7px;padding:4px 2px;">' +
                             '<input type="checkbox" id="'+sid+'" data-series="'+safeAttr+'" checked ' +
                             'onchange="window._madDropSeries(\'' + canvasId + '\',\'' + safeJs + '\',this.checked)" ' +
                             'style="cursor:pointer;width:14px;height:14px;">' +
                             '<label for="'+sid+'" style="cursor:pointer;font-size:11px;display:flex;align-items:center;gap:6px;color:#333;">' +
                             '<span style="display:inline-block;width:11px;height:11px;border-radius:50%;background:'+col+';flex-shrink:0;"></span>' +
                             ds.label+'</label></div>';
                    });
                    h += '</div></div>';
                    el.innerHTML = h;

                    // Register outside-click handler once
                    if (!window._madDropOutside) {
                        window._madDropOutside = true;
                        document.addEventListener('click', function(e) {
                            document.querySelectorAll('[id^="mdd_"][id$="_lbl"]').forEach(function(lbl) {
                                const ddId = lbl.id.replace('_lbl','');
                                const panel = document.getElementById(ddId);
                                if (!panel) return;
                                const wrap = lbl.closest('[style*="position:relative"]');
                                if (wrap && !wrap.contains(e.target)) panel.style.display = 'none';
                            });
                        });
                    }
                }

                function _madUpdateLabel(cid, reg) {
                    const lbl = document.getElementById('mdd_'+cid+'_lbl');
                    if (!lbl) return;
                    const tot = reg.ds.length, act = reg.active.size;
                    lbl.textContent = act===tot ? 'Todas las salas' :
                                      act===1   ? [...reg.active][0] :
                                      act+' de '+tot+' salas';
                }

                window._madDropToggle = function(ddId) {
                    const el = document.getElementById(ddId);
                    if (!el) return;
                    el.style.display = el.style.display==='none' ? 'block' : 'none';
                };

                window._madDropAll = function(cid, checked) {
                    const reg = _pmReg[cid]; if (!reg) return;
                    reg.active = new Set(reg.ds.map(d=>d.label));
                    const dd = 'mdd_'+cid;
                    reg.ds.forEach((_,i) => { const cb=document.getElementById(dd+'_s'+i); if(cb)cb.checked=true; });
                    const allCb=document.getElementById(dd+'_all'); if(allCb)allCb.checked=true;
                    _applyPills(cid);
                    _madUpdateLabel(cid, reg);
                };

                window._madDropSeries = function(cid, label, checked) {
                    const reg = _pmReg[cid]; if (!reg) return;
                    if (checked) {
                        reg.active.add(label);
                    } else {
                        if (reg.active.size <= 1) {
                            // Never deselect the last one â€” restore checkbox
                            const dd='mdd_'+cid;
                            reg.ds.forEach((d,i)=>{ if(d.label===label){ const cb=document.getElementById(dd+'_s'+i); if(cb)cb.checked=true; } });
                            return;
                        }
                        reg.active.delete(label);
                    }
                    const allCb=document.getElementById('mdd_'+cid+'_all');
                    if(allCb) allCb.checked = reg.active.size===reg.ds.length;
                    _applyPills(cid);
                    _madUpdateLabel(cid, reg);
                };

                // _madPillAll/_madPillOne kept as no-ops for compatibility
                window._madPillAll = function(cid) { window._madDropAll(cid, true); };
                window._madPillOne = function(cid, label) {
                    const reg = _pmReg[cid]; if(!reg) return;
                    const on = reg.active.has(label);
                    window._madDropSeries(cid, label, !on);
                };

                function _applyPills(cid) {
                    const reg = _pmReg[cid]; if (!reg) return;
                    const {ch, ds, labels, active} = reg;
                    const activeDS = ds.filter(d => active.has(d.label));

                    // Trim X axis to range with data
                    let fi = labels.length-1, li = 0;
                    activeDS.forEach(d => d.data.forEach((v,i) => {
                        if (v !== null && v !== undefined) { fi=Math.min(fi,i); li=Math.max(li,i); }
                    }));
                    const pad = 1;
                    const f0 = Math.max(0, fi-pad), f1 = Math.min(labels.length-1, li+pad);
                    const trimLabels = labels.slice(f0, f1+1);
                    const trimDS = activeDS.map(d => ({...d, data: d.data.slice(f0, f1+1),
                        pointRadius: trimLabels.length>20?1:trimLabels.length>10?2:3}));

                    ch.data.labels = trimLabels;
                    ch.data.datasets = trimDS;
                    ch.options.scales.x.ticks = xTickMad(trimLabels.length);
                    ch.update('none');
                }

                // â”€â”€ Crear grÃ¡fico de lÃ­nea/barra por sala con pills â”€â”€â”€
                function madLineChart(canvasId, data, seriesList, keyFn, yLabel, isBar) {
                    const el = document.getElementById(canvasId);
                    if (!el) return;
                    const fechas = getUniqFechas(data);
                    const n = fechas.length;
                    const pr = n>20?1:n>10?2:3;

                    const datasets = seriesList.map((serie, i) => {
                        const col = MAD_COLORS[i % MAD_COLORS.length];
                        // seriesList entries are {label, filter}
                        const sData = data.filter(serie.filterFn);
                        const values = fechas.map(f => {
                            const rows = sData.filter(r => (r.Fecha||r.fecha||'') === f);
                            if (!rows.length) return null;
                            const vals = rows.map(r => {
                                const v = parseFloat(r[keyFn] ?? r[keyFn.toLowerCase()] ?? 0);
                                return isNaN(v) ? null : v;
                            }).filter(v => v !== null);
                            if (!vals.length) return null;
                            return isBar
                                ? vals.reduce((s,v)=>s+v,0)
                                : vals.reduce((s,v)=>s+v,0)/vals.length;
                        });
                        return {
                            label: serie.label, _grupo: serie.label, data: values,
                            borderColor: col,
                            backgroundColor: isBar ? col+'CC' : col+'18',
                            fill: !isBar, tension:.35, borderWidth:2.5,
                            pointRadius:Math.max(pr,2), pointHoverRadius:Math.max(pr+3,5),
                            barThickness:'flex', maxBarThickness:35,
                            spanGaps: true
                        };
                    });

                    const ch = new Chart(el, {
                        type: isBar ? 'bar' : 'line',
                        data: { labels: fechas, datasets },
                        options: {
                            responsive:true, maintainAspectRatio:false, animation:{duration:200},
                            plugins: {
                                legend: { display:false },
                                tooltip: {
                                    backgroundColor:'rgba(0,0,0,0.78)',
                                    padding:10,
                                    titleFont:{size:12},
                                    bodyFont:{size:11},
                                    callbacks: { label: ctx => {
                                        const v = ctx.parsed.y;
                                        return ctx.dataset.label + ': ' + (v===null||v===undefined ? 'â€”' : Number(v).toLocaleString('es-EC',{maximumFractionDigits:2}));
                                    }}
                                }
                            },
                            scales: {
                                y: { title:{display:!!yLabel,text:yLabel||'',font:{size:11,weight:'600'},color:'#444'},
                                     ticks:{font:{size:10},maxTicksLimit:6,callback:v=>Number(v).toLocaleString('es-EC',{maximumFractionDigits:2})},
                                     grid:{color:'rgba(0,0,0,0.07)'},
                                     beginAtZero:isBar },
                                x: {
                                    title: { display: true, text: 'Fecha', font: { size: 11, weight: '600' }, color: '#444' },
                                    ticks: xTickMad(n),
                                    grid: { display: false }
                                }
                            },
                            layout:{padding:{top:6,right:12,bottom:6,left:6}}
                        }
                    });
                    allCharts.push(ch);
                    _pmReg[canvasId] = { ch, ds:datasets, labels:fechas, active:new Set(datasets.map(d=>d.label)) };
                    _buildPills(canvasId, datasets);
                }

                // â”€â”€ PoblaciÃ³n apilada Machos+Hembras â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                function madPoblacion(canvasId, data, salas) {
                    const el = document.getElementById(canvasId);
                    if (!el) return;
                    const fechas = getUniqFechas(data);
                    const n = fechas.length;
                    const pr = n>20?1:2;
                    const allDS = [];

                    salas.forEach((sala, i) => {
                        const sd = data.filter(r=>String(r.Sala||r.sala||'').trim()===sala);
                        const colM = '#1E6BD6', colH = '#C62A6E';
                        allDS.push({
                            label:`â™‚ ${sala}`, _grupo:sala, data:fechas.map(f=>{
                                const fr=sd.filter(r=>(r.Fecha||r.fecha||'')===f);
                                const v=fr.reduce((s,r)=>s+(parseFloat(r.N_Machos||0)||0),0);
                                return v||null;
                            }),
                            borderColor:colM, backgroundColor:'rgba(30,107,214,0.25)',
                            fill:true, tension:.35, borderWidth:2.5, pointRadius:Math.max(pr,2), spanGaps:true
                        });
                        allDS.push({
                            label:`â™€ ${sala}`, _grupo:sala, data:fechas.map(f=>{
                                const fr=sd.filter(r=>(r.Fecha||r.fecha||'')===f);
                                const v=fr.reduce((s,r)=>s+(parseFloat(r.N_Hembras||0)||0),0);
                                return v||null;
                            }),
                            borderColor:colH, backgroundColor:'rgba(198,42,110,0.15)',
                            fill:true, tension:.35, borderWidth:2.5, pointRadius:Math.max(pr,2), spanGaps:true
                        });
                    });

                    const ch = new Chart(el, {
                        type:'line', data:{ labels:fechas, datasets:allDS },
                        options:{
                            responsive:true, maintainAspectRatio:false, animation:{duration:200},
                            plugins:{ legend:{display:false},
                                tooltip:{
                                    backgroundColor:'rgba(0,0,0,0.78)',
                                    padding:10,
                                    titleFont:{size:12},
                                    bodyFont:{size:11},
                                    callbacks:{label:ctx=>{
                                        const v=ctx.parsed.y; return ctx.dataset.label+': '+(v?v.toLocaleString():'â€”');
                                    }}
                                }
                            },
                            scales:{
                                y:{
                                    title:{display:true, text:'Individuos', font:{size:11,weight:'600'}, color:'#444'},
                                    ticks:{font:{size:10}, maxTicksLimit:6, callback:v=>v.toLocaleString()},
                                    grid:{color:'rgba(0,0,0,0.07)'}
                                },
                                x:{
                                    title:{display:true, text:'Fecha', font:{size:11,weight:'600'}, color:'#444'},
                                    ticks:xTickMad(n),
                                    grid:{display:false}
                                }
                            },
                            layout:{padding:{top:6,right:12,bottom:6,left:6}}
                        }
                    });
                    allCharts.push(ch);
                    _pmReg[canvasId]={ch,ds:allDS,labels:fechas,active:new Set(allDS.map(d=>d.label))};
                    _buildPills(canvasId, allDS);
                }

                // â”€â”€ Construir series por sala â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                function salaSeries(salas) {
                    return salas.map(sala => ({
                        label: sala,
                        filterFn: r => String(r.Sala||r.sala||'').trim() === sala
                    }));
                }

                // â”€â”€ FASE 1: CUARENTENA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                if (showCuarentena && cuarentenaData.length > 0) {
                    const cqSeries = salaSeries(salas);
                    madLineChart('cq_temp',          cuarentenaData, cqSeries, 'Temperatura_C',      'Â°C',   false);
                    madLineChart('cq_oxigeno',       cuarentenaData, cqSeries, 'Oxigeno_mgL',        'mg/L', false);
                    // Mortalidad separada por sexo (columnas: Mortalidad_Machos_% y Mortalidad_Hembras_%)
                    // Fallback a Mortalidad_% si no existen columnas separadas
                    const hasMortSex = cuarentenaData.some(r => r['Mortalidad_Machos_%'] !== undefined || r.Mortalidad_Machos_pct !== undefined);
                    if (hasMortSex) {
                        madLineChart('cq_mort_machos',   cuarentenaData, cqSeries, 'Mortalidad_Machos_%',  '%', false);
                        madLineChart('cq_mort_hembras',  cuarentenaData, cqSeries, 'Mortalidad_Hembras_%', '%', false);
                    } else {
                        // Si no hay columnas separadas, usar Mortalidad_% para ambos con nota
                        madLineChart('cq_mort_machos',   cuarentenaData, cqSeries, 'Mortalidad_%', '%', false);
                        madLineChart('cq_mort_hembras',  cuarentenaData, cqSeries, 'Mortalidad_%', '%', false);
                    }
                }

                // â”€â”€ FASE 2: PRODUCCIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                if (showProduccion && produccionData.length > 0) {
                    const prSeries = salaSeries(salas);
                    madLineChart('prod_copula',     produccionData, prSeries, 'Tasa_Copula_%', '%',       false);
                    madLineChart('prod_muda',        produccionData, prSeries, 'Pct_Muda',      '%',       false);
                    madLineChart('prod_nauplios',    produccionData, prSeries, 'Total_Nauplios','Nauplios',true);
                    madLineChart('prod_mortalidad',  produccionData, prSeries, 'Mortalidad_%',  '%',       false);
                    madPoblacion('prod_poblacion',   produccionData, salas);
                    madLineChart('prod_copuladas',   produccionData, prSeries, 'Copuladas',     'Copuladas',true);
                    // Mortalidad por sexo en ProducciÃ³n
                    const hasProdMortSex = produccionData.some(r => r['Mortalidad_Machos_%'] !== undefined || r.Mortalidad_Machos_pct !== undefined);
                    if (hasProdMortSex) {
                        madLineChart('prod_mort_machos',  produccionData, prSeries, 'Mortalidad_Machos_%',  '%', false);
                        madLineChart('prod_mort_hembras', produccionData, prSeries, 'Mortalidad_Hembras_%', '%', false);
                    } else {
                        madLineChart('prod_mort_machos',  produccionData, prSeries, 'Mortalidad_%', '%', false);
                        madLineChart('prod_mort_hembras', produccionData, prSeries, 'Mortalidad_%', '%', false);
                    }
                }

            }, 200);
        }



        // â”€â”€â”€ MorfologÃ­a paginada: un mÃ³dulo a la vez, botones Anterior / Siguiente â”€â”€â”€
        function renderMorfologiaView(data) {
            destroyAllCharts();
            window._morfCurrentIdx = 0;  // always start from page 1

            data = data.filter(row => tieneModuloValido(row) && tieneCorridaValida(row));

            // Group by modulo
            const modulosData = {};
            data.forEach(row => {
                const mod = String(row.MÃ³dulo || row.Modulo || row.mÃ³dulo || row.modulo || '').trim();
                if (mod) {
                    if (!modulosData[mod]) modulosData[mod] = [];
                    modulosData[mod].push(row);
                }
            });

            const modKeys = Object.keys(modulosData).sort();

            if (modKeys.length === 0) {
                document.getElementById('dashboardContent').innerHTML =
                    '<div style="text-align:center;padding:60px;color:#999;font-size:15px;">Sin datos de morfologÃ­a para los filtros seleccionados.</div>';
                return;
            }

            // Clamp current index
            window._morfCurrentIdx = Math.max(0, Math.min(window._morfCurrentIdx, modKeys.length - 1));

            // Store for pagination buttons
            window._morfModulosData = modulosData;
            window._morfModKeys     = modKeys;

            _renderMorfPage(window._morfCurrentIdx);
        }

        function _renderMorfPage(idx) {
            destroyAllCharts();
            const modKeys     = window._morfModKeys;
            const modulosData = window._morfModulosData;
            window._morfCurrentIdx = idx;

            const modulo     = modKeys[idx];
            const moduloData = modulosData[modulo];
            const estadio    = getMostFrequentStage(moduloData);
            const total      = modKeys.length;

            // â”€â”€ Build HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            let html = '<div class="morfologia-section">';

            // Header: title + pager
            html += `<div class="morfologia-title" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;">
                <span>ğŸ”¬ MorfologÃ­a General - AnÃ¡lisis de Calidad de Larvas</span>
                <div style="display:flex;align-items:center;gap:8px;font-size:13px;font-weight:400;">
                    <button onclick="_morfNav(-1)"
                        style="padding:5px 14px;border-radius:20px;border:1.5px solid #9E9E9E;background:${idx===0?'#eee':'white'};
                               color:${idx===0?'#bbb':'#444'};cursor:${idx===0?'default':'pointer'};font-size:13px;transition:all .15s;"
                        ${idx===0?'disabled':''}>â† Anterior</button>
                    <span style="color:#666;white-space:nowrap;">${idx+1} / ${total}</span>
                    <button onclick="_morfNav(1)"
                        style="padding:5px 14px;border-radius:20px;border:1.5px solid #9E9E9E;background:${idx===total-1?'#eee':'white'};
                               color:${idx===total-1?'#bbb':'#444'};cursor:${idx===total-1?'default':'pointer'};font-size:13px;transition:all .15s;"
                        ${idx===total-1?'disabled':''}>Siguiente â†’</button>
                </div>
            </div>`;

            // Module tabs (quick jump) â€” show up to 8, then truncate
            if (total > 1) {
                const maxTabs = 10;
                html += `<div style="display:flex;flex-wrap:wrap;gap:5px;margin:10px 0 16px;">`;
                modKeys.slice(0, maxTabs).forEach((mk, i) => {
                    const active = i === idx;
                    html += `<button onclick="_morfNav(${i - idx})"
                        style="padding:4px 12px;border-radius:14px;border:1.5px solid #5C6BC0;font-size:11px;cursor:pointer;
                               background:${active?'#5C6BC0':'white'};color:${active?'white':'#5C6BC0'};font-weight:${active?'700':'400'};
                               transition:all .15s;">${mk}</button>`;
                });
                if (total > maxTabs) {
                    html += `<span style="font-size:11px;color:#999;align-self:center;">+${total-maxTabs} mÃ¡s</span>`;
                }
                html += `</div>`;
            }

            // Module section heading
            html += `<div class="section-title">ğŸ¦ ${modulo} â€” EstadÃ­o: ${estadio}</div>`;

            // Cards helper
            const card = (id, title, ref) =>
                `<div class="morfologia-card">
                    <div class="morfologia-card-title">${title}<span class="morfologia-reference">${ref}</span></div>
                    <canvas id="${id}_${modulo}"></canvas>
                </div>`;

            html += '<div class="corrida-section-title">ğŸ”¬ AnÃ¡lisis de Intestino</div>';
            html += '<div class="morfologia-grid">';
            html += card('intestino_lleno',     '% Lleno',     'â‰¥ 90%');
            html += card('intestino_semilleno', '% Semilleno', '< 10%');
            html += card('intestino_vacio',     '% VacÃ­o',     '< 10%');
            html += '</div>';

            html += '<div class="corrida-section-title">ğŸ“Š ParÃ¡metros Generales</div>';
            html += '<div class="morfologia-grid">';
            html += card('deformidad', '% Deformidad', '< 5%');
            html += card('retraso',    '% Retraso',    '< 50%');
            html += card('hongos',     '% Hongos',     'Ausencia');
            html += '</div>';

            html += '<div class="corrida-section-title">ğŸ¦ AnÃ¡lisis Postlarva</div>';
            html += '<div class="morfologia-grid">';
            html += card('lipidos',    '% LÃ­pidos',   '> 95%');
            html += card('flacidez',   '% FlÃ¡cidez',  '< 3%');
            html += card('necrosis',   '% Necrosis',  '< 3%');
            html += card('canibalismo','% Canibalismo','< 3%');
            html += card('parasitos',  '% ParÃ¡sitos', '< 4%');
            html += '</div>';

            html += '<div class="corrida-section-title">ğŸ“¦ ParÃ¡metros de Cosecha</div>';
            html += '<div class="morfologia-grid">';
            html += card('cosecha', '% Cosecha', 'â‰¥ 90%');
            html += card('plg',     'Plg',        '< 200');
            html += card('talla',   'Talla (mm)', '-');
            html += card('estres',  '% EstrÃ©s',  '-');
            html += '</div>';

            // Bottom navigation
            html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-top:20px;padding:14px 0;border-top:1px solid #eee;">
                <button onclick="_morfNav(-1)"
                    style="padding:8px 22px;border-radius:20px;border:1.5px solid #9E9E9E;background:${idx===0?'#f5f5f5':'#5C6BC0'};
                           color:${idx===0?'#bbb':'white'};cursor:${idx===0?'default':'pointer'};font-size:13px;font-weight:600;transition:all .15s;"
                    ${idx===0?'disabled':''}>â† ${idx>0?modKeys[idx-1]:'Anterior'}</button>
                <span style="color:#888;font-size:12px;">MÃ³dulo ${idx+1} de ${total}</span>
                <button onclick="_morfNav(1)"
                    style="padding:8px 22px;border-radius:20px;border:1.5px solid #9E9E9E;background:${idx===total-1?'#f5f5f5':'#5C6BC0'};
                           color:${idx===total-1?'#bbb':'white'};cursor:${idx===total-1?'default':'pointer'};font-size:13px;font-weight:600;transition:all .15s;"
                    ${idx===total-1?'disabled':''}>  ${idx<total-1?modKeys[idx+1]:'Siguiente'} â†’</button>
            </div>`;

            html += '</div>';

            document.getElementById('dashboardContent').innerHTML = html;

            // Render charts for this module only
            setTimeout(() => createMorfologiaCharts(modulo, moduloData), 50);
        }

        window._morfNav = function(delta) {
            const newIdx = Math.max(0, Math.min(window._morfCurrentIdx + delta, window._morfModKeys.length - 1));
            if (newIdx !== window._morfCurrentIdx) {
                _renderMorfPage(newIdx);
            }
        };

        function createMorfologiaCharts(modulo, data) {
            // Ordenar por fecha
            const sortedData = data.sort((a, b) => {
                const dateA = parseDateString(a.Fecha || a.fecha);
                const dateB = parseDateString(b.Fecha || b.fecha);
                return dateA - dateB;
            });

            const fechas = [...new Set(sortedData.map(row => row.Fecha || row.fecha))];

            // INTESTINO - Paleta de verdes/turquesas
            createMorfChartStacked(`intestino_lleno_${modulo}`, fechas, sortedData, modulo);
            
            createMorfChart(`intestino_semilleno_${modulo}`, fechas, sortedData, 
                ['Intestino_Semilleno', 'IntestinoSemilleno', 'intestino_semilleno'], 
                '#FFA726', 0, 15, 'bar', false); // Naranja
            
            createMorfChart(`intestino_vacio_${modulo}`, fechas, sortedData, 
                ['Intestino_Vacio', 'IntestinoVacio', 'intestino_vacio', 'Intestino_VacÃ­o'], 
                '#EF5350', 0, 15, 'bar', false); // Rojo

            // GENERALES - Paleta de rojos/naranjas (SIN MORTALIDAD)
            createMorfChart(`deformidad_${modulo}`, fechas, sortedData, 
                ['Deformidad', 'deformidad'], 
                '#E53935', 0, 8, 'bar', false); // Rojo oscuro
            
            createMorfChart(`retraso_${modulo}`, fechas, sortedData, 
                ['Retraso', 'retraso'], 
                '#FB8C00', 0, 60, 'line', false); // Naranja oscuro
            
            createMorfChart(`hongos_${modulo}`, fechas, sortedData, 
                ['Hongos', 'hongos'], 
                '#D32F2F', 0, 8, 'bar', false); // Rojo profundo

            // POSTLARVA - Paleta variada
            createMorfChart(`lipidos_${modulo}`, fechas, sortedData, 
                ['LÃ­pidos', 'Lipidos', 'lÃ­pidos', 'lipidos'], 
                '#66BB6A', 90, 100, 'line', false); // Verde
            
            createMorfChart(`flacidez_${modulo}`, fechas, sortedData, 
                ['FlÃ¡cidez', 'Flacidez', 'flÃ¡cidez', 'flacidez'], 
                '#EF5350', 0, 5, 'bar', false); // Rojo
            
            createMorfChart(`necrosis_${modulo}`, fechas, sortedData, 
                ['Necrosis', 'necrosis'], 
                '#EC407A', 0, 5, 'bar', false); // Rosa
            
            createMorfChart(`canibalismo_${modulo}`, fechas, sortedData, 
                ['Canibalismo', 'canibalismo'], 
                '#AB47BC', 0, 5, 'bar', false); // Morado
            
            createMorfChart(`parasitos_${modulo}`, fechas, sortedData, 
                ['ParÃ¡sitos', 'Parasitos', 'parÃ¡sitos', 'parasitos'], 
                '#FF7043', 0, 6, 'bar', false); // Coral

            // COSECHA - Paleta de azules/verdes
            createMorfChart(`cosecha_${modulo}`, fechas, sortedData, 
                ['Cosecha', 'cosecha'], 
                '#26A69A', 85, 100, 'line', false); // Turquesa
            
            createMorfChart(`plg_${modulo}`, fechas, sortedData, 
                ['Plg', 'PLG', 'plg'], 
                '#42A5F5', null, 250, 'line', false); // Azul
            
            createMorfChart(`talla_${modulo}`, fechas, sortedData, 
                ['Talla', 'talla'], 
                '#5C6BC0', null, null, 'line', false); // Ãndigo
            
            createMorfChart(`estres_${modulo}`, fechas, sortedData, 
                ['EstrÃ©s', 'Estres', 'estrÃ©s', 'estres'], 
                '#FFA726', 0, 15, 'bar', false); // Naranja
        }

        function createMorfChartStacked(canvasId, labels, data, modulo) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            const lleno = labels.map(fecha => {
                const dataFecha = data.filter(row => (row.Fecha || row.fecha) === fecha);
                return calculateAverage(dataFecha, ['Intestino_Lleno', 'IntestinoLleno', 'intestino_lleno']);
            });

            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '',
                        data: lleno,
                        backgroundColor: 'rgba(38, 166, 154, 0.3)',
                        borderColor: 'rgba(38, 166, 154, 1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 80,
                            max: 100,
                            ticks: {
                                font: { size: 8 },
                                stepSize: 5,
                                callback: function(value) { return Math.round(value) + '%'; }
                            },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        x: {
                            ticks: {
                                font: { size: 10 },
                                maxRotation: 45,
                                minRotation: 45,
                                padding: 2
                            },
                            grid: { display: false }
                        }
                    },
                    layout: {
                        padding: {
                            bottom: 25,
                            left: 5,
                            right: 10,
                            top: 5
                        }
                    }
                }
            });

            allCharts.push(chart);
        }

        // ===== FUNCIONES FALTANTES =====

        function calculateAverage(data, possibleKeys) {
            let sum = 0;
            let count = 0;
            data.forEach(row => {
                for (let key of possibleKeys) {
                    if (row[key] !== undefined && row[key] !== null && row[key] !== '') {
                        const value = parseFloat(row[key]);
                        if (!isNaN(value)) {
                            sum += value;
                            count++;
                        }
                        break;
                    }
                }
            });
            return count > 0 ? sum / count : 0;
        }

        function destroyAllCharts() {
            allCharts.forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    try { chart.destroy(); } catch(e) {}
                }
            });
            allCharts = [];
            // Destruir charts por canvas (seguridad extra)
            document.querySelectorAll('canvas').forEach(canvas => {
                try {
                    const ch = Chart.getChart(canvas);
                    if (ch) ch.destroy();
                } catch(e) {}
            });
        }

        function createChartByTank(canvasId, type, labels, data, label, bgColor, borderColor, maxY = null, yAxisTitle = '', xAxisLabel = 'Tanque') {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            // Destruir chart anterior si existe en este canvas
            const existingChart = Chart.getChart(ctx);
            if (existingChart) {
                try { existingChart.destroy(); } catch(e) {}
            }

            const validData = data.filter(d => d !== null && d !== undefined && !isNaN(d));
            let minY = 0;
            let calculatedMaxY = maxY;

            if (validData.length > 0 && !maxY) {
                const dataMax = Math.max(...validData);
                const dataMin = Math.min(...validData);
                const range = dataMax - dataMin;
                const margin = Math.max(range * 0.15, dataMax * 0.05);
                calculatedMaxY = dataMax + margin;
                calculatedMaxY = Math.ceil(calculatedMaxY * 10) / 10;
            }

            const chartConfig = {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: bgColor,
                        borderColor: borderColor,
                        borderWidth: type === 'line' ? 3 : 1,
                        fill: type === 'line' ? false : true,
                        tension: 0.4,
                        barThickness: 'flex',
                        maxBarThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.75)',
                            padding: 10,
                            titleFont: { size: 12 },
                            bodyFont: { size: 11 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: calculatedMaxY,
                            title: { display: !!(yAxisTitle||label), text: yAxisTitle||label, font: { size: 11, weight: '600' }, color: '#444' },
                            ticks: { font: { size: 10 }, maxTicksLimit: 6 },
                            grid: { color: 'rgba(0,0,0,0.07)' }
                        },
                        x: {
                            title: { display: true, text: xAxisLabel, font: { size: 11, weight: '600' }, color: '#444' },
                            ticks: { font: { size: 10 }, maxRotation: 45, minRotation: 0, maxTicksLimit: 12 },
                            grid: { display: false }
                        }
                    },
                    layout: { padding: { top: 4, right: 8, bottom: 4, left: 4 } }
                }
            };

            const chart = new Chart(ctx, chartConfig);
            allCharts.push(chart);
            return chart;
        }

        // ===== FIN FUNCIONES FALTANTES =====

        function createMorfChart(canvasId, labels, data, possibleKeys, color, minRef, maxRef, chartType = 'line', showLegend = false) {
            const values = labels.map(fecha => {
                const dataFecha = data.filter(row => (row.Fecha || row.fecha) === fecha);
                return calculateAverage(dataFecha, possibleKeys);
            });

            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            // Determinar rango dinÃ¡mico
            const validData = values.filter(v => v > 0);
            let minY = minRef !== null ? minRef : 0;
            let maxY = maxRef;

            if (validData.length > 0 && maxRef === null) {
                const dataMax = Math.max(...validData);
                const dataMin = Math.min(...validData);
                const range = dataMax - dataMin;
                
                minY = Math.max(0, dataMin - (range * 0.15));
                maxY = dataMax + (range * 0.15);
                
                minY = Math.floor(minY * 10) / 10;
                maxY = Math.ceil(maxY * 10) / 10;
            }

            const isBar = chartType === 'bar';
            const range = maxY - minY;
            let stepSize = range <= 5 ? 0.5 : range <= 10 ? 1 : range <= 20 ? 2 : range <= 50 ? 5 : 10;

            const chart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: '',
                        data: values,
                        backgroundColor: isBar ? color : `${color}30`,
                        borderColor: color,
                        borderWidth: isBar ? 0 : 3,
                        fill: !isBar,
                        tension: 0.3,
                        barThickness: 'flex',
                        maxBarThickness: 25,
                        pointRadius: isBar ? 0 : 3,
                        pointHoverRadius: isBar ? 0 : 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 10,
                            callbacks: {
                                label: function(context) {
                                    let val = context.parsed.y;
                                    return (minRef === 0 && maxRef !== null && maxRef <= 100) ? val.toFixed(1) + '%' : val.toFixed(1);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: minRef === 0,
                            min: minY,
                            max: maxY,
                            ticks: {
                                font: { size: 8 },
                                stepSize: stepSize,
                                callback: function(value) {
                                    return (minRef === 0 && maxRef !== null && maxRef <= 100) ? Math.round(value) + '%' : value.toFixed(1);
                                }
                            },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        x: {
                            ticks: {
                                font: { size: 10 },
                                maxRotation: 45,
                                minRotation: 45,
                                padding: 2
                            },
                            grid: { display: false }
                        }
                    },
                    layout: {
                        padding: {
                            bottom: 25,
                            left: 5,
                            right: 10,
                            top: 5
                        }
                    }
                }
            });

            allCharts.push(chart);
        }

    </script>
</body>
</html>